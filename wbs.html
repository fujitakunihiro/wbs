<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å·¥æ•°ç®¡ç†</title>
    <style>
        :root {
            --border: #bcbcbc;
            --header-bg: #f2f2f2;
            --excel-blue: #2f5597;
            --excel-group-bg: #d9d9d9;
            --range-blue: #eaf4ff; 
            --work-blue: #5b9bd5;  
            --today-bg: #fff9c4;    
            --today-col-bg: rgba(255, 249, 196, 0.3);
            --today-line: #ff0000;  
            --row-h: 34px;
            --day-w: 55px; 
            --wbs-w: 1200px; 
            
            /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”¨è‰²å®šç¾© */
            --overload-bg: #ffdddd; 
            --overload-col: #cc0000; 
            
            /* ç¥æ—¥ç”¨ */
            --holiday-col: #ffebec;
            --holiday-text: #dc3545;
        }

        * { box-sizing: border-box; }
        body { font-family: "Meiryo", "MS PGothic", sans-serif; margin: 15px; font-size: 12px; background: #f9f9f9; color: #333; overflow: hidden; }
        
        .controls { margin-bottom: 10px; display: flex; gap: 8px; align-items: center; white-space: nowrap; flex-wrap: nowrap; }
        button { padding: 5px 15px; cursor: pointer; border: 1px solid #999; background: #fff; border-radius: 2px; font-size: 12px; }
        button.primary { background: var(--excel-blue); color: white; border: none; }
        button:hover { background-color: #f0f0f0; }

        .usage-guide {
            margin-left: auto;
            display: flex;
            gap: 15px;
            padding: 5px 12px;
            background: #eee;
            border-radius: 4px;
            color: #555;
            font-size: 11px;
            border: 1px solid #ddd;
        }
        .guide-item { display: flex; align-items: center; gap: 4px; }
        .guide-icon { font-size: 14px; }

        .main-container {
            display: flex;
            border: 2px solid #888;
            background: #fff;
            overflow: hidden;
            height: calc(100vh - 80px);
        }

        .wbs-area {
            width: var(--wbs-w);
            flex-shrink: 0;
            border-right: 2px solid #444; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff;
            z-index: 10;
        }

        #wbs-body-container { overflow: hidden; flex-grow: 1; }
        
        #wbs-body { padding-bottom: 20px; }

        .gantt-area {
            flex-grow: 1;
            overflow: auto;
            position: relative;
            background: #fff;
            margin-left: -2px; 
        }

        .row { display: flex; width: 100%; }
        
        .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            height: var(--row-h);
            display: flex;
            align-items: center;
            padding: 0 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: #fff;
        }

        .header { 
            position: sticky; 
            top: 0; 
            z-index: 40; 
            background: var(--header-bg); 
            box-shadow: 0 1px 0 #888; 
        }
        .header .cell { 
            background: var(--header-bg); 
            justify-content: center; 
            border-bottom: 1px solid #888;
        }

        .header .col-owner, 
        .header .col-date,
        .header .col-progress { overflow: visible !important; position: relative; } 

        /* åˆ—å¹…ã®å®šç¾© */
        .col-no { width: 45px; justify-content: center !important; background: #f0f0f0 !important; font-weight: bold; }
        .col-title { width: 220px; }
        .col-owner { width: 90px; } 
        .col-date { width: 135px; } 

        .col-h { width: 75px; justify-content: center; padding-right: 2px; }
        .col-ratio { width: 55px; justify-content: center; font-size: 11px; }
        .col-progress { width: 75px; justify-content: center; }
        .col-op { width: 220px; justify-content: flex-start; border-right: none !important; gap: 4px; padding: 0 8px; }

        .day-cell { width: var(--day-w); justify-content: center; padding: 0 !important; position: relative; } 
        .is-today-h { background: var(--today-bg) !important; color: #d97706 !important; font-weight: bold; border-bottom: 1px solid #888 !important; }
        .is-today-col { background-color: var(--today-col-bg) !important; }

        .group-row .cell { background: var(--excel-group-bg) !important; font-weight: bold; }
        .in-range { background: var(--range-blue) !important; }
        
        .sat { color: #007bff; }
        .sun { color: #dc3545; }
        .holiday { color: var(--holiday-text); background-color: var(--holiday-col); }

        .today-line {
            position: absolute; top: 0; bottom: 0; 
            width: 2px;
            background: var(--today-line); 
            z-index: 5; 
            pointer-events: none;
            opacity: 0.6;
        }

        input { width: 100%; border: none; outline: none; background: transparent; font-size: 12px; font-family: inherit; }
        input[type="number"] { text-align: center; }

        .date-display-text { font-size: 12px; padding-left: 2px; color: #333; cursor: default; white-space: nowrap; }
        .date-input { cursor: pointer; text-align: left; width: 100%; }
        
        .hour-input { height: 100%; font-size: 11px; padding-right: 2px !important; width: 100%; color: inherit; cursor: pointer; z-index: 2; position: relative; }

        .icon-btn {
            width: 26px; height: 26px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 4px; border: 1px solid #ccc; transition: all 0.2s; background: #fff; padding: 0; flex-shrink: 0;
        }
        .icon-btn svg { width: 16px; height: 16px; fill: #666; }
        .icon-btn:hover { background: #f0f0f0; border-color: #888; }
        .icon-delete:hover { background: #fee2e2; }
        .icon-delete:hover svg { fill: #dc2626; }
        .icon-timer.start { border-color: #16a34a; }
        .icon-timer.start svg { fill: #16a34a; }
        .icon-timer.stop { border-color: #dc2626; background: #fef2f2; }
        .icon-timer.stop svg { fill: #dc2626; }
        .icon-memo.has-content { border-color: #2f5597; background: #eaf4ff; }
        .icon-memo.has-content svg { fill: #2f5597; }
        .icon-shift-left { border-color: #06b6d4; background: #cffafe; font-size: 16px; color: #0891b2; padding: 0 6px; font-weight: 600; }
        .icon-shift-left:hover { background: #a5f3fc; border-color: #0891b2; }
        .icon-shift-right { border-color: #06b6d4; background: #cffafe; font-size: 16px; color: #0891b2; padding: 0 6px; font-weight: 600; }
        .icon-shift-right:hover { background: #a5f3fc; border-color: #0891b2; }

        .tracking-active { background: #fff1f2 !important; }

        .icon-ref {
            font-size: 10px; color: #555; cursor: pointer; 
            width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #ccc; border-radius: 3px; background: #eee; margin-left: 2px;
        }
        .icon-ref:hover { background: #e0f2fe; border-color: var(--work-blue); color: var(--excel-blue); }

        .filter-icon { 
            cursor: pointer; margin-left: 2px; color: #666; font-size: 10px; 
            border: 1px solid #999; border-radius: 3px; padding: 1px 2px; background: #eee; 
            flex-shrink: 0; display: inline-block; line-height: 1; 
        }
        .filter-icon:hover { background: #ddd; }
        .filter-active { background: var(--excel-blue); color: #fff; border-color: var(--excel-blue); }
        
        .filter-menu { 
            position: absolute; top: 100%; left: 0; width: max-content; min-width: 150px; 
            background: #fff; border: 1px solid #999; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); 
            z-index: 1000; display: none; flex-direction: column; padding: 5px; 
            text-align: left; font-weight: normal; max-height: 300px; overflow-y: auto; 
            margin-top: 1px; white-space: nowrap; 
        }
        .col-progress .filter-menu { left: auto; right: 0; } 
        .filter-menu label { display: flex; align-items: center; justify-content: flex-start; gap: 8px; padding: 4px 8px; cursor: pointer; width: 100%; }
        .filter-menu label:hover { background: #f0f0f0; }
        .filter-menu input[type="checkbox"] { margin: 0; width: auto; cursor: pointer; }
        .filter-actions { border-top: 1px solid #ddd; padding-top: 5px; margin-top: 5px; display: flex; justify-content: space-between; }
        .filter-actions button { padding: 3px 8px; font-size: 11px; }

        .date-filter-container { padding: 8px; }
        .date-filter-input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 2px; box-sizing: border-box; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        #memo-modal { z-index: 2000 !important; }
        .modal-content { background: #fff; width: 750px; padding: 25px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-content h3 { margin: 0 0 15px 0; font-size: 16px; color: var(--excel-blue); border-bottom: 2px solid var(--excel-blue); padding-bottom: 8px; }
        .modal-content textarea { width: 100%; height: 350px; margin-bottom: 20px; padding: 12px; font-family: inherit; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; line-height: 1.6; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; }

        /* å®Ÿç¸¾å‚ç…§ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .ref-result-area { height: 180px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; }
        .ref-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .ref-table th { background: #f2f2f2; position: sticky; top: 0; padding: 6px; text-align: left; border-bottom: 1px solid #ccc; }
        .ref-table td { padding: 6px; border-bottom: 1px solid #eee; }
        .ref-table tr:hover { background: #f9f9f9; }
        .ref-summary { display: flex; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; align-items: center; border: 1px solid #ddd; }
        .select-btn { padding: 3px 8px; font-size: 11px; border: 1px solid #999; color: #333; background: #fff; border-radius: 3px; cursor: pointer; }
        .select-btn:hover { background: #eee; }
        .search-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .search-row input { border: 1px solid #ccc; padding: 6px; border-radius: 3px; flex-grow: 1; }
        .search-row select { border: 1px solid #ccc; padding: 6px; border-radius: 3px; min-width: 120px; }
        .ref-adjust-area { background: #fff; padding: 15px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        .adjust-controls { display: flex; align-items: center; gap: 15px; position: relative; height: 40px; }
        .slider-wrapper { position: relative; flex-grow: 1; height: 100%; display: flex; align-items: center; }
        #dist-canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.9; }
        input[type="range"] { width: 100%; margin: 0; position: relative; z-index: 2; cursor: pointer; -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { background: rgba(0,0,0,0.05); height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; background: var(--excel-blue); width: 16px; height: 16px; border-radius: 50%; margin-top: -5px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .adjust-val-box { display: flex; align-items: center; gap: 5px; font-weight: bold; background: #f0f8ff; padding: 5px 10px; border-radius: 4px; border: 1px solid #2f5597; color: #2f5597; z-index: 2; }
        .adjust-val-box input { width: 60px; text-align: right; border: none; font-size: 16px; font-weight: bold; color: #2f5597; outline: none; background: transparent; }
        #dist-info { font-size: 12px; color: #444; background: #f9f9f9; padding: 5px 10px; border-radius: 4px; min-height: 24px; display: flex; align-items: center; border: 1px solid #eee; }
        .dist-highlight { color: #2f5597; font-weight: bold; margin-right: 5px; }
        .ref-checkbox { width: 20px; text-align: center; }
        .ref-checkbox input[type="checkbox"] { width: auto; }
        .ref-table thead tr th:first-child { width: 25px; } 

        .over-limit { background-color: var(--overload-bg) !important; color: var(--overload-col) !important; font-weight: bold; }
        
        /* æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ */
        .status-red { color: #dc2626 !important; font-weight: bold; background-color: #fff0f0; animation: blink-alert 1.2s infinite ease-in-out; }
        .status-yellow { color: #b45309 !important; font-weight: bold; background-color: #fffbeb; }
        @keyframes blink-alert { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .report-table th, .report-table td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
        .report-table th { background: #f2f2f2; font-weight: bold; text-align: center; }
        .report-table .num-cell { text-align: right; }
        .report-over-limit { background-color: var(--overload-bg); color: var(--overload-col); font-weight: bold; }
        .report-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }

        /* ã‚·ãƒ•ãƒˆæ©Ÿèƒ½ç”¨ */
        .settings-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .settings-row label { width: 120px; text-align: right; font-weight: bold; }
        .settings-row input, .settings-row select { border: 1px solid #ccc; padding: 4px; border-radius: 3px; width: 200px; background: #fff; }

    </style>
</head>
<body>

    <div class="controls">
        <h2 style="margin: 0 10px 0 0; font-size: 14px;">å·¥æ•°ç®¡ç†</h2>
        <button class="primary" onclick="addTask()">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
        <button onclick="undo()" id="btn-undo" disabled>ğŸ”™ å…ƒã«æˆ»ã™</button>
        <button onclick="openShiftModal()">â© ã‚·ãƒ•ãƒˆ</button>
        <div style="width: 1px; height: 20px; background: #ccc; margin: 0 5px;"></div>
        <button onclick="downloadJSON()">ğŸ“¥ ä¿å­˜</button>
        <button onclick="document.getElementById('fileIn').click()">ğŸ“¤ èª­è¾¼</button>
        <button onclick="downloadCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
        <button onclick="openReport()">ğŸ“Š æ—¥å ±</button> 
        <button onclick="openAnalyze()">ğŸ“ˆ åˆ†æ</button>
        <input type="file" id="fileIn" style="display:none" accept=".json" onchange="uploadJSON(event)">
        
        <span id="tracker-status" style="margin-left:20px; font-weight:bold; color:#dc2626;"></span>

        <div class="usage-guide">
            <div class="guide-item"><b>ä½¿ã„æ–¹:</b> å³å´ã®æ—¥ä»˜åˆ—ã«æ—¥ã€…ã®å·¥æ•°(h)ã‚’å…¥åŠ›</div>
            <div class="guide-item"><span class="guide-icon">ğŸ“</span>ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</div>
            <div class="guide-item"><span class="guide-icon">ğŸ“„</span>ãƒ¡ãƒ¢</div>
            <div class="guide-item"><span class="guide-icon">â–¶</span>ã‚¿ã‚¤ãƒãƒ¼</div>
            <div class="guide-item"><span class="guide-icon">ğŸ”</span>å®Ÿç¸¾å‚ç…§</div>
            <div class="guide-item" style="color:var(--overload-col); font-weight:bold;">â– éè² è·(>8h)</div>
        </div>
    </div>

    <div class="main-container">
        <div class="wbs-area">
            <div class="header row">
                <div class="cell col-no">No</div>
                <div class="cell col-title">ã‚¿ã‚¹ã‚¯</div>
                <div class="cell col-owner">
                    æ‹…å½“ <span id="filter-btn" class="filter-icon" onclick="toggleFilterMenu(event)">â–¼</span>
                    <div id="filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-date">
                    é–‹å§‹æ—¥ <span id="date-filter-btn" class="filter-icon" onclick="toggleDateFilterMenu(event)">â–¼</span>
                    <div id="date-filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-date">æœŸé™</div>
                <div class="cell col-h">è¦‹ç©(h)</div>
                <div class="cell col-h">åˆè¨ˆ(h)</div>
                <div class="cell col-h">æ®‹ã‚Š(h)</div>
                <div class="cell col-ratio">è¦‹ç©æ¯”</div>
                <div class="cell col-progress">
                    é€²æ— <span id="prog-filter-btn" class="filter-icon" onclick="toggleProgressFilterMenu(event)">â–¼</span>
                    <div id="prog-filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-op">æ“ä½œ</div>
            </div>
            <div id="wbs-body-container">
                <div id="wbs-body"></div>
            </div>
        </div>
        <div class="gantt-area" id="gantt-container">
            <div id="gantt-grid" class="gantt-grid">
                <div id="gantt-header" class="header row"></div>
                <div id="gantt-body" style="position:relative;"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒ¢ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="memo-modal" class="modal-overlay">
        <div class="modal-content" style="width: 650px;">
            <h3 id="memo-title">ãƒ¡ãƒ¢</h3>
            <textarea id="memo-text" placeholder="è©³ç´°ãªãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            <div class="modal-btns">
                <button onclick="closeMemo()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="btn-save-memo" class="primary" onclick="saveMemo()">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- å®Ÿç¸¾å‚ç…§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ref-modal" class="modal-overlay">
        <div class="modal-content" style="width: 750px;">
            <h3>éå»å®Ÿç¸¾ã®å‚ç…§</h3>
            <div class="search-row">
                <input type="text" id="ref-search-key" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ANDæ¤œç´¢)..." oninput="searchRef()">
                <select id="ref-search-owner" onchange="searchRef()">
                    <option value="">(å…¨æ‹…å½“è€…)</option>
                </select>
                <select id="ref-search-status" onchange="searchRef()">
                    <option value="">(å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)</option>
                    <option value="complete">å®Œäº†ã®ã¿ (100%)</option>
                    <option value="incomplete">æœªå®Œäº†ã®ã¿</option>
                </select>
            </div>
            
            <div class="ref-summary" id="ref-summary-area" style="display:none;">
                <span><b>çµæœ:</b> <span id="ref-count">0</span>ä»¶</span> | 
                <span>å¹³å‡: <b id="ref-avg">0.0</b>h</span> <button class="select-btn" onclick="selectRefVal('avg')">å¹³å‡ã‚’é¸æŠ</button> |
                <span>æœ€å¤§: <b id="ref-max">0.0</b>h</span> <button class="select-btn" onclick="selectRefVal('max')">æœ€å¤§ã‚’é¸æŠ</button>
            </div>

            <div class="ref-result-area">
                <table class="ref-table">
                    <thead>
                        <tr>
                            <th style="width:25px;"><input type="checkbox" id="select-all-ref" onchange="toggleSelectAll(this.checked)"></th>
                            <th style="width:130px;">è¦ªã‚¿ã‚¹ã‚¯</th>
                            <th>ã‚¿ã‚¹ã‚¯å</th>
                            <th style="width:50px; text-align:center;">ãƒ¡ãƒ¢</th>
                            <th style="width:70px;">æ‹…å½“</th>
                            <th style="width:50px;">å®Ÿç¸¾</th>
                            <th style="width:40px;">é€²æ—</th>
                            <th style="width:60px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="ref-table-body"></tbody>
                </table>
            </div>

            <div class="ref-adjust-area">
                <div style="font-weight:bold; font-size:12px; color:#2f5597; margin-bottom:0px;">
                    â–¼ è¦‹ç©å·¥æ•°ã®èª¿æ•´ãƒ»æ±ºå®š (èƒŒæ™¯åˆ†å¸ƒ: <span style="color:rgba(47, 85, 151, 0.6)">â– å®Ÿç¸¾æ•°</span> <span style="color:red; font-weight:bold;">: å¹³å‡</span>)
                </div>
                <div class="adjust-controls">
                    <div class="adjust-val-box">
                        <input type="number" id="adjust-num" value="0" min="0" step="0.1" oninput="syncSlider(this.value)"> h
                    </div>
                    <div class="slider-wrapper" id="slider-wrapper">
                        <canvas id="dist-canvas"></canvas>
                        <input type="range" id="adjust-slider" min="0" max="20" step="0.1" value="0" oninput="syncNum(this.value)">
                    </div>
                    <button class="primary" onclick="applyRefAdjusted()">æ±ºå®š</button>
                </div>
                <div id="dist-info">â†‘ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã™ã¨ã€ãã®å€¤ã«è¿‘ã„éå»å®Ÿç¸¾ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>

            <div class="modal-btns">
                <button onclick="closeRef()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="shift-modal" class="modal-overlay">
        <div class="modal-content" style="width: 450px;">
            <h3>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€æ‹¬ã‚·ãƒ•ãƒˆ (å–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹)</h3>
            <p style="margin-bottom:15px; font-size:11px; color:#555;">é¸æŠã—ãŸè¦ªã‚¿ã‚¹ã‚¯é…ä¸‹ã®ã€Œæœªå®Œäº†ã‚¿ã‚¹ã‚¯ã€ã®æ—¥ä»˜ã‚’ã€<br>åœŸæ—¥ç¥æ—¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚·ãƒ•ãƒˆã—ã¾ã™ã€‚</p>
            <div class="settings-row">
                <label>è¦ªã‚¿ã‚¹ã‚¯(å¯¾è±¡):</label>
                <select id="shift-target-group"></select>
            </div>
            <div class="settings-row">
                <label>ã‚·ãƒ•ãƒˆæ—¥æ•°:</label>
                <input type="number" id="shift-days" value="0" placeholder="ä¾‹: 7 (1é€±é–“) ã¾ãŸã¯ -1">
            </div>
            <div class="modal-btns">
                <button onclick="document.getElementById('shift-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="primary" onclick="applyShift()">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div id="analyze-modal" class="modal-overlay">
        <div class="modal-content" style="width: 950px; height: 95%; display:flex; flex-direction:column; overflow:hidden;">
            <h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
            <div style="display:flex; gap:15px; align-items:center; background:#f0f0f0; padding:10px; margin-bottom:10px;">
                <label>æœŸé–“: <input type="date" id="ana-start" onchange="renderCharts()"> ï½ <input type="date" id="ana-end" onchange="renderCharts()"></label>
                <label>åˆ†æå¯¾è±¡: <select id="ana-target" onchange="renderCharts()"><option value="">(å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)</option></select></label>
            </div>
            <div style="flex-grow: 1; overflow-y: auto; padding: 10px; background:#f5f5f5;">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4>äºˆå®Ÿæ¯”è¼ƒ (h)</h4>
                        <div id="chart-compare-container" style="overflow-x:auto;"><canvas id="chart-bar-compare"></canvas></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4>æ‹…å½“è€…åˆ¥ å†…è¨³ (h)</h4>
                        <canvas id="chart-pie-owner" style="height: 250px; width:100%;"></canvas>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4>æ—¥åˆ¥æ¨ç§» (h)</h4>
                        <canvas id="chart-bar-daily" style="height: 300px; width:100%;"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-btns"><button onclick="document.getElementById('analyze-modal').style.display='none'">é–‰ã˜ã‚‹</button></div>
        </div>
    </div>
    
    <!-- æ—¥å ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="report-modal" class="modal-overlay">
        <div class="modal-content" style="width: 800px; height: 80%; display:flex; flex-direction:column;">
            <h3>æ‹…å½“è€…åˆ¥ãƒ»æ—¥æ¬¡å®Ÿç¸¾é›†è¨ˆ</h3>
            <div class="report-controls">
                <label>å¯¾è±¡æœˆ: <input type="month" id="report-month" onchange="renderReportContent()"></label>
                <button onclick="copyReportToClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div style="flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="width:100px;">æ—¥ä»˜</th>
                            <th style="width:100px;">æ‹…å½“è€…</th>
                            <th>ã‚¿ã‚¹ã‚¯å†…è¨³</th>
                            <th style="width:60px;">åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="report-body"></tbody>
                </table>
            </div>
            <div class="modal-btns" style="margin-top:15px;">
                <button onclick="document.getElementById('report-modal').style.display='none'">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- åˆæœŸè¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        function getStorageKey() { return `workload-mgmt-evo-v5-final`; }
        
        let tasks = JSON.parse(localStorage.getItem(getStorageKey())) || [
            { id: 1, title: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹', owner: '', start: getLocalDateStr(), end: getLocalDateStr(), est: 0, progress: 0, isGroup: true, hours: {}, memo: "" }
        ];
        
        // Undoå±¥æ­´
        const historyStack = [];
        const MAX_HISTORY = 20;

        let trackingId = null, trackingStartTime = null, timerInterval = null;
        let dragIdx = null, currentMemoId = null, currentRefTaskId = null, currentRefResults = [];
        let visibleOwners = null, visibleProgress = null, visibleStartDate = null; 
        let dailyLoadMap = {};
        const OVERLOAD_LIMIT = 8; 

        // ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
        const ICON_GROUP = `<svg viewBox="0 0 24 24"><path d="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z"/></svg>`;
        const ICON_DELETE = `<svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>`;
        const ICON_START = `<svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>`;
        const ICON_STOP = `<svg viewBox="0 0 24 24"><path d="M18,18H6V6H18V18Z"/></svg>`;
        const ICON_MEMO = `<svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13,9V3.5L18.5,9H13Z"/></svg>`;
        const ICON_COPY = `<svg viewBox="0 0 24 24"><path d="M16,1H4C2.9,1,2,1.9,2,3V17H4V3H16V1M19,5H8C6.9,5,6,5.9,6,7V21C6,22.1,6.9,23,8,23H19C20.1,23,21,22.1,21,21V7C21,5.9,20.1,5,19,5M19,21H8V7H19V21Z"/></svg>`;
        const ICON_SHIFT_LEFT = `âª`;
        const ICON_SHIFT_RIGHT = `â©`;

        // --- ç¥æ—¥è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ) ---
        function getHolidayName(dateStr) {
            const d = new Date(dateStr);
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const w = d.getDay();
            
            if (m==1 && day==1) return "å…ƒæ—¥";
            if (m==2 && day==11) return "å»ºå›½è¨˜å¿µã®æ—¥";
            if (m==2 && day==23) return "å¤©çš‡èª•ç”Ÿæ—¥";
            if (m==4 && day==29) return "æ˜­å’Œã®æ—¥";
            if (m==5 && day==3) return "æ†²æ³•è¨˜å¿µæ—¥";
            if (m==5 && day==4) return "ã¿ã©ã‚Šã®æ—¥";
            if (m==5 && day==5) return "ã“ã©ã‚‚ã®æ—¥";
            if (m==8 && day==11) return "å±±ã®æ—¥";
            if (m==11 && day==3) return "æ–‡åŒ–ã®æ—¥";
            if (m==11 && day==23) return "å‹¤åŠ´æ„Ÿè¬ã®æ—¥";

            function isHappyMonday(month, n) { return m === month && w === 1 && Math.ceil(day / 7) === n; }
            if (isHappyMonday(1, 2)) return "æˆäººã®æ—¥";
            if (isHappyMonday(7, 3)) return "æµ·ã®æ—¥";
            if (isHappyMonday(9, 3)) return "æ•¬è€ã®æ—¥";
            if (isHappyMonday(10, 2)) return "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥";

            const vernal = Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
            const autumnal = Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
            if (m == 3 && day == vernal) return "æ˜¥åˆ†ã®æ—¥";
            if (m == 9 && day == autumnal) return "ç§‹åˆ†ã®æ—¥";

            const prev = new Date(d); prev.setDate(day - 1);
            if (w === 1 && getHolidayName(prev.toISOString().split('T')[0])) return "æŒ¯æ›¿ä¼‘æ—¥";
            return null;
        }

        // å–¶æ¥­æ—¥åˆ¤å®š (åœŸæ—¥ç¥ã¯false)
        function isBusinessDay(date) {
            const d = date.getDay();
            if (d === 0 || d === 6) return false; // æ—¥ãƒ»åœŸ
            const dateStr = date.toLocaleDateString('sv-SE');
            if (getHolidayName(dateStr)) return false; // ç¥æ—¥
            return true;
        }

        // å–¶æ¥­æ—¥åŠ ç®—ãƒ»æ¸›ç®—
        function addBusinessDays(startStr, daysToAdd) {
            if (!startStr) return "";
            let date = new Date(startStr);
            let added = 0;
            const direction = daysToAdd > 0 ? 1 : -1;
            const target = Math.abs(daysToAdd);

            while (added < target) {
                date.setDate(date.getDate() + direction);
                if (isBusinessDay(date)) {
                    added++;
                }
            }
            return date.toLocaleDateString('sv-SE');
        }

        function getLocalDateStr() { return new Date().toLocaleDateString('sv-SE'); }
        function formatDateForDisplay(d) { return d ? d.replace(/-/g, '/') : ""; }

        // --- Undoæ©Ÿèƒ½ ---
        function pushHistory() {
            if (historyStack.length >= MAX_HISTORY) historyStack.shift();
            historyStack.push(JSON.stringify(tasks));
            document.getElementById('btn-undo').disabled = false;
        }
        function undo() {
            if (historyStack.length === 0) return;
            const prev = historyStack.pop();
            tasks = JSON.parse(prev);
            render();
            if (historyStack.length === 0) document.getElementById('btn-undo').disabled = true;
        }
        function saveState() {
            pushHistory();
            localStorage.setItem(getStorageKey(), JSON.stringify(tasks));
        }

        // --- ãƒ¡ã‚¤ãƒ³æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        function updateLogic() {
            let major = 0, minor = 0;
            tasks.forEach(t => {
                if (t.isGroup) { major++; minor = 0; t.no = major.toString(); }
                else { minor++; t.no = major === 0 ? minor.toString() : `${major}.${minor}`; }
            });
            for (let i = 0; i < tasks.length; i++) {
                let tEst = 0, tSum = 0, weightedProg = 0, minS = null, maxE = null, hasChild = false;
                if (tasks[i].isGroup) {
                    for (let j = i + 1; j < tasks.length; j++) {
                        if (tasks[j].isGroup) break;
                        hasChild = true;
                        let child = tasks[j];
                        let childSum = Object.values(child.hours).reduce((a, b) => a + Number(b), 0);
                        tEst += Number(child.est || 0);
                        tSum += childSum;
                        weightedProg += (Number(child.progress || 0) * Number(child.est || 0));
                        if (child.start && (!minS || child.start < minS)) minS = child.start;
                        if (child.end && (!maxE || child.end > maxE)) maxE = child.end;
                    }
                    if (hasChild) {
                        tasks[i].est = tEst;
                        if(minS) tasks[i].start = minS;
                        if(maxE) tasks[i].end = maxE;
                        tasks[i].progress = tEst > 0 ? Math.round(weightedProg / tEst) : 0;
                        tasks[i].computedSum = tSum;
                    } else { tasks[i].computedSum = Object.values(tasks[i].hours).reduce((a, b) => a + Number(b), 0); }
                } else { tasks[i].computedSum = Object.values(tasks[i].hours).reduce((a, b) => a + Number(b), 0); }
            }
            dailyLoadMap = {};
            tasks.forEach(t => {
                if (!t.isGroup && t.owner) {
                    const owner = t.owner;
                    if (!dailyLoadMap[owner]) dailyLoadMap[owner] = {};
                    Object.keys(t.hours).forEach(date => {
                        const val = parseFloat(t.hours[date]);
                        if (!isNaN(val)) dailyLoadMap[owner][date] = (dailyLoadMap[owner][date] || 0) + val;
                    });
                }
            });
        }

        function render() {
            updateLogic();
            localStorage.setItem(getStorageKey(), JSON.stringify(tasks));
            const wbsBody = document.getElementById('wbs-body');
            const ganttHead = document.getElementById('gantt-header');
            const ganttBody = document.getElementById('gantt-body');
            wbsBody.innerHTML = ganttHead.innerHTML = ganttBody.innerHTML = "";

            const todayStr = getLocalDateStr();
            const todayObj = new Date(todayStr);
            const allDates = tasks.flatMap(t => [new Date(t.start), new Date(t.end)]);
            let minD = new Date(Math.min(...allDates, todayObj));
            minD.setDate(minD.getDate() - 5);
            let maxD = new Date(Math.max(...allDates, todayObj));
            maxD.setDate(maxD.getDate() + 25);

            const dateList = [];
            for (let d = new Date(minD); d <= maxD; d.setDate(d.getDate() + 1)) {
                const curStr = d.toLocaleDateString('sv-SE');
                const holiday = getHolidayName(curStr);
                dateList.push({ str: curStr, label: `${d.getMonth()+1}/${d.getDate()}`, w: d.getDay(), isToday: curStr === todayStr, holiday: holiday });
            }

            dateList.forEach(d => {
                const isHoliday = d.w === 0 || d.holiday;
                const classNames = `cell day-cell ${d.w===6?'sat':''} ${isHoliday?'sun holiday':''} ${d.isToday?'is-today-h':''}`;
                const h = document.createElement('div');
                h.className = classNames;
                if(d.isToday) h.id = "today-target";
                h.innerText = d.label;
                if(d.holiday) h.title = d.holiday;
                ganttHead.appendChild(h);
            });

            const todayIdx = dateList.findIndex(d => d.isToday);
            if (todayIdx !== -1) {
                const line = document.createElement('div');
                line.className = 'today-line';
                line.style.left = (todayIdx * 55) + 'px'; 
                ganttBody.appendChild(line);
            }

            const visibleIndices = new Set();
            tasks.forEach((t, i) => {
                let ownerOk = visibleOwners ? visibleOwners.has(t.owner || "") : true;
                let progOk = visibleProgress ? visibleProgress.has((Number(t.progress)>=100)?'complete':'incomplete') : true;
                let dateOk = visibleStartDate ? (!t.start || t.start >= visibleStartDate) : true;
                if (t.isGroup) visibleIndices.add(i); 
                else if (ownerOk && progOk && dateOk) visibleIndices.add(i);
            });

            tasks.forEach((t, idx) => {
                if (!t.isGroup && !visibleIndices.has(idx)) return;
                
                const isTracking = trackingId === t.id;
                const remain = (Number(t.est || 0) - t.computedSum).toFixed(1);
                
                const getDateAlert = (f, val) => {
                    if (f !== 'end' || !val) return "";
                    if (Number(t.progress) >= 100) return "";
                    if (val <= todayStr) return "status-red";
                    const diff = Math.ceil((new Date(val) - new Date(todayStr))/(86400000));
                    return diff <= 3 ? "status-yellow" : "";
                };

                const wRow = document.createElement('div');
                wRow.className = 'row' + (t.isGroup ? ' group-row' : '') + (isTracking ? ' tracking-active' : '');
                wRow.draggable = true;
                wRow.ondragstart = () => dragIdx = idx;
                wRow.ondragover = (e) => e.preventDefault();
                wRow.ondrop = () => { 
                    saveState();
                    const move = tasks.splice(dragIdx, 1)[0]; 
                    tasks.splice(idx, 0, move); 
                    render(); 
                };

                const startDateVal = t.isGroup ? formatDateForDisplay(t.start) : (t.start || "");
                const endDateVal = t.isGroup ? formatDateForDisplay(t.end) : (t.end || "");

                wRow.innerHTML = `
                    <div class="cell col-no">${t.no}</div>
                    <div class="cell col-title" style="padding-left:${t.isGroup?'4px':'20px'}"><input value="${t.title}" onchange="upd(${t.id},'title',this.value)"></div>
                    <div class="cell col-owner"><input value="${t.owner}" onchange="upd(${t.id},'owner',this.value)" ${t.isGroup?'readonly':''}></div>
                    <div class="cell col-date"><input type="${t.isGroup?'text':'date'}" class="date-input" value="${startDateVal}" onchange="upd(${t.id},'start',this.value)" ${t.isGroup?'readonly':''}></div>
                    <div class="cell col-date"><input type="${t.isGroup?'text':'date'}" class="date-input ${getDateAlert('end',t.end)}" value="${endDateVal}" onchange="upd(${t.id},'end',this.value)" ${t.isGroup?'readonly':''}></div>
                    <div class="cell col-h"><input type="number" min="0" step="0.1" value="${Number(t.est).toFixed(1)}" onchange="upd(${t.id},'est',this.value)" ${t.isGroup?'readonly':''}>${!t.isGroup?`<div class="icon-ref" onclick="openRef(${t.id})" title="å®Ÿç¸¾å‚ç…§">ğŸ”</div>`:''}</div>
                    <div class="cell col-h center" style="font-weight:bold">${t.computedSum.toFixed(1)}</div>
                    <div class="cell col-h center" style="color:${remain<0?'red':'inherit'}">${remain}</div>
                    <div class="cell col-ratio center">${t.est>0 ? Math.round((t.computedSum/t.est)*100) : 0}%</div>
                    <div class="cell col-progress">${t.isGroup ? t.progress+'%' : `<input type="number" min="0" max="100" value="${t.progress}" onchange="upd(${t.id},'progress',this.value)">%`}</div>
                    <div class="cell col-op">
                        <div class="icon-btn" onclick="toggleGrp(${t.id})" title="ã‚°ãƒ«ãƒ¼ãƒ—åŒ–åˆ‡æ›¿">${ICON_GROUP}</div>
                        <div class="icon-btn icon-memo ${t.memo?'has-content':''}" onclick="openMemo(${t.id})" title="ãƒ¡ãƒ¢ã‚’é–‹ã">${ICON_MEMO}</div>
                        <div class="icon-btn" onclick="copyTask(${t.id})" title="ã‚¿ã‚¹ã‚¯ã‚’è¤‡è£½">${ICON_COPY}</div>
                        ${!t.isGroup ? (isTracking ? `<div class="icon-btn icon-timer stop" onclick="stopTracking()" title="è¨ˆæ¸¬ã‚’åœæ­¢ã—ã¦å·¥æ•°ã‚’å…¥åŠ›">${ICON_STOP}</div>` : `<div class="icon-btn icon-timer start" onclick="startTracking(${t.id})" title="è¨ˆæ¸¬ã‚’é–‹å§‹">${ICON_START}</div>`) : ''}
                        ${!t.isGroup ? `<div class="icon-btn icon-shift-left" onclick="shiftTaskDays(${t.id}, -1)" title="é–‹å§‹æ—¥ãƒ»æœŸé™ã‚’1å–¶æ¥­æ—¥å‰ã¸">${ICON_SHIFT_LEFT}</div><div class="icon-btn icon-shift-right" onclick="shiftTaskDays(${t.id}, 1)" title="é–‹å§‹æ—¥ãƒ»æœŸé™ã‚’1å–¶æ¥­æ—¥å¾Œã¸">${ICON_SHIFT_RIGHT}</div>` : ''}
                        <div class="icon-btn icon-delete" onclick="delT(${t.id})" title="å‰Šé™¤">${ICON_DELETE}</div>
                    </div>
                `;
                wbsBody.appendChild(wRow);

                const gRow = document.createElement('div');
                gRow.className = 'row' + (t.isGroup ? ' group-row' : '');
                
                dateList.forEach(d => {
                    const val = t.hours[d.str] !== undefined ? parseFloat(t.hours[d.str]).toFixed(1) : "";
                    const inRange = (t.start && t.end && d.str >= t.start && d.str <= t.end);
                    
                    let isOver = false;
                    let load = 0;
                    if (!t.isGroup && t.owner && dailyLoadMap[t.owner] && dailyLoadMap[t.owner][d.str]) {
                        load = dailyLoadMap[t.owner][d.str];
                        if(load > OVERLOAD_LIMIT) isOver = true;
                    }

                    const isHoliday = d.w === 0 || d.holiday;
                    const c = document.createElement('div');
                    c.className = `cell day-cell ${d.w===6?'sat':''} ${isHoliday?'sun holiday':''} ${inRange?'in-range':''} ${isOver?'over-limit':''}`;
                    if(isOver) c.title = `åˆè¨ˆ:${load}h`;
                    
                    if (!t.isGroup) {
                        const inv = document.createElement('input');
                        inv.type = "number"; inv.min = "0"; inv.step = "0.1"; inv.className = "hour-input";
                        inv.value = val;
                        inv.onchange = (e) => updHr(t.id, d.str, e.target.value);
                        c.appendChild(inv);
                    }
                    gRow.appendChild(c);
                });
                ganttBody.appendChild(gRow);
            });
        }

        // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
        function upd(id, f, v) { 
            saveState();
            const t = tasks.find(x => x.id === id); 
            if(t) { 
                if((f==='est'||f==='progress') && v<0) v=0;
                if(f==='progress' && v>100) v=100;
                t[f] = v;
            }
            render(); 
        }
        function updHr(id, dt, v) {
            saveState();
            const t = tasks.find(x => x.id === id);
            if(t) {
                const nv = parseFloat(v);
                if (!v || isNaN(nv) || nv <= 0) delete t.hours[dt];
                else t.hours[dt] = nv;
            }
            render();
        }
        function toggleGrp(id) { saveState(); const t = tasks.find(x => x.id === id); if(t) t.isGroup = !t.isGroup; render(); }
        function addTask() { 
            saveState();
            const today = getLocalDateStr(); 
            tasks.push({ id: Date.now(), title: 'æ–°è¦ã‚¿ã‚¹ã‚¯', owner: '', start: today, end: today, est: 0.0, progress: 0, isGroup: false, hours: {}, memo: "" }); 
            render(); 
        }
        function copyTask(id) {
            saveState();
            const t = tasks.find(x => x.id === id);
            if(t) {
                const newT = JSON.parse(JSON.stringify(t));
                newT.id = Date.now();
                newT.title += " (ã‚³ãƒ”ãƒ¼)";
                newT.hours = {}; 
                newT.progress = 0;
                const idx = tasks.findIndex(x => x.id === id);
                tasks.splice(idx + 1, 0, newT);
                render();
            }
        }
        function delT(id) { 
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { 
                saveState();
                if(trackingId === id) stopTracking(); 
                tasks = tasks.filter(x => x.id !== id); 
                render(); 
            } 
        }

        // --- ã‚·ãƒ•ãƒˆæ©Ÿèƒ½ (æ”¹ä¿®ç‰ˆ) ---
        function openShiftModal() { 
            const sel = document.getElementById('shift-target-group');
            sel.innerHTML = '';
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆè¦ªã‚¿ã‚¹ã‚¯ï¼‰ã®ã¿ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
            let hasGroup = false;
            tasks.forEach(t => {
                if(t.isGroup) {
                    hasGroup = true;
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.innerText = t.title;
                    sel.appendChild(opt);
                }
            });
            
            if (!hasGroup) {
                alert("è¦ªã‚¿ã‚¹ã‚¯ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚å…ˆã«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            document.getElementById('shift-modal').style.display = 'flex'; 
        }

        function applyShift() {
            const days = parseInt(document.getElementById('shift-days').value);
            const targetGroupId = document.getElementById('shift-target-group').value;
            
            if (days === 0 || isNaN(days)) {
                alert("ã‚·ãƒ•ãƒˆæ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            if (!targetGroupId) {
                alert("å¯¾è±¡ã®è¦ªã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }
            
            saveState();
            
            // å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—é…ä¸‹ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®šã—ã¦ã‚·ãƒ•ãƒˆ
            let inTargetGroup = false;
            let count = 0;

            tasks.forEach(t => {
                // ã‚°ãƒ«ãƒ¼ãƒ—è¡Œã®åˆ¤å®š
                if (t.isGroup) {
                    // é¸æŠã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ãŸ
                    if (t.id.toString() === targetGroupId) {
                        inTargetGroup = true;
                    } else {
                        // åˆ¥ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ãŸã‚‰å¯¾è±¡å¤–ã¸
                        inTargetGroup = false;
                    }
                    return; // ã‚°ãƒ«ãƒ¼ãƒ—è¡Œè‡ªä½“ã®æ—¥ä»˜ã¯è‡ªå‹•è¨ˆç®—ãªã®ã§è§¦ã‚‰ãªã„
                }

                // å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—å†… ã‹ã¤ æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®ã¿å‡¦ç†
                if (inTargetGroup && Number(t.progress) < 100) {
                    if (t.start) t.start = addBusinessDays(t.start, days);
                    if (t.end) t.end = addBusinessDays(t.end, days);
                    count++;
                }
            });

            document.getElementById('shift-modal').style.display = 'none';
            render();
            alert(`${count}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ã§ ${days}æ—¥ ã‚·ãƒ•ãƒˆã—ã¾ã—ãŸã€‚`);
        }

        // --- å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”¨ã‚·ãƒ•ãƒˆæ©Ÿèƒ½ ---
        function shiftTaskDays(id, businessDays) {
            saveState();
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            
            if (t.start) t.start = addBusinessDays(t.start, businessDays);
            if (t.end) t.end = addBusinessDays(t.end, businessDays);
            
            const directionText = businessDays > 0 ? 'å¾Œ' : 'å‰';
            const daysText = Math.abs(businessDays) === 1 ? '1å–¶æ¥­æ—¥' : `${Math.abs(businessDays)}å–¶æ¥­æ—¥`;
            render();
        }

        // --- ãƒ¡ãƒ¢ ---
        function openMemo(id) {
            currentMemoId = id; const t = tasks.find(x => x.id === id);
            document.getElementById('memo-title').innerText = `ãƒ¡ãƒ¢: ${t.title}`;
            document.getElementById('memo-text').value = t.memo || "";
            document.getElementById('memo-text').readOnly = false;
            document.getElementById('btn-save-memo').style.display = 'inline-block';
            document.getElementById('memo-modal').style.display = 'flex';
        }
        function viewRefMemo(index) {
            if (!currentRefResults[index]) return;
            const t = currentRefResults[index].task;
            document.getElementById('memo-title').innerText = `ãƒ¡ãƒ¢å‚ç…§: ${t.title}`;
            document.getElementById('memo-text').value = t.memo || "";
            document.getElementById('memo-text').readOnly = true;
            document.getElementById('btn-save-memo').style.display = 'none';
            document.getElementById('memo-modal').style.display = 'flex';
        }
        function closeMemo() { document.getElementById('memo-modal').style.display = 'none'; currentMemoId = null; }
        function saveMemo() {
            if(currentMemoId) { saveState(); const t = tasks.find(x => x.id === currentMemoId); t.memo = document.getElementById('memo-text').value; render(); }
            closeMemo();
        }

        // --- å®Ÿç¸¾å‚ç…§ ---
        function openRef(id) {
            const t = tasks.find(x => x.id === id); if(!t) return;
            currentRefTaskId = id;
            document.getElementById('ref-search-key').value = t.title; 
            const owners = new Set(); tasks.forEach(task => { if(task.owner) owners.add(task.owner); });
            const sel = document.getElementById('ref-search-owner'); sel.innerHTML = '<option value="">(å…¨æ‹…å½“è€…)</option>';
            Array.from(owners).sort().forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.innerText = o; sel.appendChild(opt); });
            document.getElementById('ref-search-status').value = "";
            setAdjustVal(0); drawDistribution([], 20); updateDistInfo(0);
            document.getElementById('ref-modal').style.display = 'flex'; searchRef(); 
        }
        function closeRef() { document.getElementById('ref-modal').style.display = 'none'; currentRefTaskId = null; }
        function toggleSelectAll(checked) { currentRefResults.forEach(r => r.isSelected = checked); renderRefList(); recalculateSummary(); }
        function toggleRefSelection(index, checked) { if (currentRefResults[index]) { currentRefResults[index].isSelected = checked; recalculateSummary(); const selectAll = document.getElementById('select-all-ref'); const selectedCount = currentRefResults.filter(r => r.isSelected).length; const totalCount = currentRefResults.length; if (totalCount === 0) { selectAll.checked = false; selectAll.indeterminate = false; } else if (selectedCount === totalCount) { selectAll.checked = true; selectAll.indeterminate = false; } else if (selectedCount > 0) { selectAll.checked = false; selectAll.indeterminate = true; } else { selectAll.checked = false; selectAll.indeterminate = false; } } }
        
        function searchRef() {
            const rawKey = document.getElementById('ref-search-key').value;
            const keywords = rawKey.trim() ? rawKey.toLowerCase().trim().split(/[\sã€€]+/) : [];
            const ownerFilter = document.getElementById('ref-search-owner').value;
            const statusFilter = document.getElementById('ref-search-status').value;
            currentRefResults = []; let currentParentTitle = "-";
            tasks.forEach(t => {
                if (t.isGroup) { currentParentTitle = t.title; } else {
                    if (t.id !== currentRefTaskId && t.computedSum > 0) {
                        const searchTarget = (currentParentTitle + " " + t.title).toLowerCase();
                        const isMatch = keywords.length === 0 || keywords.every(k => searchTarget.includes(k));
                        if (!isMatch) return;
                        if (ownerFilter && t.owner !== ownerFilter) return;
                        const isComplete = (Number(t.progress) >= 100);
                        if (statusFilter === 'complete' && !isComplete) return;
                        if (statusFilter === 'incomplete' && isComplete) return;
                        currentRefResults.push({ task: t, parent: currentParentTitle, isComplete: isComplete, isSelected: true });
                    }
                }
            });
            document.getElementById('select-all-ref').checked = currentRefResults.length > 0;
            document.getElementById('select-all-ref').indeterminate = false;
            renderRefList(); recalculateSummary();
        }
        function renderRefList() {
            const tbody = document.getElementById('ref-table-body'); tbody.innerHTML = "";
            currentRefResults.forEach((item, index) => {
                const t = item.task; const memoCell = t.memo ? `<button class="icon-btn" style="width:24px;height:24px; margin:0 auto;" onclick="viewRefMemo(${index})" title="ãƒ¡ãƒ¢ã‚’è¡¨ç¤º">ğŸ“„</button>` : "-";
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="ref-checkbox"><input type="checkbox" onchange="toggleRefSelection(${index}, this.checked)" ${item.isSelected ? 'checked' : ''}></td><td style="color:#555; font-size:11px;">${item.parent}</td><td>${t.title}</td><td style="text-align:center;">${memoCell}</td><td>${t.owner || '-'}</td><td>${t.computedSum.toFixed(1)}h</td><td style="color:${item.isComplete?'#2f5597':'#d97706'}">${t.progress}%</td><td><button class="select-btn" onclick="setAdjustVal(${t.computedSum})">é¸æŠ</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function recalculateSummary() {
            const selectedResults = currentRefResults.filter(r => r.isSelected);
            let count = selectedResults.length; let sum = 0, max = 0;
            if (count > 0) {
                sum = selectedResults.reduce((a, b) => a + b.task.computedSum, 0);
                max = Math.max(...selectedResults.map(r => r.task.computedSum));
                const avg = sum / count;
                document.getElementById('ref-count').innerText = count; document.getElementById('ref-avg').innerText = avg.toFixed(1); document.getElementById('ref-max').innerText = max.toFixed(1); document.getElementById('ref-summary-area').style.display = 'flex';
                const distData = selectedResults.map(r => ({ val: r.task.computedSum, isComplete: r.isComplete }));
                const slider = document.getElementById('adjust-slider');
                drawDistribution(distData, Math.max(20, Math.ceil(max * 2)), avg);
                const currentVal = parseFloat(slider.value);
                if (Math.abs(currentVal - avg) > 1.0) { setAdjustVal(avg); } else { updateDistInfo(currentVal); }
            } else {
                document.getElementById('ref-count').innerText = 0; document.getElementById('ref-avg').innerText = "0.0"; document.getElementById('ref-max').innerText = "0.0"; document.getElementById('ref-summary-area').style.display = 'none';
                drawDistribution([], 20); updateDistInfo(0); setAdjustVal(0);
            }
        }
        function selectRefVal(type) { const valStr = document.getElementById(type === 'avg' ? 'ref-avg' : 'ref-max').innerText; const val = parseFloat(valStr); if(!isNaN(val)) setAdjustVal(val); }
        function setAdjustVal(val) {
            val = parseFloat(val); if(isNaN(val) || val < 0) val = 0;
            const selectedVals = currentRefResults.filter(r => r.isSelected).map(r => r.task.computedSum);
            const maxRef = selectedVals.length > 0 ? Math.max(...selectedVals) : 0;
            const maxVal = Math.max(20, Math.ceil(Math.max(val*2, maxRef, 0) || 20));
            const slider = document.getElementById('adjust-slider'); slider.max = maxVal; slider.value = val; document.getElementById('adjust-num').value = val.toFixed(1);
            let avg = 0; if (selectedVals.length > 0) { avg = selectedVals.reduce((a,b) => a + b, 0) / selectedVals.length; }
            const distData = currentRefResults.filter(r => r.isSelected).map(r => ({ val: r.task.computedSum, isComplete: r.isComplete }));
            drawDistribution(distData, maxVal, avg); updateDistInfo(val);
        }
        function syncSlider(val) { document.getElementById('adjust-slider').value = val; updateDistInfo(val); }
        function syncNum(val) { document.getElementById('adjust-num').value = parseFloat(val).toFixed(1); updateDistInfo(val); }
        function updateDistInfo(val) {
            val = parseFloat(val); if (isNaN(val)) return;
            const infoEl = document.getElementById('dist-info');
            const selectedResults = currentRefResults.filter(r => r.isSelected);
            if (selectedResults.length === 0) { infoEl.innerHTML = "è©²å½“ã™ã‚‹å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"; return; }
            const range = 0.25;
            const hits = selectedResults.filter(r => r.task.computedSum >= (val - range) && r.task.computedSum < (val + range));
            if (hits.length > 0) {
                const count = hits.length;
                let names = hits.slice(0, 3).map(r => {
                    const parentStr = (r.parent && r.parent !== "-") ? r.parent + " > " : "";
                    return `${parentStr}${r.task.title}(${r.task.computedSum.toFixed(1)}h, ${r.task.progress}%)`;
                }).join(", ");
                if (hits.length > 3) names += `, ä»–${hits.length - 3}ä»¶`;
                infoEl.innerHTML = `<span class="dist-highlight">${val.toFixed(1)}h ä»˜è¿‘ã®å®Ÿç¸¾:</span> <b>${count}ä»¶</b> ï¼ˆ${names}ï¼‰`;
            } else { infoEl.innerHTML = `<span class="dist-highlight">${val.toFixed(1)}h ä»˜è¿‘ã®å®Ÿç¸¾:</span> ãªã—`; }
        }
        function applyRefAdjusted() {
            if(!currentRefTaskId) return; const val = parseFloat(document.getElementById('adjust-num').value); if(isNaN(val)) return;
            const t = tasks.find(x => x.id === currentRefTaskId); if(t) { t.est = val; render(); } closeRef();
        }
        function drawDistribution(data, maxRange, average) {
            const canvas = document.getElementById('dist-canvas'); const ctx = canvas.getContext('2d');
            const w = canvas.parentElement.offsetWidth; const h = canvas.parentElement.offsetHeight;
            canvas.width = w; canvas.height = h; ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "#eee"; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
            ctx.fillStyle = "#999"; ctx.font = "10px sans-serif"; ctx.fillText("0h", 2, h - 2); ctx.fillText(maxRange + "h", w - 25, h - 2);
            if (!data || data.length === 0) return;
            const binSize = 0.5; const bins = {}; let maxCount = 0;
            data.forEach(item => {
                const binKey = Math.floor(item.val / binSize) * binSize;
                bins[binKey] = (bins[binKey] || 0) + 1;
                if (bins[binKey] > maxCount) maxCount = bins[binKey];
            });
            ctx.fillStyle = "rgba(47, 85, 151, 0.6)"; 
            for (let b in bins) {
                const val = parseFloat(b); const count = bins[b];
                const x = (val / maxRange) * w; const barW = (binSize / maxRange) * w;
                const totalH = (count / maxCount) * (h - 8); const yBase = (h/2) + (totalH/2);
                ctx.fillRect(x, yBase - totalH, Math.max(barW - 1, 1), totalH);
            }
            if (average > 0) {
                const avgX = (average / maxRange) * w; ctx.beginPath(); ctx.strokeStyle = "rgba(255, 0, 0, 0.7)"; ctx.lineWidth = 2; ctx.setLineDash([3, 3]); ctx.moveTo(avgX, 5); ctx.lineTo(avgX, h - 5); ctx.stroke(); ctx.setLineDash([]); 
            }
        }

        // --- ã‚¿ã‚¤ãƒãƒ¼ ---
        function startTracking(id) {
            if(trackingId) stopTracking();
            trackingId = id; trackingStartTime = new Date();
            const t = tasks.find(x => x.id === id);
            timerInterval = setInterval(() => {
                const d = new Date(new Date() - trackingStartTime);
                document.getElementById('tracker-status').innerText = `è¨ˆæ¸¬ä¸­: ${t.title} (${d.getUTCHours()}:${d.getUTCMinutes()}:${d.getUTCSeconds()})`;
            }, 1000);
            render();
        }
        function stopTracking() {
            if(!trackingId) return;
            saveState();
            const h = (new Date() - trackingStartTime) / 3600000;
            const t = tasks.find(x => x.id === trackingId);
            const today = getLocalDateStr();
            t.hours[today] = parseFloat(((t.hours[today]||0) + h).toFixed(1));
            clearInterval(timerInterval); trackingId = null;
            document.getElementById('tracker-status').innerText = "";
            render();
        }

        // --- åˆ†æãƒ»ãƒãƒ£ãƒ¼ãƒˆ (ã‚³ã‚¹ãƒˆæ©Ÿèƒ½å‰Šé™¤ç‰ˆ) ---
        function openAnalyze() {
            const now = new Date();
            document.getElementById('ana-start').value = new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString('sv-SE');
            document.getElementById('ana-end').value = new Date(now.getFullYear(), now.getMonth()+1, 0).toLocaleDateString('sv-SE');
            const sel = document.getElementById('ana-target'); sel.innerHTML = '<option value="">(å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»è¦ªã‚¿ã‚¹ã‚¯æ¯”è¼ƒ)</option>';
            tasks.filter(t=>t.isGroup).forEach(t => sel.appendChild(new Option(t.title, t.id)));
            document.getElementById('analyze-modal').style.display = 'flex';
            setTimeout(renderCharts, 200);
        }

        function renderCharts() {
            const start = document.getElementById('ana-start').value;
            const end = document.getElementById('ana-end').value;
            const targetId = document.getElementById('ana-target').value;
            
            const compareItems = [];
            const pieData = {};
            const dailyData = {}; 
            
            let cur = new Date(start); const endObj = new Date(end);
            while(cur <= endObj) {
                dailyData[cur.toLocaleDateString('sv-SE')] = {};
                cur.setDate(cur.getDate()+1);
            }

            tasks.forEach(t => {
                if (t.isGroup) {
                    if (targetId && t.id != targetId) return;
                } else {
                    let tAct = 0;
                    Object.keys(t.hours).forEach(d => {
                        if (d >= start && d <= end) {
                            const h = t.hours[d];
                            const val = h;
                            tAct += val;
                            const owner = t.owner || "(æœªå‰²å½“)";
                            pieData[owner] = (pieData[owner] || 0) + val;
                            if (dailyData[d]) dailyData[d][owner] = (dailyData[d][owner] || 0) + val;
                        }
                    });
                    
                    if (tAct > 0 || (t.est > 0 && !targetId)) { 
                        const estVal = t.est;
                        compareItems.push({ label: t.title, est: estVal, act: tAct });
                    }
                }
            });

            drawBarChart(compareItems);
            drawPieChart(pieData);
            drawDailyChart(dailyData);
        }

        function drawBarChart(items) {
            const canvas = document.getElementById('chart-bar-compare');
            const ctx = canvas.getContext('2d');
            const h = Math.max(items.length * 40 + 50, 200);
            canvas.height = h; canvas.width = canvas.parentElement.offsetWidth;
            const w = canvas.width;
            ctx.clearRect(0,0,w,h);
            
            const maxVal = Math.max(...items.map(i=>Math.max(i.est, i.act))) || 1;
            const scale = (w - 150) / maxVal;
            
            items.forEach((it, i) => {
                const y = 30 + i * 40;
                ctx.fillStyle = "#333"; ctx.font="12px sans-serif"; ctx.textAlign="right";
                ctx.fillText(it.label.slice(0,10), 140, y + 15);
                
                ctx.fillStyle = "#ccc";
                ctx.fillRect(150, y, it.est * scale, 10);
                
                ctx.fillStyle = it.act > it.est ? "#cc0000" : "#5b9bd5";
                ctx.fillRect(150, y+12, it.act * scale, 10);
                
                ctx.textAlign="left"; ctx.fillStyle="#555"; ctx.font="10px sans-serif";
                const valStr = it.act.toFixed(1);
                ctx.fillText(valStr + "h", 150 + it.act * scale + 5, y+20);
            });
        }

        function drawPieChart(data) {
            const canvas = document.getElementById('chart-pie-owner');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.offsetWidth;
            const h = canvas.height = 250;
            ctx.clearRect(0,0,w,h);
            
            let total = 0; Object.values(data).forEach(v => total += v);
            if(total===0) { ctx.fillText("ãƒ‡ãƒ¼ã‚¿ãªã—", w/2, h/2); return; }

            let start = -Math.PI/2;
            const colors = ['#5b9bd5', '#ed7d31', '#a5a5a5', '#ffc000', '#4472c4'];
            let i = 0;
            Object.keys(data).forEach(k => {
                const val = data[k];
                const angle = (val/total) * Math.PI * 2;
                ctx.beginPath(); ctx.moveTo(w/3, h/2); ctx.arc(w/3, h/2, 100, start, start+angle);
                ctx.fillStyle = colors[i%colors.length]; ctx.fill();
                
                ctx.fillRect(w*0.6, 50 + i*20, 10, 10);
                ctx.fillStyle = "#333"; ctx.textAlign="left";
                const valStr = val.toFixed(1);
                ctx.fillText(`${k}: ${valStr}h`, w*0.6 + 15, 60 + i*20);
                
                start += angle; i++;
            });
        }

        function drawDailyChart(data) {
            const canvas = document.getElementById('chart-bar-daily');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.offsetWidth;
            const h = canvas.height = 300;
            ctx.clearRect(0,0,w,h);
            
            const dates = Object.keys(data).sort();
            const owners = new Set();
            dates.forEach(d => Object.keys(data[d]).forEach(o => owners.add(o)));
            const ownerArr = Array.from(owners);
            const colors = ['#5b9bd5', '#ed7d31', '#a5a5a5', '#ffc000'];

            let max = 0;
            dates.forEach(d => {
                const sum = Object.values(data[d]).reduce((a,b)=>a+b,0);
                if(sum > max) max = sum;
            });
            if(max===0) max=1;

            const barW = Math.min(30, (w-50)/dates.length - 2);
            const scale = (h-50) / max;

            dates.forEach((d, i) => {
                let y = h - 30;
                const x = 40 + i * ((w-50)/dates.length);
                ownerArr.forEach((o, oi) => {
                    const val = data[d][o] || 0;
                    if(val > 0) {
                        const barH = val * scale;
                        ctx.fillStyle = colors[oi%colors.length];
                        ctx.fillRect(x, y - barH, barW, barH);
                        y -= barH;
                    }
                });
                if (dates.length < 15 || i%5===0) {
                    ctx.fillStyle = "#333"; ctx.textAlign="center"; ctx.font="10px sans-serif";
                    ctx.fillText(d.slice(5), x+barW/2, h-15);
                }
            });
        }

        // --- ãã®ä»– å¤–éƒ¨é€£æº (æ—¥å ±å¾©åˆ»ç‰ˆ) ---
        function openReport() { document.getElementById('report-month').value = new Date().toISOString().slice(0, 7); renderReportContent(); document.getElementById('report-modal').style.display = 'flex'; }
        function renderReportContent() {
            const ym = document.getElementById('report-month').value; if (!ym) return;
            const tbody = document.getElementById('report-body'); tbody.innerHTML = "";
            const dailyData = {};
            
            // è¦ªã‚¿ã‚¹ã‚¯åã®ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆ
            const parentMap = {};
            let currentParentTitle = "";
            tasks.forEach(t => {
                if (t.isGroup) {
                    currentParentTitle = t.title;
                } else {
                    parentMap[t.id] = currentParentTitle;
                }
            });
            
            tasks.forEach(t => {
                if (t.isGroup) return;
                const owner = t.owner || "(æœªå‰²å½“)";
                Object.keys(t.hours).forEach(date => {
                    if (!date.startsWith(ym)) return;
                    if (!dailyData[date]) dailyData[date] = {};
                    if (!dailyData[date][owner]) dailyData[date][owner] = { total: 0, taskDetails: [] };
                    const h = t.hours[date];
                    dailyData[date][owner].total += h;
                    const parentName = parentMap[t.id] || "";
                    const displayTitle = parentName ? `${parentName}/${t.title}` : t.title;
                    dailyData[date][owner].taskDetails.push(`${displayTitle}(${h.toFixed(1)}h)`);
                });
            });
            const sortedDates = Object.keys(dailyData).sort();
            if (sortedDates.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'; return; }
            sortedDates.forEach(date => {
                const dayData = dailyData[date]; const owners = Object.keys(dayData).sort();
                owners.forEach(owner => {
                    const data = dayData[owner]; const isOver = data.total > 8; const tr = document.createElement('tr'); if (isOver) tr.className = 'report-over-limit';
                    tr.innerHTML = `<td>${date}</td><td>${owner}</td><td>${data.taskDetails.join(', ')}</td><td class="num-cell">${data.total.toFixed(1)}h</td>`;
                    tbody.appendChild(tr);
                });
            });
        }
        function copyReportToClipboard() {
            let txt = "æ—¥ä»˜\tæ‹…å½“\tå†…è¨³\tåˆè¨ˆ\n";
            document.querySelectorAll("#report-body tr").forEach(tr => {
                txt += Array.from(tr.cells).map(c => c.innerText).join("\t") + "\n";
            });
            navigator.clipboard.writeText(txt).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
        }
        function downloadJSON() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(tasks,null,2)],{type:'application/json'})); a.download='wbs_data.json'; a.click(); }
        function downloadCSV() {
            let csv = "No,Task,Owner,Start,End,Est,Act,Progress,Memo\n";
            tasks.forEach(t => {
                csv += `"${t.no}","${t.title}","${t.owner}","${t.start}","${t.end}",${t.est},${t.computedSum},${t.progress},"${t.memo}"\n`;
            });
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([bom, csv],{type:'text/csv'})); a.download='wbs.csv'; a.click();
        }
        function uploadJSON(e) {
            const r = new FileReader(); r.onload = ev => { saveState(); tasks = JSON.parse(ev.target.result); render(); }; r.readAsText(e.target.files[0]);
        }
        
        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ­ã‚¸ãƒƒã‚¯ (åˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»•æ§˜) ---
        function toggleFilterMenu(e) { 
            e.stopPropagation(); 
            document.getElementById('date-filter-menu').style.display='none'; 
            document.getElementById('prog-filter-menu').style.display='none'; 
            const menu = document.getElementById('filter-menu'); 
            if(menu.style.display==='flex'){ menu.style.display='none'; return; }
            
            menu.innerHTML = '';
            // å…¨è§£é™¤ãƒ»å…¨é¸æŠ
            const allBtnDiv = document.createElement('div'); allBtnDiv.style.padding="4px"; allBtnDiv.style.borderBottom="1px solid #eee"; allBtnDiv.style.marginBottom="4px"; allBtnDiv.style.display="flex"; allBtnDiv.style.gap="10px"; allBtnDiv.style.justifyContent="center";
            const btnAll = document.createElement('button'); btnAll.innerText="ã™ã¹ã¦"; btnAll.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=true)};
            const btnClear = document.createElement('button'); btnClear.innerText="è§£é™¤"; btnClear.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=false)};
            allBtnDiv.appendChild(btnAll); allBtnDiv.appendChild(btnClear); menu.appendChild(allBtnDiv);
            
            const owners = new Set(); tasks.forEach(t=>owners.add(t.owner||""));
            Array.from(owners).sort().forEach(o=>{
                const val = o===""?"(æœªå‰²å½“)":o;
                const label = document.createElement('label'); 
                const chk = document.createElement('input'); chk.type="checkbox"; chk.value=o;
                if(visibleOwners===null || visibleOwners.has(o)) chk.checked=true;
                label.appendChild(chk); label.appendChild(document.createTextNode(val));
                menu.appendChild(label);
            });
            
            const actionDiv = document.createElement('div'); actionDiv.className='filter-actions';
            const applyBtn = document.createElement('button'); applyBtn.className='primary'; applyBtn.innerText="é©ç”¨";
            applyBtn.onclick=()=>{
                const checked = menu.querySelectorAll('input:checked');
                if(checked.length === owners.size) visibleOwners = null;
                else { visibleOwners=new Set(); checked.forEach(c=>visibleOwners.add(c.value)); }
                menu.style.display='none'; render();
            };
            actionDiv.appendChild(applyBtn); menu.appendChild(actionDiv);
            menu.style.display='flex';
        }
        
        function toggleDateFilterMenu(e) { 
            e.stopPropagation(); document.getElementById('filter-menu').style.display='none'; document.getElementById('prog-filter-menu').style.display='none';
            const menu = document.getElementById('date-filter-menu');
            if(menu.style.display==='flex'){ menu.style.display='none'; return; }
            
            menu.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'date-filter-container';
            
            const label = document.createElement('div');
            label.style.marginBottom = "4px";
            label.style.fontWeight = "bold";
            label.style.fontSize = "11px";
            label.innerText = "é–‹å§‹æ—¥ä»¥é™ã‚’è¡¨ç¤º:";
            container.appendChild(label);
            
            const inp = document.createElement('input');
            inp.type = "date";
            inp.id = "df-input";
            inp.className = "date-filter-input";
            if(visibleStartDate) inp.value = visibleStartDate;
            container.appendChild(inp);
            menu.appendChild(container);

            const actionDiv = document.createElement('div'); actionDiv.className='filter-actions';
            const applyBtn = document.createElement('button'); applyBtn.className='primary'; applyBtn.innerText="é©ç”¨";
            applyBtn.onclick=()=>{ visibleStartDate=inp.value||null; menu.style.display='none'; render(); };
            const clearBtn = document.createElement('button'); clearBtn.innerText="è§£é™¤";
            clearBtn.onclick=()=>{ visibleStartDate=null; menu.style.display='none'; render(); };
            
            actionDiv.appendChild(applyBtn); actionDiv.appendChild(clearBtn); menu.appendChild(actionDiv);
            menu.style.display='flex';
        }
        
        function toggleProgressFilterMenu(e) { 
            e.stopPropagation(); document.getElementById('filter-menu').style.display='none'; document.getElementById('date-filter-menu').style.display='none';
            const menu = document.getElementById('prog-filter-menu');
            if(menu.style.display==='flex'){ menu.style.display='none'; return; }
            menu.innerHTML = '';
            // åˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯
            const opts = [{v:'incomplete',t:'æœªå®Œäº†'},{v:'complete',t:'å®Œäº† (100%)'}];
            
            const allBtnDiv = document.createElement('div'); allBtnDiv.style.padding="4px"; allBtnDiv.style.borderBottom="1px solid #eee"; allBtnDiv.style.marginBottom="4px"; allBtnDiv.style.display="flex"; allBtnDiv.style.gap="10px"; allBtnDiv.style.justifyContent="center";
            const btnAll = document.createElement('button'); btnAll.innerText="ã™ã¹ã¦"; btnAll.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=true)};
            const btnClear = document.createElement('button'); btnClear.innerText="è§£é™¤"; btnClear.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=false)};
            allBtnDiv.appendChild(btnAll); allBtnDiv.appendChild(btnClear); menu.appendChild(allBtnDiv);

            opts.forEach(o=>{
                const label=document.createElement('label'); const chk=document.createElement('input'); chk.type="checkbox"; chk.value=o.v;
                if(visibleProgress===null||visibleProgress.has(o.v)) chk.checked=true;
                label.appendChild(chk); label.appendChild(document.createTextNode(o.t)); menu.appendChild(label);
            });
            
            const actionDiv = document.createElement('div'); actionDiv.className='filter-actions';
            const applyBtn = document.createElement('button'); applyBtn.className='primary'; applyBtn.innerText="é©ç”¨";
            applyBtn.onclick=()=>{
                const checked=menu.querySelectorAll('input:checked');
                if(checked.length===opts.length) visibleProgress=null;
                else { visibleProgress=new Set(); checked.forEach(c=>visibleProgress.add(c.value)); }
                menu.style.display='none'; render();
            };
            actionDiv.appendChild(applyBtn); menu.appendChild(actionDiv);
            menu.style.display='flex';
        }
        document.addEventListener('click', () => {
             document.querySelectorAll('.filter-menu').forEach(e => e.style.display = 'none');
        });

        const ganttContainer = document.getElementById('gantt-container');
        const wbsBodyContainer = document.getElementById('wbs-body-container');
        ganttContainer.addEventListener('scroll', () => { wbsBodyContainer.scrollTop = ganttContainer.scrollTop; });
        
        render();
        setTimeout(() => {
            const t = document.getElementById('today-target');
            if(t) ganttContainer.scrollLeft = t.offsetLeft - 100;
        }, 200);

    </script>
</body>
</html>