<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å·¥æ•°ç®¡ç†</title>
    <style>
        :root {
            --border: #bcbcbc;
            --header-bg: #f2f2f2;
            --excel-blue: #2f5597;
            --excel-group-bg: #d9d9d9;
            --range-blue: #eaf4ff; 
            --work-blue: #5b9bd5;  
            --today-bg: #fff9c4;    
            --today-col-bg: rgba(255, 249, 196, 0.3);
            --today-line: #ff0000;  
            --row-h: 34px;
            --day-w: 55px; 
            /* å¹…ã‚’ä¿®æ­£: å„åˆ—ã®åˆè¨ˆ(980+155=1135px)ã«åˆã‚ã›ã¦ä½™ç™½ã¨è¦‹åˆ‡ã‚Œã‚’è§£æ¶ˆ */
            --wbs-w: 1120px; /* $$fujita */
            
            /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”¨è‰²å®šç¾© */
            --overload-bg: #ffdddd; 
            --overload-col: #cc0000; 
            
            /* ç¥æ—¥ç”¨ */
            --holiday-col: #ffebec;
            --holiday-text: #dc3545;

            /* ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡Œã®èƒŒæ™¯è‰²ï¼ˆé¦´æŸ“ã‚€è–„ã„ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ï¼‰ */
            --milestone-bg: #f0f8ff;
        }

        * { box-sizing: border-box; }
        body { font-family: "Meiryo", "MS PGothic", sans-serif; margin: 15px; font-size: 12px; background: #f9f9f9; color: #333; overflow: hidden; }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®æ•´ç† */
        .controls { 
            margin-bottom: 10px; 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            white-space: nowrap; 
            flex-wrap: nowrap; 
            position: relative;
            background: #fff;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .controls h2 { margin: 0 12px 0 0; font-size: 14px; color: var(--excel-blue); }
        
        button { padding: 5px 12px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 3px; font-size: 12px; color: #444; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        button:hover { background-color: #f5f5f5; border-color: #999; color: #222; }
        button:disabled { opacity: 0.5; cursor: default; }

        button.primary { background: var(--excel-blue); color: white; border-color: var(--excel-blue); }
        button.primary:hover { background-color: #1e3a6e; border-color: #1e3a6e; color: #fff; }

        /* ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ï¼ˆä¿å­˜ãƒ»èª­è¾¼ãªã©ï¼‰ */
        button.icon-only { padding: 5px 8px; font-size: 14px; }
        
        .separator { width: 1px; height: 18px; background: #ddd; margin: 0 4px; }
        .spacer { margin-left: auto; }

        /* ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .help-btn {
            width: 24px; height: 24px; padding: 0;
            border-radius: 50%; border: 1px solid #999;
            background: #fff; color: #555; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            margin-left: 8px;
        }
        .help-btn:hover { background: #eee; color: #333; border-color: #666; }

        /* ãƒ˜ãƒ«ãƒ—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .help-popup {
            position: absolute;
            top: 45px; right: 0;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            border-radius: 4px;
            z-index: 2000;
            display: none;
            width: 280px;
            text-align: left;
        }
        .help-popup.show { display: block; }
        .help-popup h4 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; font-size: 13px; color: var(--excel-blue); }
        .help-item { margin-bottom: 8px; font-size: 12px; display: flex; align-items: center; gap: 8px; color: #444; }
        .help-icon { width: 20px; text-align: center; font-size: 14px; display: inline-block; }

        .main-container {
            display: flex;
            border: 2px solid #888;
            background: #fff;
            overflow: hidden;
            height: calc(100vh - 80px);
        }

        .wbs-area {
            width: var(--wbs-w);
            flex-shrink: 0;
            border-right: 2px solid #444; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff;
            z-index: 10;
        }

        #wbs-body-container { overflow: hidden; flex-grow: 1; }
        
        #wbs-body { padding-bottom: 20px; }

        .gantt-area {
            flex-grow: 1;
            overflow: auto;
            position: relative;
            background: #fff;
            margin-left: -2px; 
        }

        .row { display: flex; width: 100%; }
        
        .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            height: var(--row-h);
            display: flex;
            align-items: center;
            padding: 0 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: #fff;
        }

        .header { 
            position: sticky; 
            top: 0; 
            z-index: 40; 
            background: var(--header-bg); 
            box-shadow: 0 1px 0 #888; 
        }
        .header .cell { 
            background: var(--header-bg); 
            justify-content: center; 
            border-bottom: 1px solid #888;
        }

        .header .col-owner, 
        .header .col-date, 
        .header .col-progress { overflow: visible !important; position: relative; } 

        /* åˆ—å¹…ã®å®šç¾© */
        .col-no { width: 45px; justify-content: center !important; background: #f0f0f0 !important; font-weight: bold; }
        .col-title { width: 220px; }
        .col-owner { width: 90px; } 
        .col-date { width: 135px; } 

        .col-h { width: 75px; justify-content: center; padding-right: 2px; }
        .col-ratio { width: 55px; justify-content: center; font-size: 11px; }
        .col-progress { width: 75px; justify-content: center; }
        .col-op { width: 140px; justify-content: center; border-right: 2px solid #444 !important; gap: 4px; padding: 0 4px; overflow: visible !important; }

        .day-cell { width: var(--day-w); justify-content: center; padding: 0 !important; position: relative; } 
        .is-today-h { background: var(--today-bg) !important; color: #d97706 !important; font-weight: bold; border-bottom: 1px solid #888 !important; }
        .is-today-col { background-color: var(--today-col-bg) !important; }

        .group-row .cell { background: var(--excel-group-bg) !important; font-weight: bold; }
        .in-range { background: var(--range-blue) !important; }
        
        .sat { color: #007bff; background-color: #e3f2fd; }
        .sun { color: #dc3545; background-color: var(--holiday-col); }
        .holiday { color: var(--holiday-text); background-color: var(--holiday-col); }

        .today-line {
            position: absolute; top: 0; bottom: 0; 
            width: 2px;
            background: var(--today-line); 
            z-index: 5; 
            pointer-events: none;
            opacity: 0.6;
        }
        .milestone-gantt-row .cell { border-bottom: none; }
        .milestone-gantt-row { box-shadow: 0 1px 0 var(--border); }
        .milestone-icon-img { width: 20px; height: 20px; object-fit: contain; display: block; }

        input { width: 100%; border: none; outline: none; background: transparent; font-size: 12px; font-family: inherit; }
        input[type="number"] { text-align: center; }

        .date-display-text { font-size: 12px; padding-left: 2px; color: #333; cursor: default; white-space: nowrap; }
        .date-input { cursor: pointer; text-align: left; width: 100%; }
        
        .hour-input { height: 100%; font-size: 11px; padding-right: 2px !important; width: 100%; color: inherit; cursor: pointer; z-index: 2; position: relative; }

        .icon-btn {
            width: 26px; height: 26px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 4px; border: 1px solid #ccc; transition: all 0.2s; background: #fff; padding: 0; flex-shrink: 0;
        }
        .icon-btn svg { width: 16px; height: 16px; fill: #666; }
        .icon-btn:hover { background: #f0f0f0; border-color: #888; }
        .icon-delete:hover { background: #fee2e2; }
        .icon-delete:hover svg { fill: #dc2626; }
        .icon-timer.start { border-color: #16a34a; }
        .icon-timer.start svg { fill: #16a34a; }
        .icon-timer.stop { border-color: #dc2626; background: #fef2f2; }
        .icon-timer.stop svg { fill: #dc2626; }
        .icon-memo.has-content { border-color: #2f5597; background: #eaf4ff; }
        .icon-memo.has-content svg { fill: #2f5597; }
        .icon-risk.has-risk { border-color: #dc2626; background: #fff1f2; }
        .icon-risk.has-risk svg { fill: #dc2626; }
        .icon-shift-left { border-color: #06b6d4; background: #cffafe; font-size: 16px; color: #0891b2; padding: 0 6px; font-weight: 600; }
        .icon-shift-left:hover { background: #a5f3fc; border-color: #0891b2; }
        .icon-shift-right { border-color: #06b6d4; background: #cffafe; font-size: 16px; color: #0891b2; padding: 0 6px; font-weight: 600; }
        .icon-shift-right:hover { background: #a5f3fc; border-color: #0891b2; }

        .op-menu-wrap { position: relative; display: flex; align-items: center; flex-shrink: 0; }
        .op-menu-dropdown { position: absolute; top: 100%; right: 0; margin-top: 2px; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; min-width: 180px; display: none; padding: 4px 0; }
        .op-menu-dropdown.show { display: block; }
        .op-menu-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; cursor: pointer; font-size: 12px; white-space: nowrap; border: none; background: none; width: 100%; text-align: left; font-family: inherit; color: #333; }
        .op-menu-item:hover { background: #f0f0f0; }
        .op-menu-item .menu-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .op-menu-item .menu-icon svg { width: 14px; height: 14px; fill: currentColor; }
        .icon-btn.icon-more { color: #666; }
        .icon-btn.icon-more svg { width: 14px; height: 14px; fill: currentColor; }

        .tracking-active { background: #fff1f2 !important; }

        .icon-ref {
            font-size: 10px; color: #555; cursor: pointer; 
            width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #ccc; border-radius: 3px; background: #eee; margin-left: 2px;
        }
        .icon-ref:hover { background: #e0f2fe; border-color: var(--work-blue); color: var(--excel-blue); }

        .filter-icon { 
            cursor: pointer; margin-left: 2px; color: #666; font-size: 10px; 
            border: 1px solid #999; border-radius: 3px; padding: 1px 2px; background: #eee; 
            flex-shrink: 0; display: inline-block; line-height: 1; 
        }
        .filter-icon:hover { background: #ddd; }
        .filter-active { background: var(--excel-blue); color: #fff; border-color: var(--excel-blue); }
        
        .filter-menu { 
            position: absolute; top: 100%; left: 0; width: max-content; min-width: 150px; 
            background: #fff; border: 1px solid #999; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); 
            z-index: 1000; display: none; flex-direction: column; padding: 5px; 
            text-align: left; font-weight: normal; max-height: 300px; overflow-y: auto; 
            margin-top: 1px; white-space: nowrap; 
        }
        .col-progress .filter-menu { left: auto; right: 0; } 
        .filter-menu label { display: flex; align-items: center; justify-content: flex-start; gap: 8px; padding: 4px 8px; cursor: pointer; width: 100%; }
        .filter-menu label:hover { background: #f0f0f0; }
        .filter-menu input[type="checkbox"] { margin: 0; width: auto; cursor: pointer; }
        .filter-actions { border-top: 1px solid #ddd; padding-top: 5px; margin-top: 5px; display: flex; justify-content: space-between; }
        .filter-actions button { padding: 3px 8px; font-size: 11px; }

        .date-filter-container { padding: 8px; }
        .date-filter-input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 2px; box-sizing: border-box; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        #memo-modal { z-index: 2000 !important; }
        .modal-content { background: #fff; width: 750px; padding: 25px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-content h3 { margin: 0 0 15px 0; font-size: 16px; color: var(--excel-blue); border-bottom: 2px solid var(--excel-blue); padding-bottom: 8px; }
        .modal-content textarea { width: 100%; height: 350px; margin-bottom: 20px; padding: 12px; font-family: inherit; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; line-height: 1.6; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; }

        /* å®Ÿç¸¾å‚ç…§ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .ref-result-area { height: 180px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; }
        .ref-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .ref-table th { background: #f2f2f2; position: sticky; top: 0; padding: 6px; text-align: left; border-bottom: 1px solid #ccc; }
        .ref-table td { padding: 6px; border-bottom: 1px solid #eee; }
        .ref-table tr:hover { background: #f9f9f9; }
        .ref-summary { display: flex; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; align-items: center; border: 1px solid #ddd; }
        .select-btn { padding: 3px 8px; font-size: 11px; border: 1px solid #999; color: #333; background: #fff; border-radius: 3px; cursor: pointer; }
        .select-btn:hover { background: #eee; }
        .search-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .search-row input { border: 1px solid #ccc; padding: 6px; border-radius: 3px; flex-grow: 1; }
        .search-row select { border: 1px solid #ccc; padding: 6px; border-radius: 3px; min-width: 120px; }
        .ref-adjust-area { background: #fff; padding: 15px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        .adjust-controls { display: flex; align-items: center; gap: 15px; position: relative; height: 40px; }
        .slider-wrapper { position: relative; flex-grow: 1; height: 100%; display: flex; align-items: center; }
        #dist-canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.9; }
        input[type="range"] { width: 100%; margin: 0; position: relative; z-index: 2; cursor: pointer; -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { background: rgba(0,0,0,0.05); height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; background: var(--excel-blue); width: 16px; height: 16px; border-radius: 50%; margin-top: -5px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .adjust-val-box { display: flex; align-items: center; gap: 5px; font-weight: bold; background: #f0f8ff; padding: 5px 10px; border-radius: 4px; border: 1px solid #2f5597; color: #2f5597; z-index: 2; }
        .adjust-val-box input { width: 60px; text-align: right; border: none; font-size: 16px; font-weight: bold; color: #2f5597; outline: none; background: transparent; }
        #dist-info { font-size: 12px; color: #444; background: #f9f9f9; padding: 5px 10px; border-radius: 4px; min-height: 24px; display: flex; align-items: center; border: 1px solid #eee; }
        .dist-highlight { color: #2f5597; font-weight: bold; margin-right: 5px; }
        .ref-checkbox { width: 20px; text-align: center; }
        .ref-checkbox input[type="checkbox"] { width: auto; }
        .ref-table thead tr th:first-child { width: 25px; } 

        .over-limit { background-color: var(--overload-bg) !important; color: var(--overload-col) !important; font-weight: bold; }
        
        /* æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ */
        .status-red { color: #dc2626 !important; font-weight: bold; background-color: #fff0f0; animation: blink-alert 1.2s infinite ease-in-out; }
        .status-yellow { color: #b45309 !important; font-weight: bold; background-color: #fffbeb; }
        @keyframes blink-alert { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .report-table th, .report-table td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
        .report-table th { background: #f2f2f2; font-weight: bold; text-align: center; }
        .report-table .num-cell { text-align: right; }
        .report-over-limit { background-color: var(--overload-bg); color: var(--overload-col); font-weight: bold; }
        .report-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }

        /* ã‚·ãƒ•ãƒˆæ©Ÿèƒ½ç”¨ */
        .settings-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .settings-row label { width: 120px; text-align: right; font-weight: bold; }
        .settings-row input, .settings-row select { border: 1px solid #ccc; padding: 4px; border-radius: 3px; width: 200px; background: #fff; }

        /* ãƒªã‚¹ã‚¯ç®¡ç†ç”¨ */
        .risk-list-container { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 8px; margin-bottom: 10px; }
        .risk-category { margin-bottom: 15px; }
        .risk-category-header { font-weight: bold; font-size: 13px; color: var(--excel-blue); border-bottom: 1px solid #ddd; padding-bottom: 3px; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .risk-category-header .edit-cat-btn { cursor: pointer; color: #888; font-size: 12px; }
        .risk-category-header .edit-cat-btn:hover { color: #2f5597; }
        
        .risk-item { 
            border-bottom: 1px solid #eee; padding: 6px 0; 
            display: flex; flex-direction: column; gap: 4px;
        }
        .risk-item:last-child { border-bottom: none; }
        
        .risk-row-main {
            display: flex; align-items: center; gap: 8px; width: 100%;
        }
        .risk-row-main input[type="text"] {
            flex-grow: 1; border: 1px solid transparent; border-radius: 3px; padding: 4px;
            background: transparent; transition: all 0.2s; cursor: pointer; text-align: left;
        }
        .risk-row-main input[type="text"]:focus,
        .risk-row-main input[type="text"]:hover {
            border-color: #ccc; background: #fff; cursor: text;
        }
        
        .risk-mitigation-box {
            margin-left: 24px; padding: 4px 8px;
            background: #f9f9f9; border-radius: 4px; border: 1px solid #eee;
            display: none; align-items: center; gap: 6px;
        }
        .risk-mitigation-box.active { display: flex; }
        .risk-mitigation-box input {
            border: 1px solid #ccc; padding: 4px; border-radius: 3px;
            flex-grow: 1; text-align: left; background: #fff;
        }
        .risk-history-btn {
            background: #eaf4ff; border: 1px solid #b3d7ff; color: #2f5597;
            border-radius: 3px; cursor: pointer; font-size: 14px; padding: 2px 6px;
            display: flex; align-items: center; justify-content: center;
        }
        .risk-history-btn:hover { background: #d0e7ff; }
        .risk-label { font-size: 11px; color: #555; font-weight: bold; white-space: nowrap; }

        .add-risk-row { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .add-risk-row input { border: 1px solid #ccc; padding: 5px; border-radius: 3px; flex-grow: 1; text-align: left; }
        .add-risk-row input[list] { width: 140px; flex-grow: 0; }

        /* å±¥æ­´é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .history-popup {
            position: absolute; background: #fff; border: 1px solid #999; box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            z-index: 3000; max-height: 200px; overflow-y: auto; min-width: 250px; padding: 5px 0; border-radius: 3px;
            display: none; text-align: left;
        }
        .history-item {
            padding: 6px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #eee;
        }
        .history-item:hover { background: #f0f8ff; }
        .history-item:last-child { border-bottom: none; }

    </style>
</head>
<body>

    <div class="controls">
        <h2>å·¥æ•°ç®¡ç†</h2>
        
        <!-- ãƒ¡ã‚¤ãƒ³æ“ä½œ -->
        <button class="primary" onclick="addTask()">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
        
        <div class="separator"></div>
        
        <!-- ç·¨é›†ãƒ»æ“ä½œ -->
        <button onclick="openShiftModal()">â© ã‚·ãƒ•ãƒˆ</button>
        <button onclick="addMilestone()">ğŸ¯ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</button>
        <button onclick="undo()" id="btn-undo" disabled>ğŸ”™ å…ƒã«æˆ»ã™</button>

        <div class="separator"></div>

        <!-- åˆ†æãƒ»å‡ºåŠ› -->
        <button onclick="openAnalyze()">ğŸ“ˆ åˆ†æ</button>
        <button onclick="openReport()">ğŸ“Š æ—¥å ±</button>

        <!-- å³å¯„ã›ã‚¨ãƒªã‚¢ (ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ»ãƒ˜ãƒ«ãƒ—) -->
        <div class="spacer"></div>
        <div style="display:flex; gap:6px; align-items:center;">
            <span id="tracker-status" style="margin-right:15px; font-weight:bold; color:#dc2626;"></span>
            
            <button class="icon-only" onclick="downloadJSON()" title="ä¿å­˜ (JSON)">ğŸ“¥</button>
            <button class="icon-only" onclick="document.getElementById('fileIn').click()" title="èª­è¾¼ (JSON)">ğŸ“¤</button>
            <button class="icon-only" onclick="downloadCSV()" title="CSVå‡ºåŠ›" style="font-size:12px;">ğŸ“Š CSV</button>
            
            <button class="help-btn" onclick="toggleHelp(event)" title="ä½¿ã„æ–¹">?</button>
        </div>

        <input type="file" id="fileIn" style="display:none" accept=".json" onchange="uploadJSON(event)">
        
        <!-- ãƒ˜ãƒ«ãƒ—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="help-popup" class="help-popup" onclick="event.stopPropagation()">
            <h4>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h4>
            <div class="help-item"><b>åŸºæœ¬:</b> å³å´ã®æ—¥ä»˜åˆ—ã«æ—¥ã€…ã®å·¥æ•°(h)ã‚’å…¥åŠ›</div>
            <div class="help-item"><span class="help-icon">ğŸ“</span>ã‚°ãƒ«ãƒ¼ãƒ—åŒ– (ã‚¿ã‚¹ã‚¯ã‚’ã¾ã¨ã‚ã‚‹)</div>
            <div class="help-item"><span class="help-icon">ğŸ“„</span>ãƒ¡ãƒ¢ (è©³ç´°æƒ…å ±ã‚’è¨˜éŒ²)</div>
            <div class="help-item"><span class="help-icon">âš </span>ãƒªã‚¹ã‚¯ (æ‡¸å¿µäº‹é …ã¨äºˆé˜²ç­–)</div>
            <div class="help-item"><span class="help-icon">â–¶</span>ã‚¿ã‚¤ãƒãƒ¼ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆæ¸¬)</div>
            <div class="help-item"><span class="help-icon">ğŸ”</span>å®Ÿç¸¾å‚ç…§ (éå»ã®ä¼¼ãŸã‚¿ã‚¹ã‚¯ã‹ã‚‰è¦‹ç©)</div>
            <div class="help-item"><span class="help-icon">ğŸ¯</span>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ (é‡è¦æ—¥ç¨‹ã®ç®¡ç†)</div>
            <div class="help-item" style="color:var(--overload-col); font-weight:bold;"><span class="help-icon">â– </span>éè² è· (>8h/æ—¥ ã¯èµ¤ãè¡¨ç¤º)</div>
        </div>
    </div>

    <div class="main-container">
        <div class="wbs-area">
            <div class="header row">
                <div class="cell col-no">No</div>
                <div class="cell col-title">ã‚¿ã‚¹ã‚¯</div>
                <div class="cell col-owner">
                    æ‹…å½“ <span id="filter-btn" class="filter-icon" onclick="toggleFilterMenu(event)">â–¼</span>
                    <div id="filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-date">
                    é–‹å§‹æ—¥ <span id="date-filter-btn" class="filter-icon" onclick="toggleDateFilterMenu(event)">â–¼</span>
                    <div id="date-filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-date">æœŸé™</div>
                <div class="cell col-h">è¦‹ç©(h)</div>
                <div class="cell col-h">åˆè¨ˆ(h)</div>
                <div class="cell col-h">æ®‹ã‚Š(h)</div>
                <div class="cell col-ratio">è¦‹ç©æ¯”</div>
                <div class="cell col-progress">
                    é€²æ— <span id="prog-filter-btn" class="filter-icon" onclick="toggleProgressFilterMenu(event)">â–¼</span>
                    <div id="prog-filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-op">æ“ä½œ</div>
            </div>
            <div id="wbs-body-container">
                <div id="wbs-body"></div>
            </div>
        </div>
        <div class="gantt-area" id="gantt-container">
            <div id="gantt-grid" class="gantt-grid">
                <div id="gantt-header" class="header row"></div>
                <div id="gantt-body" style="position:relative;"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒ¢ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="memo-modal" class="modal-overlay">
        <div class="modal-content" style="width: 650px;">
            <h3 id="memo-title">ãƒ¡ãƒ¢</h3>
            <textarea id="memo-text" placeholder="è©³ç´°ãªãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            <div class="modal-btns">
                <button onclick="closeMemo()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="btn-save-memo" class="primary" onclick="saveMemo()">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒªã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="risk-modal" class="modal-overlay">
        <div class="modal-content" style="width: 600px;">
            <h3>ãƒªã‚¹ã‚¯ç®¡ç†</h3>
            <div style="font-size:11px; color:#555; margin-bottom:8px;">
                â€» ãƒªã‚¹ã‚¯é …ç›®ã®ãƒã‚§ãƒƒã‚¯ã§äºˆé˜²ç­–ã‚’å…¥åŠ›å¯èƒ½ã€‚<br>
                â€» äºˆé˜²ç­–æ¬„ã®æ¨ªã®æ™‚è¨ˆã‚¢ã‚¤ã‚³ãƒ³ã§ã€éå»ã®å…¥åŠ›å±¥æ­´ã‚’å‚ç…§ã§ãã¾ã™ã€‚
            </div>
            <div class="risk-list-container" id="risk-list"></div>
            <div class="add-risk-row">
                <input list="category-list" id="new-risk-category" placeholder="ã‚«ãƒ†ã‚´ãƒªé¸æŠ/å…¥åŠ›...">
                <datalist id="category-list">
                    <option value="è¦ä»¶ãƒ»ä»•æ§˜">
                    <option value="æŠ€è¡“ãƒ»é–‹ç™º">
                    <option value="ãƒªã‚½ãƒ¼ã‚¹ãƒ»ä½“åˆ¶">
                    <option value="å¤–éƒ¨è¦å› ">
                    <option value="ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«">
                    <option value="ãã®ä»–">
                </datalist>
                <input type="text" id="new-risk-input" placeholder="æ–°ã—ã„ãƒªã‚¹ã‚¯ã‚’è¿½åŠ ...">
                <button class="primary" onclick="addCustomRisk()">è¿½åŠ </button>
            </div>
            <div class="modal-btns" style="margin-top: 15px;">
                <button onclick="document.getElementById('risk-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="primary" onclick="saveTaskRisks()">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
        <div id="history-popup" class="history-popup"></div>
    </div>

    <!-- å®Ÿç¸¾å‚ç…§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ref-modal" class="modal-overlay">
        <div class="modal-content" style="width: 750px;">
            <h3>éå»å®Ÿç¸¾ã®å‚ç…§</h3>
            <div class="search-row">
                <input type="text" id="ref-search-key" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ANDæ¤œç´¢)..." oninput="searchRef()">
                <select id="ref-search-owner" onchange="searchRef()">
                    <option value="">(å…¨æ‹…å½“è€…)</option>
                </select>
                <select id="ref-search-status" onchange="searchRef()">
                    <option value="">(å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)</option>
                    <option value="complete">å®Œäº†ã®ã¿ (100%)</option>
                    <option value="incomplete">æœªå®Œäº†ã®ã¿</option>
                </select>
            </div>
            
            <div class="ref-summary" id="ref-summary-area" style="display:none;">
                <span><b>çµæœ:</b> <span id="ref-count">0</span>ä»¶</span> | 
                <span>å¹³å‡: <b id="ref-avg">0.0</b>h</span> <button class="select-btn" onclick="selectRefVal('avg')">å¹³å‡ã‚’é¸æŠ</button> |
                <span>æœ€å¤§: <b id="ref-max">0.0</b>h</span> <button class="select-btn" onclick="selectRefVal('max')">æœ€å¤§ã‚’é¸æŠ</button>
            </div>

            <div class="ref-result-area">
                <table class="ref-table">
                    <thead>
                        <tr>
                            <th style="width:25px;"><input type="checkbox" id="select-all-ref" onchange="toggleSelectAll(this.checked)"></th>
                            <th style="width:130px;">è¦ªã‚¿ã‚¹ã‚¯</th>
                            <th>ã‚¿ã‚¹ã‚¯å</th>
                            <th style="width:50px; text-align:center;">ãƒ¡ãƒ¢</th>
                            <th style="width:70px;">æ‹…å½“</th>
                            <th style="width:50px;">å®Ÿç¸¾</th>
                            <th style="width:40px;">é€²æ—</th>
                            <th style="width:60px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="ref-table-body"></tbody>
                </table>
            </div>

            <div class="ref-adjust-area">
                <div style="font-weight:bold; font-size:12px; color:#2f5597; margin-bottom:0px;">
                    â–¼ è¦‹ç©å·¥æ•°ã®èª¿æ•´ãƒ»æ±ºå®š (èƒŒæ™¯åˆ†å¸ƒ: <span style="color:rgba(47, 85, 151, 0.6)">â– å®Ÿç¸¾æ•°</span> <span style="color:red; font-weight:bold;">: å¹³å‡</span>)
                </div>
                <div class="adjust-controls">
                    <div class="adjust-val-box">
                        <input type="number" id="adjust-num" value="0" min="0" step="0.1" oninput="syncSlider(this.value)"> h
                    </div>
                    <div class="slider-wrapper" id="slider-wrapper">
                        <canvas id="dist-canvas"></canvas>
                        <input type="range" id="adjust-slider" min="0" max="20" step="0.1" value="0" oninput="syncNum(this.value)">
                    </div>
                    <button class="primary" onclick="applyRefAdjusted()">æ±ºå®š</button>
                </div>
                <div id="dist-info">â†‘ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã™ã¨ã€ãã®å€¤ã«è¿‘ã„éå»å®Ÿç¸¾ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>

            <div class="modal-btns">
                <button onclick="closeRef()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="milestone-modal" class="modal-overlay">
        <div class="modal-content" style="width: 600px;">
            <h3>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†</h3>
            <div style="margin-bottom: 15px;">
                <input type="text" id="milestone-name" placeholder="ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å" style="border: 1px solid #ccc; padding: 6px; border-radius: 1px; width: 300px; margin-right: 10px;">
                <input type="date" id="milestone-date" style="border: 1px solid #ccc; padding: 6px; border-radius: 1px; margin-right: 10px;">
                <button class="primary" onclick="saveMilestone()">è¿½åŠ </button>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background: #f2f2f2;">
                        <th style="border: 1px solid #ccc; padding: 6px;">åå‰</th>
                        <th style="width: 120px; border: 1px solid #ccc; padding: 6px;">æ—¥ä»˜</th>
                        <th style="width: 60px; border: 1px solid #ccc; padding: 6px; text-align: center;">å®Œäº†</th>
                        <th style="width: 60px; border: 1px solid #ccc; padding: 6px; text-align: center;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="milestone-list"></tbody>
            </table>
            <div class="modal-btns">
                <button onclick="document.getElementById('milestone-modal').style.display='none'">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="shift-modal" class="modal-overlay">
        <div class="modal-content" style="width: 450px;">
            <h3>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€æ‹¬ã‚·ãƒ•ãƒˆ (å–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹)</h3>
            <p style="margin-bottom:15px; font-size:11px; color:#555;">é¸æŠã—ãŸè¦ªã‚¿ã‚¹ã‚¯é…ä¸‹ã®ã€Œæœªå®Œäº†ã‚¿ã‚¹ã‚¯ã€ã®æ—¥ä»˜ã‚’ã€<br>åœŸæ—¥ç¥æ—¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚·ãƒ•ãƒˆã—ã¾ã™ã€‚</p>
            <div class="settings-row">
                <label>è¦ªã‚¿ã‚¹ã‚¯(å¯¾è±¡):</label>
                <select id="shift-target-group"></select>
            </div>
            <div class="settings-row">
                <label>ã‚·ãƒ•ãƒˆæ—¥æ•°:</label>
                <input type="number" id="shift-days" value="0" placeholder="ä¾‹: 7 (1é€±é–“) ã¾ãŸã¯ -1">
            </div>
            <div class="modal-btns">
                <button onclick="document.getElementById('shift-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="primary" onclick="applyShift()">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div id="analyze-modal" class="modal-overlay">
        <div class="modal-content" style="width: 950px; height: 95%; display:flex; flex-direction:column; overflow:hidden;">
            <h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
            <div style="display:flex; gap:15px; align-items:center; background:#f0f0f0; padding:10px; margin-bottom:10px;">
                <label>æœŸé–“: <input type="date" id="ana-start" onchange="renderCharts()"> ï½ <input type="date" id="ana-end" onchange="renderCharts()"></label>
                <label>åˆ†æå¯¾è±¡: <select id="ana-target" onchange="renderCharts()"><option value="">(å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)</option></select></label>
            </div>
            <div style="flex-grow: 1; overflow-y: auto; padding: 10px; background:#f5f5f5;">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4>äºˆå®Ÿæ¯”è¼ƒ (h)</h4>
                        <div id="chart-compare-container" style="overflow-x:auto;"><canvas id="chart-bar-compare"></canvas></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4>æ‹…å½“è€…åˆ¥ å†…è¨³ (h)</h4>
                        <canvas id="chart-pie-owner" style="height: 250px; width:100%;"></canvas>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <h4>æ—¥åˆ¥æ¨ç§» (h)</h4>
                        <canvas id="chart-bar-daily" style="height: 300px; width:100%;"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-btns"><button onclick="document.getElementById('analyze-modal').style.display='none'">é–‰ã˜ã‚‹</button></div>
        </div>
    </div>
    
    <!-- æ—¥å ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="report-modal" class="modal-overlay">
        <div class="modal-content" style="width: 800px; height: 80%; display:flex; flex-direction:column;">
            <h3>æ‹…å½“è€…åˆ¥ãƒ»æ—¥æ¬¡å®Ÿç¸¾é›†è¨ˆ</h3>
            <div class="report-controls">
                <label>å¯¾è±¡æœˆ: <input type="month" id="report-month" onchange="renderReportContent()"></label>
                <button onclick="copyReportToClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div style="flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="width:100px;">æ—¥ä»˜</th>
                            <th style="width:100px;">æ‹…å½“è€…</th>
                            <th>ã‚¿ã‚¹ã‚¯å†…è¨³</th>
                            <th style="width:60px;">åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="report-body"></tbody>
                </table>
            </div>
            <div class="modal-btns" style="margin-top:15px;">
                <button onclick="document.getElementById('report-modal').style.display='none'">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- åˆæœŸè¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        function getStorageKey() { return `workload-mgmt-evo-v6-final`; }
        
        let tasks = JSON.parse(localStorage.getItem(getStorageKey())) || [
            { id: 1, title: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹', owner: '', start: getLocalDateStr(), end: getLocalDateStr(), est: 0, progress: 0, isGroup: true, hours: {}, memo: "", risks: [] }
        ];
        
        let milestones = JSON.parse(localStorage.getItem(getStorageKey() + '-milestones')) || [];
        
        // ãƒªã‚¹ã‚¯ãƒã‚¹ã‚¿ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªå¯¾å¿œç‰ˆï¼‰
        // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ­ã‚¸ãƒƒã‚¯ï¼šå¤ã„å½¢å¼(æ–‡å­—åˆ—é…åˆ—)ãªã‚‰å¤‰æ›ã™ã‚‹
        let loadedRisks = JSON.parse(localStorage.getItem(getStorageKey() + '-master-risks'));
        let masterRisks = [];
        
        if (!loadedRisks) {
            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å……å®Ÿã•ã›ã‚‹
            masterRisks = [
                { category: "è¦ä»¶ãƒ»ä»•æ§˜", title: "ä»•æ§˜å¤‰æ›´ã®å¯èƒ½æ€§ãŒé«˜ã„" },
                { category: "è¦ä»¶ãƒ»ä»•æ§˜", title: "è¦ä»¶ãŒæœªç¢ºå®šãƒ»æ›–æ˜§" },
                { category: "è¦ä»¶ãƒ»ä»•æ§˜", title: "ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼é–“ã®åˆæ„å½¢æˆã«æ™‚é–“ãŒã‹ã‹ã‚‹" },
                { category: "æŠ€è¡“ãƒ»é–‹ç™º", title: "æŠ€è¡“çš„ãªé›£æ˜“åº¦ãŒé«˜ã„" },
                { category: "æŠ€è¡“ãƒ»é–‹ç™º", title: "æœªçµŒé¨“ã®æŠ€è¡“ãƒ»ãƒ„ãƒ¼ãƒ«ã‚’æ¡ç”¨" },
                { category: "æŠ€è¡“ãƒ»é–‹ç™º", title: "æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºã«æ‡¸å¿µã‚ã‚Š" },
                { category: "æŠ€è¡“ãƒ»é–‹ç™º", title: "é–‹ç™ºç’°å¢ƒãƒ»æ¤œè¨¼ç’°å¢ƒã®æ§‹ç¯‰ã«æ‰‹é–“å–ã‚‹" },
                { category: "ãƒªã‚½ãƒ¼ã‚¹ãƒ»ä½“åˆ¶", title: "ãƒªã‚½ãƒ¼ã‚¹ï¼ˆè¦å“¡ï¼‰ä¸è¶³ã®æ‡¸å¿µ" },
                { category: "ãƒªã‚½ãƒ¼ã‚¹ãƒ»ä½“åˆ¶", title: "ã‚­ãƒ¼ãƒãƒ³ï¼ˆæœ‰è­˜è€…ï¼‰ã®ç¨¼åƒç¢ºä¿ãŒå›°é›£" },
                { category: "ãƒªã‚½ãƒ¼ã‚¹ãƒ»ä½“åˆ¶", title: "ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¹ã‚­ãƒ«ä¸è¶³" },
                { category: "å¤–éƒ¨è¦å› ", title: "å¤–éƒ¨é€£æºã‚·ã‚¹ãƒ†ãƒ ã®é–‹ç™ºé…å»¶" },
                { category: "å¤–éƒ¨è¦å› ", title: "å¤–éƒ¨ãƒ™ãƒ³ãƒ€ãƒ¼ã®ç´å“é…å»¶" },
                { category: "å¤–éƒ¨è¦å› ", title: "APIä»•æ§˜ã®å¤‰æ›´ãƒ»ä¸å…·åˆ" },
                { category: "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«", title: "è¦‹ç©ã‚‚ã‚Šã®ä¸ç¢ºå®Ÿæ€§ãŒé«˜ã„" },
                { category: "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«", title: "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¨­å®šãŒå³ã—ã„" }
            ];
        } else if (loadedRisks.length > 0 && typeof loadedRisks[0] === 'string') {
            // æ—§å½¢å¼ã‹ã‚‰ã®ç§»è¡Œ
            masterRisks = loadedRisks.map(r => ({ category: "ä¸€èˆ¬", title: r }));
        } else {
            masterRisks = loadedRisks;
        }

        // Undoå±¥æ­´
        const historyStack = [];
        const MAX_HISTORY = 20;

        let trackingId = null, trackingStartTime = null, timerInterval = null;
        let dragIdx = null, currentMemoId = null, currentRefTaskId = null, currentRefResults = [];
        let activeRiskTaskId = null; // ãƒªã‚¹ã‚¯ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ID
        let visibleOwners = null, visibleProgress = null, visibleStartDate = null; 
        let dailyLoadMap = {};
        const OVERLOAD_LIMIT = 8; 
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼çŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•°
        let activeMenuTaskId = null;

        // ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
        const ICON_GROUP = `<svg viewBox="0 0 24 24"><path d="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z"/></svg>`;
        const ICON_DELETE = `<svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>`;
        const ICON_START = `<svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>`;
        const ICON_STOP = `<svg viewBox="0 0 24 24"><path d="M18,18H6V6H18V18Z"/></svg>`;
        const ICON_MEMO = `<svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13,9V3.5L18.5,9H13Z"/></svg>`;
        const ICON_COPY = `<svg viewBox="0 0 24 24"><path d="M16,1H4C2.9,1,2,1.9,2,3V17H4V3H16V1M19,5H8C6.9,5,6,5.9,6,7V21C6,22.1,6.9,23,8,23H19C20.1,23,21,22.1,21,21V7C21,5.9,20.1,5,19,5M19,21H8V7H19V21Z"/></svg>`;
        const ICON_SHIFT_LEFT = `âª`;
        const ICON_SHIFT_RIGHT = `â©`;
        const ICON_ELLIPSIS = `<svg viewBox="0 0 24 24"><circle cx="12" cy="6" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="12" cy="18" r="1.5" fill="currentColor"/></svg>`;
        const ICON_RISK = `<svg viewBox="0 0 24 24"><path d="M1,21H23L12,2L1,21M13,18H11V16H13V18M13,14H11V10H13V14Z"/></svg>`;

        // --- ç¥æ—¥è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ) ---
        function getHolidayName(dateStr) {
            const d = new Date(dateStr);
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const w = d.getDay();
            
            if (m==1 && day==1) return "å…ƒæ—¥";
            if (m==2 && day==11) return "å»ºå›½è¨˜å¿µã®æ—¥";
            if (m==2 && day==23) return "å¤©çš‡èª•ç”Ÿæ—¥";
            if (m==4 && day==29) return "æ˜­å’Œã®æ—¥";
            if (m==5 && day==3) return "æ†²æ³•è¨˜å¿µæ—¥";
            if (m==5 && day==4) return "ã¿ã©ã‚Šã®æ—¥";
            if (m==5 && day==5) return "ã“ã©ã‚‚ã®æ—¥";
            if (m==8 && day==11) return "å±±ã®æ—¥";
            if (m==11 && day==3) return "æ–‡åŒ–ã®æ—¥";
            if (m==11 && day==23) return "å‹¤åŠ´æ„Ÿè¬ã®æ—¥";

            function isHappyMonday(month, n) { return m === month && w === 1 && Math.ceil(day / 7) === n; }
            if (isHappyMonday(1, 2)) return "æˆäººã®æ—¥";
            if (isHappyMonday(7, 3)) return "æµ·ã®æ—¥";
            if (isHappyMonday(9, 3)) return "æ•¬è€ã®æ—¥";
            if (isHappyMonday(10, 2)) return "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥";

            const vernal = Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
            const autumnal = Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
            if (m == 3 && day == vernal) return "æ˜¥åˆ†ã®æ—¥";
            if (m == 9 && day == autumnal) return "ç§‹åˆ†ã®æ—¥";

            const prev = new Date(d); prev.setDate(day - 1);
            if (w === 1 && getHolidayName(prev.toISOString().split('T')[0])) return "æŒ¯æ›¿ä¼‘æ—¥";
            return null;
        }

        // å–¶æ¥­æ—¥åˆ¤å®š (åœŸæ—¥ç¥ã¯false)
        function isBusinessDay(date) {
            const d = date.getDay();
            if (d === 0 || d === 6) return false; // æ—¥ãƒ»åœŸ
            const dateStr = date.toLocaleDateString('sv-SE');
            if (getHolidayName(dateStr)) return false; // ç¥æ—¥
            return true;
        }

        // å–¶æ¥­æ—¥åŠ ç®—ãƒ»æ¸›ç®—
        function addBusinessDays(startStr, daysToAdd) {
            if (!startStr) return "";
            let date = new Date(startStr);
            let added = 0;
            const direction = daysToAdd > 0 ? 1 : -1;
            const target = Math.abs(daysToAdd);

            while (added < target) {
                date.setDate(date.getDate() + direction);
                if (isBusinessDay(date)) {
                    added++;
                }
            }
            return date.toLocaleDateString('sv-SE');
        }

        function getLocalDateStr() { return new Date().toLocaleDateString('sv-SE'); }
        function formatDateForDisplay(d) { return d ? d.replace(/-/g, '/') : ""; }

        // --- Undoæ©Ÿèƒ½ ---
        function pushHistory() {
            if (historyStack.length >= MAX_HISTORY) historyStack.shift();
            historyStack.push(JSON.stringify(tasks));
            document.getElementById('btn-undo').disabled = false;
        }
        function undo() {
            if (historyStack.length === 0) return;
            const prev = historyStack.pop();
            tasks = JSON.parse(prev);
            render();
            if (historyStack.length === 0) document.getElementById('btn-undo').disabled = true;
        }
        function saveState() {
            pushHistory();
            localStorage.setItem(getStorageKey(), JSON.stringify(tasks));
        }

        // --- ãƒ¡ã‚¤ãƒ³æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        function updateLogic() {
            let major = 0, minor = 0;
            tasks.forEach(t => {
                // risksé…åˆ—ãŒãªã„å¤ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã¸ã®å¯¾å¿œ & ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                if (!t.risks) t.risks = [];
                // æ–‡å­—åˆ—é…åˆ—ã ã£ãŸå ´åˆã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã«å¤‰æ›
                if (t.risks.length > 0 && typeof t.risks[0] === 'string') {
                    t.risks = t.risks.map(r => ({ title: r, mitigation: "" }));
                }

                if (t.isGroup) { major++; minor = 0; t.no = major.toString(); }
                else { minor++; t.no = major === 0 ? minor.toString() : `${major}.${minor}`; }
            });
            for (let i = 0; i < tasks.length; i++) {
                let tEst = 0, tSum = 0, weightedProg = 0, minS = null, maxE = null, hasChild = false;
                if (tasks[i].isGroup) {
                    for (let j = i + 1; j < tasks.length; j++) {
                        if (tasks[j].isGroup) break;
                        hasChild = true;
                        let child = tasks[j];
                        let childSum = Object.values(child.hours).reduce((a, b) => a + Number(b), 0);
                        tEst += Number(child.est || 0);
                        tSum += childSum;
                        weightedProg += (Number(child.progress || 0) * Number(child.est || 0));
                        if (child.start && (!minS || child.start < minS)) minS = child.start;
                        if (child.end && (!maxE || child.end > maxE)) maxE = child.end;
                    }
                    if (hasChild) {
                        tasks[i].est = tEst;
                        if(minS) tasks[i].start = minS;
                        if(maxE) tasks[i].end = maxE;
                        tasks[i].progress = tEst > 0 ? Math.round(weightedProg / tEst) : 0;
                        tasks[i].computedSum = tSum;
                    } else { tasks[i].computedSum = Object.values(tasks[i].hours).reduce((a, b) => a + Number(b), 0); }
                } else { tasks[i].computedSum = Object.values(tasks[i].hours).reduce((a, b) => a + Number(b), 0); }
            }
            dailyLoadMap = {};
            tasks.forEach(t => {
                if (!t.isGroup && t.owner) {
                    const owner = t.owner;
                    if (!dailyLoadMap[owner]) dailyLoadMap[owner] = {};
                    Object.keys(t.hours).forEach(date => {
                        const val = parseFloat(t.hours[date]);
                        if (!isNaN(val)) dailyLoadMap[owner][date] = (dailyLoadMap[owner][date] || 0) + val;
                    });
                }
            });
        }

        function render() {
            updateLogic();
            localStorage.setItem(getStorageKey(), JSON.stringify(tasks));
            const wbsBody = document.getElementById('wbs-body');
            const ganttHead = document.getElementById('gantt-header');
            const ganttBody = document.getElementById('gantt-body');
            wbsBody.innerHTML = ganttHead.innerHTML = ganttBody.innerHTML = "";

            const todayStr = getLocalDateStr();
            const todayObj = new Date(todayStr);
            const allDates = tasks.flatMap(t => [new Date(t.start), new Date(t.end)]);
            let minD = new Date(Math.min(...allDates, todayObj));
            minD.setDate(minD.getDate() - 5);
            let maxD = new Date(todayObj.getFullYear(), todayObj.getMonth() + 2, 3); // 3æœˆ3æ—¥ã¾ã§ç¢ºå®Ÿã«å«ã‚€

            const dateList = [];
            for (let d = new Date(minD); d <= maxD; d.setDate(d.getDate() + 1)) {
                const curStr = d.toLocaleDateString('sv-SE');
                const holiday = getHolidayName(curStr);
                dateList.push({ str: curStr, label: `${d.getMonth()+1}/${d.getDate()}`, w: d.getDay(), isToday: curStr === todayStr, holiday: holiday });
            }

            dateList.forEach(d => {
                const isHoliday = d.w === 0 || d.holiday;
                const classNames = `cell day-cell ${d.w===6?'sat':''} ${isHoliday?'sun holiday':''} ${d.isToday?'is-today-h':''}`;
                const h = document.createElement('div');
                h.className = classNames;
                if(d.isToday) h.id = "today-target";
                h.innerText = d.label;
                if(d.holiday) h.title = d.holiday;
                ganttHead.appendChild(h);
            });

            const todayIdx = dateList.findIndex(d => d.isToday);
            if (todayIdx !== -1) {
                const line = document.createElement('div');
                line.className = 'today-line';
                line.style.left = (todayIdx * 55) + 'px'; 
                ganttBody.appendChild(line);
            }

            const visibleIndices = new Set();
            tasks.forEach((t, i) => {
                let ownerOk = visibleOwners ? visibleOwners.has(t.owner || "") : true;
                let progOk = visibleProgress ? visibleProgress.has((Number(t.progress)>=100)?'complete':'incomplete') : true;
                let dateOk = visibleStartDate ? (!t.start || t.start >= visibleStartDate) : true;
                if (t.isGroup) visibleIndices.add(i); 
                else if (ownerOk && progOk && dateOk) visibleIndices.add(i);
            });

            tasks.forEach((t, idx) => {
                if (!t.isGroup && !visibleIndices.has(idx)) return;
                
                const isTracking = trackingId === t.id;
                const remain = (Number(t.est || 0) - t.computedSum).toFixed(1);
                
                const getDateAlert = (f, val) => {
                    if (f !== 'end' || !val) return "";
                    if (Number(t.progress) >= 100) return "";
                    if (val <= todayStr) return "status-red";
                    
                    // 3å–¶æ¥­æ—¥ä»¥å†…åˆ¤å®š
                    let bDays = 0;
                    let checkDate = new Date(todayStr);
                    checkDate.setDate(checkDate.getDate() + 1);
                    const targetDate = new Date(val);
                    
                    const simpleDiff = (targetDate - new Date(todayStr)) / 86400000;
                    if(simpleDiff > 14) return "";

                    while (checkDate <= targetDate) {
                        if (isBusinessDay(checkDate)) {
                            bDays++;
                        }
                        if (bDays > 3) return ""; 
                        checkDate.setDate(checkDate.getDate() + 1);
                    }
                    return "status-yellow";
                };

                const wRow = document.createElement('div');
                wRow.className = 'row' + (t.isGroup ? ' group-row' : '') + (isTracking ? ' tracking-active' : '');
                wRow.draggable = true;
                wRow.ondragstart = () => dragIdx = idx;
                wRow.ondragover = (e) => e.preventDefault();
                wRow.ondrop = () => { 
                    saveState();
                    const move = tasks.splice(dragIdx, 1)[0]; 
                    tasks.splice(idx, 0, move); 
                    render(); 
                };

                const startDateVal = t.isGroup ? formatDateForDisplay(t.start) : (t.start || "");
                const endDateVal = t.isGroup ? formatDateForDisplay(t.end) : (t.end || "");

                wRow.innerHTML = `
                    <div class="cell col-no">${t.no}</div>
                    <div class="cell col-title" style="padding-left:${t.isGroup?'4px':'20px'}"><input value="${t.title}" onchange="upd(${t.id},'title',this.value)"></div>
                    <div class="cell col-owner"><input value="${t.owner}" onchange="upd(${t.id},'owner',this.value)" ${t.isGroup?'readonly':''}></div>
                    <div class="cell col-date"><input type="${t.isGroup?'text':'date'}" class="date-input" value="${startDateVal}" onchange="upd(${t.id},'start',this.value)" ${t.isGroup?'readonly':''}></div>
                    <div class="cell col-date"><input type="${t.isGroup?'text':'date'}" class="date-input ${getDateAlert('end',t.end)}" value="${endDateVal}" onchange="upd(${t.id},'end',this.value)" ${t.isGroup?'readonly':''}></div>
                    <div class="cell col-h"><input type="number" min="0" step="0.1" value="${Number(t.est).toFixed(1)}" onchange="upd(${t.id},'est',this.value)" ${t.isGroup?'readonly':''}>${!t.isGroup?`<div class="icon-ref" onclick="openRef(${t.id})" title="å®Ÿç¸¾å‚ç…§">ğŸ”</div>`:''}</div>
                    <div class="cell col-h center" style="font-weight:bold">${t.computedSum.toFixed(1)}</div>
                    <div class="cell col-h center" style="color:${remain<0?'red':'inherit'}">${remain}</div>
                    <div class="cell col-ratio center">${t.est>0 ? Math.round((t.computedSum/t.est)*100) : 0}%</div>
                    <div class="cell col-progress">${t.isGroup ? t.progress+'%' : `<input type="number" min="0" max="100" value="${t.progress}" onchange="upd(${t.id},'progress',this.value)">%`}</div>
                    <div class="cell col-op">
                        <div class="icon-btn icon-memo ${t.memo?'has-content':''}" onclick="openMemo(${t.id})" title="ãƒ¡ãƒ¢ã‚’é–‹ã">${ICON_MEMO}</div>
                        <div class="icon-btn icon-risk ${t.risks && t.risks.length > 0 ? 'has-risk' : ''}" onclick="openRiskModal(${t.id})" title="ãƒªã‚¹ã‚¯ç®¡ç†">${ICON_RISK}</div>
                        ${!t.isGroup ? (isTracking ? `<div class="icon-btn icon-timer stop" onclick="stopTracking()" title="è¨ˆæ¸¬ã‚’åœæ­¢ã—ã¦å·¥æ•°ã‚’å…¥åŠ›">${ICON_STOP}</div>` : `<div class="icon-btn icon-timer start" onclick="startTracking(${t.id})" title="è¨ˆæ¸¬ã‚’é–‹å§‹">${ICON_START}</div>`) : ''}
                        
                        <div class="op-menu-wrap">
                            <div id="btn-more-${t.id}" class="icon-btn icon-more" onclick="event.stopPropagation(); toggleOpMenu(${t.id}, event)" title="ãã®ä»–">${ICON_ELLIPSIS}</div>
                            <div id="op-menu-${t.id}" class="op-menu-dropdown" onmouseleave="closeOpMenus()" onclick="event.stopPropagation()">
                                <button type="button" class="op-menu-item" onclick="toggleGrp(${t.id});"><span class="menu-icon">${ICON_GROUP}</span>ã‚°ãƒ«ãƒ¼ãƒ—åŒ–åˆ‡æ›¿</button>
                                <button type="button" class="op-menu-item" onclick="copyTask(${t.id});"><span class="menu-icon">${ICON_COPY}</span>ã‚¿ã‚¹ã‚¯ã‚’è¤‡è£½</button>
                                ${!t.isGroup ? `<button type="button" class="op-menu-item" onclick="shiftTaskDays(${t.id}, -1);"><span class="menu-icon">${ICON_SHIFT_LEFT}</span>1å–¶æ¥­æ—¥å‰ã¸ã‚·ãƒ•ãƒˆ</button><button type="button" class="op-menu-item" onclick="shiftTaskDays(${t.id}, 1);"><span class="menu-icon">${ICON_SHIFT_RIGHT}</span>1å–¶æ¥­æ—¥å¾Œã¸ã‚·ãƒ•ãƒˆ</button>` : ''}
                                <div style="border-top:1px solid #eee; margin:2px 0;"></div>
                                <button type="button" class="op-menu-item" style="color:#dc2626;" onclick="delT(${t.id});"><span class="menu-icon">${ICON_DELETE}</span>å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                `;
                wbsBody.appendChild(wRow);

                const gRow = document.createElement('div');
                gRow.className = 'row' + (t.isGroup ? ' group-row' : '');
                
                dateList.forEach(d => {
                    const val = t.hours[d.str] !== undefined ? parseFloat(t.hours[d.str]).toFixed(1) : "";
                    const inRange = (t.start && t.end && d.str >= t.start && d.str <= t.end);
                    
                    let isOver = false;
                    let load = 0;
                    if (!t.isGroup && t.owner && dailyLoadMap[t.owner] && dailyLoadMap[t.owner][d.str]) {
                        load = dailyLoadMap[t.owner][d.str];
                        if(load > OVERLOAD_LIMIT) isOver = true;
                    }

                    const isHoliday = d.w === 0 || d.holiday;
                    const c = document.createElement('div');
                    c.className = `cell day-cell ${d.w===6?'sat':''} ${isHoliday?'sun holiday':''} ${inRange?'in-range':''} ${isOver?'over-limit':''}`;
                    if(isOver) c.title = `åˆè¨ˆ:${load}h`;
                    
                    if (!t.isGroup) {
                        const inv = document.createElement('input');
                        inv.type = "number"; inv.min = "0"; inv.step = "0.1"; inv.className = "hour-input";
                        inv.value = val;
                        inv.onchange = (e) => updHr(t.id, d.str, e.target.value);
                        c.appendChild(inv);
                    }
                    gRow.appendChild(c);
                });
                ganttBody.appendChild(gRow);
            });

            // --- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤ºï¼ˆæ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç›´ä¸‹ã«é…ç½®ï¼‰ ---
            if (milestones.length > 0) {
                const milestoneBgColor = 'var(--milestone-bg)'; // CSSå¤‰æ•°ã‚’ä½¿ç”¨
                
                // WBSå´ï¼ˆå·¦éƒ¨ï¼‰
                const mHeaderWbs = document.createElement('div');
                mHeaderWbs.className = 'row';
                // è¦ªè¦ç´ ã ã‘ã§ãªãå­ã‚»ãƒ«ã«ã‚‚è‰²ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã€èƒŒæ™¯è‰²ã¯CSSå¤‰æ•°ã§å®šç¾©ã—å„ã‚»ãƒ«ã«é©ç”¨
                mHeaderWbs.style.background = milestoneBgColor;
                mHeaderWbs.style.borderTop = '1px solid #0284c7';
                mHeaderWbs.style.minHeight = '28px';
                mHeaderWbs.style.position = 'sticky';
                mHeaderWbs.style.top = '0';
                mHeaderWbs.style.zIndex = '38'; 
                
                // ã‚»ãƒ«è‡ªä½“ãŒç™½èƒŒæ™¯(background: #fff)ã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€styleå±æ€§ã§ä¸Šæ›¸ãã™ã‚‹
                const cellStyle = `background: ${milestoneBgColor};`;

                mHeaderWbs.innerHTML = `
                    <div class="cell col-no" style="${cellStyle}"></div>
                    <div class="cell col-title" style="${cellStyle} color: #0284c7; font-weight: bold; font-size: 11px; padding-left: 20px; display:flex; align-items:center;">ğŸ“… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</div>
                    <div class="cell col-owner" style="${cellStyle}"></div>
                    <div class="cell col-date" style="${cellStyle}"></div>
                    <div class="cell col-date" style="${cellStyle}"></div>
                    <div class="cell col-h" style="${cellStyle}"></div>
                    <div class="cell col-h" style="${cellStyle}"></div>
                    <div class="cell col-h" style="${cellStyle}"></div>
                    <div class="cell col-ratio" style="${cellStyle}"></div>
                    <div class="cell col-progress" style="${cellStyle}"></div>
                    <div class="cell col-op" style="${cellStyle}"></div>
                `;
                // å…ˆé ­ã«æŒ¿å…¥
                if (wbsBody.firstChild) {
                    wbsBody.insertBefore(mHeaderWbs, wbsBody.firstChild);
                } else {
                    wbsBody.appendChild(mHeaderWbs);
                }

                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆå´ï¼ˆå³éƒ¨ï¼‰
                const mHeaderGantt = document.createElement('div');
                mHeaderGantt.className = 'row milestone-gantt-row';
                mHeaderGantt.style.background = milestoneBgColor;
                mHeaderGantt.style.borderTop = '1px solid #0284c7';
                mHeaderGantt.style.minHeight = '28px';
                mHeaderGantt.style.position = 'sticky';
                mHeaderGantt.style.top = '34px'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†
                mHeaderGantt.style.zIndex = '38'; // ãƒ˜ãƒƒãƒ€ãƒ¼(40)ã‚ˆã‚Šä¸‹
                mHeaderGantt.style.width = '100%';
                mHeaderGantt.style.isolation = 'isolate';
                mHeaderGantt.style.transform = 'translateZ(0)';
                
                dateList.forEach(d => {
                    const dayMilestones = milestones.filter(m => m.date === d.str);
                    const c = document.createElement('div');
                    
                    const isToday = dayMilestones.length === 0 && d.isToday ? 'is-today-col' : '';
                    c.className = `cell day-cell ${d.w===6?'sat':''} ${d.w===0?'sun holiday':''} ${isToday}`;
                    c.style.borderLeft = 'none'; 
                    
                    // åŸºæœ¬èƒŒæ™¯è‰²ã‚’é©ç”¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç™½ã‚’ä¸Šæ›¸ãï¼‰
                    c.style.background = milestoneBgColor;

                    if (dayMilestones.length > 0) {
                        const ml = dayMilestones[0];
                        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãŒã‚ã‚‹å ´åˆã‚‚èƒŒæ™¯è‰²ã¯ç¶­æŒã—ã¤ã¤ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
                        c.style.background = milestoneBgColor;
                        c.style.color = '#f59e0b'; // æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸è‰²ï¼ˆAmber-500ï¼‰
                        c.style.fontWeight = 'bold';
                        c.style.fontSize = '16px';
                        c.style.textShadow = '0 1px 1px rgba(0,0,0,0.1)';
                        c.innerText = ml.completed ? 'âœ…' : 'ğŸ”¶';
                        c.title = dayMilestones.map(x => x.name).join(' / ');
                        c.style.cursor = 'help';
                    } else if (d.w === 0 || getHolidayName(d.str)) {
                        c.style.background = '#ffebec'; // ä¼‘æ—¥ã¯ä¼‘æ—¥è‰²ã‚’å„ªå…ˆ
                        c.style.color = '#dc3545';
                    }
                    mHeaderGantt.appendChild(c);
                });
                if (ganttBody.firstChild) {
                    ganttBody.insertBefore(mHeaderGantt, ganttBody.firstChild);
                } else {
                    ganttBody.appendChild(mHeaderGantt);
                }
            }
            
            // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾Œã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã„ã¦ã„ãŸå ´åˆã¯å†è¡¨ç¤ºã™ã‚‹
            if (activeMenuTaskId) {
                openOpMenu(activeMenuTaskId);
            }
        }

        // --- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç† ---
        function addMilestone() {
            document.getElementById('milestone-name').value = '';
            document.getElementById('milestone-date').value = getLocalDateStr();
            renderMilestoneList();
            document.getElementById('milestone-modal').style.display = 'flex';
        }

        function saveMilestone() {
            const name = document.getElementById('milestone-name').value.trim();
            const date = document.getElementById('milestone-date').value;
            
            if (!name) {
                alert('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!date) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            saveState();
            milestones.push({
                id: Date.now(),
                name: name,
                date: date,
                completed: false
            });
            localStorage.setItem(getStorageKey() + '-milestones', JSON.stringify(milestones));
            document.getElementById('milestone-name').value = '';
            renderMilestoneList();
            render();
        }

        function deleteMilestone(id) {
            if (confirm('ã“ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                saveState();
                milestones = milestones.filter(m => m.id !== id);
                localStorage.setItem(getStorageKey() + '-milestones', JSON.stringify(milestones));
                renderMilestoneList();
                render();
            }
        }

        function toggleMilestoneComplete(id) {
            saveState();
            const m = milestones.find(x => x.id === id);
            if (m) {
                m.completed = !m.completed;
                localStorage.setItem(getStorageKey() + '-milestones', JSON.stringify(milestones));
                renderMilestoneList();
                render();
            }
        }

        function updateMilestoneName(id, newName) {
            if (!newName.trim()) {
                alert('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            saveState();
            const m = milestones.find(x => x.id === id);
            if (m) {
                m.name = newName;
                localStorage.setItem(getStorageKey() + '-milestones', JSON.stringify(milestones));
                renderMilestoneList();
                render();
            }
        }

        function updateMilestoneDate(id, newDate) {
            if (!newDate) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            saveState();
            const m = milestones.find(x => x.id === id);
            if (m) {
                m.date = newDate;
                localStorage.setItem(getStorageKey() + '-milestones', JSON.stringify(milestones));
                renderMilestoneList();
                render();
            }
        }

        function renderMilestoneList() {
            const tbody = document.getElementById('milestone-list');
            tbody.innerHTML = '';
            milestones.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #ccc; padding: 6px;"><input type="text" value="${m.name}" onchange="updateMilestoneName(${m.id}, this.value)" style="padding: 2px; border: 1px solid #999; border-radius: 3px; width: 90%;"></td>
                    <td style="border: 1px solid #ccc; padding: 6px; text-align: center;"><input type="date" value="${m.date}" onchange="updateMilestoneDate(${m.id}, this.value)" style="padding: 2px; border: 1px solid #999; border-radius: 3px;"></td>
                    <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">
                        <input type="checkbox" ${m.completed ? 'checked' : ''} onchange="toggleMilestoneComplete(${m.id})">
                    </td>
                    <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">
                        <button style="padding: 2px 6px; font-size: 11px;" onclick="deleteMilestone(${m.id})">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
        function upd(id, f, v) { 
            saveState();
            const t = tasks.find(x => x.id === id); 
            if(t) { 
                if((f==='est'||f==='progress') && v<0) v=0;
                if(f==='progress' && v>100) v=100;
                t[f] = v;
            }
            render(); 
        }
        function updHr(id, dt, v) {
            saveState();
            const t = tasks.find(x => x.id === id);
            if(t) {
                const nv = parseFloat(v);
                if (!v || isNaN(nv) || nv <= 0) delete t.hours[dt];
                else t.hours[dt] = nv;
            }
            render();
        }
        function toggleGrp(id) { saveState(); const t = tasks.find(x => x.id === id); if(t) t.isGroup = !t.isGroup; render(); }
        function addTask() { 
            saveState();
            const today = getLocalDateStr(); 
            tasks.push({ id: Date.now(), title: 'æ–°è¦ã‚¿ã‚¹ã‚¯', owner: '', start: today, end: today, est: 0.0, progress: 0, isGroup: false, hours: {}, memo: "", risks: [] }); 
            render(); 
        }
        function copyTask(id) {
            saveState();
            const t = tasks.find(x => x.id === id);
            if(t) {
                const newT = JSON.parse(JSON.stringify(t));
                newT.id = Date.now();
                newT.title += " (ã‚³ãƒ”ãƒ¼)";
                newT.hours = {}; 
                newT.progress = 0;
                if(!newT.risks) newT.risks = [];
                const idx = tasks.findIndex(x => x.id === id);
                tasks.splice(idx + 1, 0, newT);
                render();
            }
        }
        function delT(id) { 
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { 
                saveState();
                if(trackingId === id) stopTracking(); 
                tasks = tasks.filter(x => x.id !== id); 
                render(); 
            } 
        }

        function closeOpMenus() {
            activeMenuTaskId = null;
            document.querySelectorAll('.op-menu-dropdown.show').forEach(m => {
                m.classList.remove('show');
                m.style.position = m.style.top = m.style.left = m.style.right = '';
            });
        }
        
        function openOpMenu(taskId) {
            const menu = document.getElementById('op-menu-' + taskId);
            const btn = document.getElementById('btn-more-' + taskId);
            if (menu && btn) {
                const rect = btn.getBoundingClientRect();
                menu.style.position = 'fixed';
                menu.style.top = (rect.bottom + 2) + 'px';
                menu.style.left = Math.max(4, rect.right - 180) + 'px';
                menu.style.right = 'auto';
                menu.classList.add('show');
                activeMenuTaskId = taskId;
            }
        }

        function toggleOpMenu(taskId, ev) {
            ev.stopPropagation();
            if (activeMenuTaskId === taskId) {
                closeOpMenus();
            } else {
                closeOpMenus();
                openOpMenu(taskId);
            }
        }
        
        document.addEventListener('click', function() { 
            closeOpMenus(); 
            document.getElementById('history-popup').style.display = 'none';
        });

        // --- ãƒ˜ãƒ«ãƒ—æ©Ÿèƒ½ ---
        function toggleHelp(e) {
            e.stopPropagation();
            const p = document.getElementById('help-popup');
            p.classList.toggle('show');
        }
        document.addEventListener('click', function(e) {
            const p = document.getElementById('help-popup');
            if(p && p.classList.contains('show')) p.classList.remove('show');
        });

        // --- ã‚·ãƒ•ãƒˆæ©Ÿèƒ½ (æ”¹ä¿®ç‰ˆ) ---
        function openShiftModal() { 
            const sel = document.getElementById('shift-target-group');
            sel.innerHTML = '';
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆè¦ªã‚¿ã‚¹ã‚¯ï¼‰ã®ã¿ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
            let hasGroup = false;
            tasks.forEach(t => {
                if(t.isGroup) {
                    hasGroup = true;
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.innerText = t.title;
                    sel.appendChild(opt);
                }
            });
            
            if (!hasGroup) {
                alert("è¦ªã‚¿ã‚¹ã‚¯ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚å…ˆã«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            document.getElementById('shift-modal').style.display = 'flex'; 
        }

        function applyShift() {
            const days = parseInt(document.getElementById('shift-days').value);
            const targetGroupId = document.getElementById('shift-target-group').value;
            
            if (days === 0 || isNaN(days)) {
                alert("ã‚·ãƒ•ãƒˆæ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            if (!targetGroupId) {
                alert("å¯¾è±¡ã®è¦ªã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }
            
            saveState();
            
            // å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—é…ä¸‹ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®šã—ã¦ã‚·ãƒ•ãƒˆ
            let inTargetGroup = false;
            let count = 0;

            tasks.forEach(t => {
                // ã‚°ãƒ«ãƒ¼ãƒ—è¡Œã®åˆ¤å®š
                if (t.isGroup) {
                    // é¸æŠã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ãŸ
                    if (t.id.toString() === targetGroupId) {
                        inTargetGroup = true;
                    } else {
                        // åˆ¥ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ãŸã‚‰å¯¾è±¡å¤–ã¸
                        inTargetGroup = false;
                    }
                    return; // ã‚°ãƒ«ãƒ¼ãƒ—è¡Œè‡ªä½“ã®æ—¥ä»˜ã¯è‡ªå‹•è¨ˆç®—ãªã®ã§è§¦ã‚‰ãªã„
                }

                // å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—å†… ã‹ã¤ æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®ã¿å‡¦ç†
                if (inTargetGroup && Number(t.progress) < 100) {
                    if (t.start) t.start = addBusinessDays(t.start, days);
                    if (t.end) t.end = addBusinessDays(t.end, days);
                    count++;
                }
            });

            document.getElementById('shift-modal').style.display = 'none';
            render();
            alert(`${count}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ã§ ${days}æ—¥ ã‚·ãƒ•ãƒˆã—ã¾ã—ãŸã€‚`);
        }

        // --- å€‹åˆ¥ã‚¿ã‚¹ã‚¯ç”¨ã‚·ãƒ•ãƒˆæ©Ÿèƒ½ ---
        function shiftTaskDays(id, businessDays) {
            saveState();
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            
            if (t.start) t.start = addBusinessDays(t.start, businessDays);
            if (t.end) t.end = addBusinessDays(t.end, businessDays);
            
            const directionText = businessDays > 0 ? 'å¾Œ' : 'å‰';
            const daysText = Math.abs(businessDays) === 1 ? '1å–¶æ¥­æ—¥' : `${Math.abs(businessDays)}å–¶æ¥­æ—¥`;
            render();
        }

        // --- ãƒ¡ãƒ¢ ---
        function openMemo(id) {
            currentMemoId = id; const t = tasks.find(x => x.id === id);
            document.getElementById('memo-title').innerText = `ãƒ¡ãƒ¢: ${t.title}`;
            document.getElementById('memo-text').value = t.memo || "";
            document.getElementById('memo-text').readOnly = false;
            document.getElementById('btn-save-memo').style.display = 'inline-block';
            document.getElementById('memo-modal').style.display = 'flex';
        }
        function viewRefMemo(index) {
            if (!currentRefResults[index]) return;
            const t = currentRefResults[index].task;
            document.getElementById('memo-title').innerText = `ãƒ¡ãƒ¢å‚ç…§: ${t.title}`;
            document.getElementById('memo-text').value = t.memo || "";
            document.getElementById('memo-text').readOnly = true;
            document.getElementById('btn-save-memo').style.display = 'none';
            document.getElementById('memo-modal').style.display = 'flex';
        }
        function closeMemo() { document.getElementById('memo-modal').style.display = 'none'; currentMemoId = null; }
        function saveMemo() {
            if(currentMemoId) { saveState(); const t = tasks.find(x => x.id === currentMemoId); t.memo = document.getElementById('memo-text').value; render(); }
            closeMemo();
        }

        // --- ãƒªã‚¹ã‚¯ç®¡ç† ---
        function openRiskModal(taskId) {
            activeRiskTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            if(!task) return;
            
            if(!task.risks) task.risks = [];

            const listContainer = document.getElementById('risk-list');
            listContainer.innerHTML = '';

            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
            const groupedRisks = {};
            const displayRisks = [...masterRisks];
            
            // ã‚¿ã‚¹ã‚¯ã«ã‚ã£ã¦ãƒã‚¹ã‚¿ã«ãªã„ã‚‚ã®ï¼ˆå‰Šé™¤æ¸ˆã¿ãªã©ï¼‰ã‚‚è¿½åŠ 
            task.risks.forEach(r => {
                if(!displayRisks.some(mr => mr.title === r.title)) {
                    displayRisks.push({ category: "ãã®ä»–", title: r.title });
                }
            });

            displayRisks.forEach(item => {
                const cat = item.category || "ãã®ä»–";
                if(!groupedRisks[cat]) groupedRisks[cat] = [];
                groupedRisks[cat].push(item.title);
            });

            // ã‚«ãƒ†ã‚´ãƒªé †ã«è¡¨ç¤º
            const predefinedCats = ["è¦ä»¶ãƒ»ä»•æ§˜", "æŠ€è¡“ãƒ»é–‹ç™º", "ãƒªã‚½ãƒ¼ã‚¹ãƒ»ä½“åˆ¶", "å¤–éƒ¨è¦å› ", "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«", "ãã®ä»–"];
            const allCats = [...predefinedCats];
            
            // æœªçŸ¥ã®ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Œã°æœ«å°¾ã«è¿½åŠ 
            Object.keys(groupedRisks).forEach(c => {
                if(!allCats.includes(c)) allCats.push(c);
            });

            allCats.forEach(cat => {
                const titles = groupedRisks[cat];
                if(!titles || titles.length === 0) return;

                const catDiv = document.createElement('div');
                catDiv.className = 'risk-category';
                
                const header = document.createElement('div');
                header.className = 'risk-category-header';
                header.innerHTML = `<span>${cat}</span> <span class="edit-cat-btn" onclick="editCategoryName('${cat}')">âœ</span>`;
                catDiv.appendChild(header);

                titles.forEach(riskTitle => {
                    const existing = task.risks.find(r => r.title === riskTitle);
                    const isChecked = !!existing;
                    const mitigationValue = existing ? existing.mitigation : "";

                    const item = document.createElement('div');
                    item.className = 'risk-item';
                    
                    const mainRow = document.createElement('div');
                    mainRow.className = 'risk-row-main';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'risk-chk';
                    checkbox.value = riskTitle;
                    checkbox.checked = isChecked;
                    checkbox.onchange = function() {
                        toggleRiskMitigation(this);
                    };
                    
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = riskTitle;
                    nameInput.title = "ç·¨é›†ã™ã‚‹ã¨ãƒã‚¹ã‚¿ã‚‚æ›´æ–°ã•ã‚Œã¾ã™";
                    nameInput.onchange = function() {
                        updateMasterRiskName(riskTitle, this.value);
                    };

                    const delBtn = document.createElement('button');
                    delBtn.innerText = 'ğŸ—‘';
                    delBtn.style.padding = '2px 6px';
                    delBtn.title = "ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤";
                    delBtn.onclick = function() {
                        deleteMasterRisk(riskTitle);
                    };

                    mainRow.appendChild(checkbox);
                    mainRow.appendChild(nameInput);
                    mainRow.appendChild(delBtn);

                    const mitigationBox = document.createElement('div');
                    mitigationBox.className = 'risk-mitigation-box ' + (isChecked ? 'active' : '');
                    
                    const mitLabel = document.createElement('span');
                    mitLabel.className = 'risk-label';
                    mitLabel.innerText = 'â†³ äºˆé˜²ç­–:';
                    
                    const mitInput = document.createElement('input');
                    mitInput.type = 'text';
                    mitInput.className = 'risk-mitigation-input';
                    mitInput.placeholder = 'å¯¾ç­–ã‚’å…¥åŠ›...';
                    mitInput.value = mitigationValue;
                    
                    const historyBtn = document.createElement('div');
                    historyBtn.className = 'risk-history-btn';
                    historyBtn.innerHTML = 'ğŸ•’';
                    historyBtn.title = "éå»ã®äºˆé˜²ç­–ã‚’å‚ç…§";
                    historyBtn.onclick = (e) => showMitigationHistory(e, riskTitle, mitInput);

                    mitigationBox.appendChild(mitLabel);
                    mitigationBox.appendChild(mitInput);
                    mitigationBox.appendChild(historyBtn);

                    item.appendChild(mainRow);
                    item.appendChild(mitigationBox);
                    catDiv.appendChild(item);
                });
                listContainer.appendChild(catDiv);
            });

            document.getElementById('new-risk-input').value = '';
            document.getElementById('risk-modal').style.display = 'flex';
        }

        function editCategoryName(oldName) {
            const newName = prompt("æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", oldName);
            if (newName && newName.trim() !== "" && newName !== oldName) {
                // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ†ã‚´ãƒªåã‚’æ›´æ–°
                let updated = false;
                masterRisks.forEach(r => {
                    if (r.category === oldName) {
                        r.category = newName;
                        updated = true;
                    }
                });
                
                if (updated) {
                    localStorage.setItem(getStorageKey() + '-master-risks', JSON.stringify(masterRisks));
                    // ç”»é¢ã‚’å†æç”»ï¼ˆç¾åœ¨ã®å…¥åŠ›çŠ¶æ…‹ã‚’ä¸€æ™‚ä¿å­˜ã—ã¦ã‹ã‚‰ï¼‰
                    tempSaveCurrentRiskState();
                    openRiskModal(activeRiskTaskId);
                }
            }
        }

        function toggleRiskMitigation(checkbox) {
            const item = checkbox.closest('.risk-item');
            const mitBox = item.querySelector('.risk-mitigation-box');
            if(checkbox.checked) {
                mitBox.classList.add('active');
            } else {
                mitBox.classList.remove('active');
            }
        }

        function addCustomRisk() {
            const catInput = document.getElementById('new-risk-category');
            const input = document.getElementById('new-risk-input');
            const newRisk = input.value.trim();
            let category = catInput.value.trim();
            
            if(!category) category = "ãã®ä»–";
            if(!newRisk) return;

            // ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ãªã„å ´åˆã®ã¿è¿½åŠ 
            if(!masterRisks.some(r => r.title === newRisk)) {
                masterRisks.push({ category: category, title: newRisk });
                localStorage.setItem(getStorageKey() + '-master-risks', JSON.stringify(masterRisks));
            }
            
            tempSaveCurrentRiskState();
            openRiskModal(activeRiskTaskId);
        }

        function updateMasterRiskName(oldName, newName) {
            newName = newName.trim();
            if(!newName || oldName === newName) return;

            const target = masterRisks.find(r => r.title === oldName);
            if(target) {
                target.title = newName;
                localStorage.setItem(getStorageKey() + '-master-risks', JSON.stringify(masterRisks));
            }

            saveState(); 
            tasks.forEach(t => {
                if(t.risks) {
                    t.risks.forEach(r => {
                        if(r.title === oldName) {
                            r.title = newName;
                        }
                    });
                }
            });
            localStorage.setItem(getStorageKey(), JSON.stringify(tasks)); 

            tempSaveCurrentRiskState(); 
            openRiskModal(activeRiskTaskId);
        }

        function deleteMasterRisk(name) {
            if(!confirm(`ã€Œ${name}ã€ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä½¿ç”¨ä¸­ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰`)) return;

            masterRisks = masterRisks.filter(r => r.title !== name);
            localStorage.setItem(getStorageKey() + '-master-risks', JSON.stringify(masterRisks));
            
            tempSaveCurrentRiskState();
            openRiskModal(activeRiskTaskId);
        }

        function tempSaveCurrentRiskState() {
            if(!activeRiskTaskId) return;
            const task = tasks.find(t => t.id === activeRiskTaskId);
            if(!task) return;

            const items = document.querySelectorAll('.risk-item');
            const newRisks = [];
            
            items.forEach(item => {
                const checkbox = item.querySelector('.risk-chk');
                if(checkbox.checked) {
                    const riskName = checkbox.value; 
                    const mitInput = item.querySelector('.risk-mitigation-input');
                    newRisks.push({
                        title: riskName,
                        mitigation: mitInput.value
                    });
                }
            });
            task.risks = newRisks;
        }

        function saveTaskRisks() {
            if(!activeRiskTaskId) return;
            tempSaveCurrentRiskState();
            saveState();
            render();
            document.getElementById('risk-modal').style.display = 'none';
            activeRiskTaskId = null;
        }
        
        // äºˆé˜²ç­–å±¥æ­´å‚ç…§æ©Ÿèƒ½
        function showMitigationHistory(e, riskTitle, inputElement) {
            e.stopPropagation();
            const history = new Set();
            
            tasks.forEach(t => {
                if(t.risks) {
                    t.risks.forEach(r => {
                        if(r.title === riskTitle && r.mitigation && r.mitigation.trim() !== "") {
                            history.add(r.mitigation);
                        }
                    });
                }
            });
            
            const historyList = Array.from(history);
            const popup = document.getElementById('history-popup');
            popup.innerHTML = '';
            
            if (historyList.length === 0) {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.style.color = '#999';
                div.innerText = '(å±¥æ­´ãªã—)';
                popup.appendChild(div);
            } else {
                historyList.forEach(hist => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerText = hist;
                    div.onclick = () => {
                        inputElement.value = hist;
                        popup.style.display = 'none';
                    };
                    popup.appendChild(div);
                });
            }
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®èª¿æ•´
            const rect = e.target.getBoundingClientRect();
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è€ƒæ…®ã—ã¦é…ç½®
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            
            popup.style.top = (rect.bottom + scrollY + 2) + 'px';
            // ç”»é¢å³ç«¯ã‹ã‚‰ã¯ã¿å‡ºãªã„ã‚ˆã†ã«èª¿æ•´
            const popupWidth = 250;
            if (rect.left + popupWidth > window.innerWidth) {
                popup.style.left = (window.innerWidth - popupWidth - 20) + 'px';
            } else {
                popup.style.left = (rect.left + scrollX - 200) + 'px';
            }
            
            popup.style.display = 'block';
        }

        // --- å®Ÿç¸¾å‚ç…§ ---
        function openRef(id) {
            const t = tasks.find(x => x.id === id); if(!t) return;
            currentRefTaskId = id;
            document.getElementById('ref-search-key').value = t.title; 
            const owners = new Set(); tasks.forEach(task => { if(task.owner) owners.add(task.owner); });
            const sel = document.getElementById('ref-search-owner'); sel.innerHTML = '<option value="">(å…¨æ‹…å½“è€…)</option>';
            Array.from(owners).sort().forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.innerText = o; sel.appendChild(opt); });
            document.getElementById('ref-search-status').value = "";
            setAdjustVal(0); drawDistribution([], 20); updateDistInfo(0);
            document.getElementById('ref-modal').style.display = 'flex'; searchRef(); 
        }
        function closeRef() { document.getElementById('ref-modal').style.display = 'none'; currentRefTaskId = null; }
        function toggleSelectAll(checked) { currentRefResults.forEach(r => r.isSelected = checked); renderRefList(); recalculateSummary(); }
        function toggleRefSelection(index, checked) { if (currentRefResults[index]) { currentRefResults[index].isSelected = checked; recalculateSummary(); const selectAll = document.getElementById('select-all-ref'); const selectedCount = currentRefResults.filter(r => r.isSelected).length; const totalCount = currentRefResults.length; if (totalCount === 0) { selectAll.checked = false; selectAll.indeterminate = false; } else if (selectedCount === totalCount) { selectAll.checked = true; selectAll.indeterminate = false; } else if (selectedCount > 0) { selectAll.checked = false; selectAll.indeterminate = true; } else { selectAll.checked = false; selectAll.indeterminate = false; } } }
        
        function searchRef() {
            const rawKey = document.getElementById('ref-search-key').value;
            const keywords = rawKey.trim() ? rawKey.toLowerCase().trim().split(/[\sã€€]+/) : [];
            const ownerFilter = document.getElementById('ref-search-owner').value;
            const statusFilter = document.getElementById('ref-search-status').value;
            currentRefResults = []; let currentParentTitle = "-";
            tasks.forEach(t => {
                if (t.isGroup) { currentParentTitle = t.title; } else {
                    if (t.id !== currentRefTaskId && t.computedSum > 0) {
                        const searchTarget = (currentParentTitle + " " + t.title).toLowerCase();
                        const isMatch = keywords.length === 0 || keywords.every(k => searchTarget.includes(k));
                        if (!isMatch) return;
                        if (ownerFilter && t.owner !== ownerFilter) return;
                        const isComplete = (Number(t.progress) >= 100);
                        if (statusFilter === 'complete' && !isComplete) return;
                        if (statusFilter === 'incomplete' && isComplete) return;
                        currentRefResults.push({ task: t, parent: currentParentTitle, isComplete: isComplete, isSelected: true });
                    }
                }
            });
            document.getElementById('select-all-ref').checked = currentRefResults.length > 0;
            document.getElementById('select-all-ref').indeterminate = false;
            renderRefList(); recalculateSummary();
        }
        function renderRefList() {
            const tbody = document.getElementById('ref-table-body'); tbody.innerHTML = "";
            currentRefResults.forEach((item, index) => {
                const t = item.task; const memoCell = t.memo ? `<button class="icon-btn" style="width:24px;height:24px; margin:0 auto;" onclick="viewRefMemo(${index})" title="ãƒ¡ãƒ¢ã‚’è¡¨ç¤º">ğŸ“„</button>` : "-";
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="ref-checkbox"><input type="checkbox" onchange="toggleRefSelection(${index}, this.checked)" ${item.isSelected ? 'checked' : ''}></td><td style="color:#555; font-size:11px;">${item.parent}</td><td>${t.title}</td><td style="text-align:center;">${memoCell}</td><td>${t.owner || '-'}</td><td>${t.computedSum.toFixed(1)}h</td><td style="color:${item.isComplete?'#2f5597':'#d97706'}">${t.progress}%</td><td><button class="select-btn" onclick="setAdjustVal(${t.computedSum})">é¸æŠ</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function recalculateSummary() {
            const selectedResults = currentRefResults.filter(r => r.isSelected);
            let count = selectedResults.length; let sum = 0, max = 0;
            if (count > 0) {
                sum = selectedResults.reduce((a, b) => a + b.task.computedSum, 0);
                max = Math.max(...selectedResults.map(r => r.task.computedSum));
                const avg = sum / count;
                document.getElementById('ref-count').innerText = count; document.getElementById('ref-avg').innerText = avg.toFixed(1); document.getElementById('ref-max').innerText = max.toFixed(1); document.getElementById('ref-summary-area').style.display = 'flex';
                const distData = selectedResults.map(r => ({ val: r.task.computedSum, isComplete: r.isComplete }));
                const slider = document.getElementById('adjust-slider');
                drawDistribution(distData, Math.max(20, Math.ceil(max * 2)), avg);
                const currentVal = parseFloat(slider.value);
                if (Math.abs(currentVal - avg) > 1.0) { setAdjustVal(avg); } else { updateDistInfo(currentVal); }
            } else {
                document.getElementById('ref-count').innerText = 0; document.getElementById('ref-avg').innerText = "0.0"; document.getElementById('ref-max').innerText = "0.0"; document.getElementById('ref-summary-area').style.display = 'none';
                drawDistribution([], 20); updateDistInfo(0); setAdjustVal(0);
            }
        }
        function selectRefVal(type) { const valStr = document.getElementById(type === 'avg' ? 'ref-avg' : 'ref-max').innerText; const val = parseFloat(valStr); if(!isNaN(val)) setAdjustVal(val); }
        function setAdjustVal(val) {
            val = parseFloat(val); if(isNaN(val) || val < 0) val = 0;
            const selectedVals = currentRefResults.filter(r => r.isSelected).map(r => r.task.computedSum);
            const maxRef = selectedVals.length > 0 ? Math.max(...selectedVals) : 0;
            const maxVal = Math.max(20, Math.ceil(Math.max(val*2, maxRef, 0) || 20));
            const slider = document.getElementById('adjust-slider'); slider.max = maxVal; slider.value = val; document.getElementById('adjust-num').value = val.toFixed(1);
            let avg = 0; if (selectedVals.length > 0) { avg = selectedVals.reduce((a,b) => a + b, 0) / selectedVals.length; }
            const distData = currentRefResults.filter(r => r.isSelected).map(r => ({ val: r.task.computedSum, isComplete: r.isComplete }));
            drawDistribution(distData, maxVal, avg); updateDistInfo(val);
        }
        function syncSlider(val) { document.getElementById('adjust-slider').value = val; updateDistInfo(val); }
        function syncNum(val) { document.getElementById('adjust-num').value = parseFloat(val).toFixed(1); updateDistInfo(val); }
        function updateDistInfo(val) {
            val = parseFloat(val); if (isNaN(val)) return;
            const infoEl = document.getElementById('dist-info');
            const selectedResults = currentRefResults.filter(r => r.isSelected);
            if (selectedResults.length === 0) { infoEl.innerHTML = "è©²å½“ã™ã‚‹å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"; return; }
            const range = 0.25;
            const hits = selectedResults.filter(r => r.task.computedSum >= (val - range) && r.task.computedSum < (val + range));
            if (hits.length > 0) {
                const count = hits.length;
                let names = hits.slice(0, 3).map(r => {
                    const parentStr = (r.parent && r.parent !== "-") ? r.parent + " > " : "";
                    return `${parentStr}${r.task.title}(${r.task.computedSum.toFixed(1)}h, ${r.task.progress}%)`;
                }).join(", ");
                if (hits.length > 3) names += `, ä»–${hits.length - 3}ä»¶`;
                infoEl.innerHTML = `<span class="dist-highlight">${val.toFixed(1)}h ä»˜è¿‘ã®å®Ÿç¸¾:</span> <b>${count}ä»¶</b> ï¼ˆ${names}ï¼‰`;
            } else { infoEl.innerHTML = `<span class="dist-highlight">${val.toFixed(1)}h ä»˜è¿‘ã®å®Ÿç¸¾:</span> ãªã—`; }
        }
        function applyRefAdjusted() {
            if(!currentRefTaskId) return; const val = parseFloat(document.getElementById('adjust-num').value); if(isNaN(val)) return;
            const t = tasks.find(x => x.id === currentRefTaskId); if(t) { t.est = val; render(); } closeRef();
        }
        function drawDistribution(data, maxRange, average) {
            const canvas = document.getElementById('dist-canvas'); const ctx = canvas.getContext('2d');
            const w = canvas.parentElement.offsetWidth; const h = canvas.parentElement.offsetHeight;
            canvas.width = w; canvas.height = h; ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "#eee"; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
            ctx.fillStyle = "#999"; ctx.font = "10px sans-serif"; ctx.fillText("0h", 2, h - 2); ctx.fillText(maxRange + "h", w - 25, h - 2);
            if (!data || data.length === 0) return;
            const binSize = 0.5; const bins = {}; let maxCount = 0;
            data.forEach(item => {
                const binKey = Math.floor(item.val / binSize) * binSize;
                bins[binKey] = (bins[binKey] || 0) + 1;
                if (bins[binKey] > maxCount) maxCount = bins[binKey];
            });
            ctx.fillStyle = "rgba(47, 85, 151, 0.6)"; 
            for (let b in bins) {
                const val = parseFloat(b); const count = bins[b];
                const x = (val / maxRange) * w; const barW = (binSize / maxRange) * w;
                const totalH = (count / maxCount) * (h - 8); const yBase = (h/2) + (totalH/2);
                ctx.fillRect(x, yBase - totalH, Math.max(barW - 1, 1), totalH);
            }
            if (average > 0) {
                const avgX = (average / maxRange) * w; ctx.beginPath(); ctx.strokeStyle = "rgba(255, 0, 0, 0.7)"; ctx.lineWidth = 2; ctx.setLineDash([3, 3]); ctx.moveTo(avgX, 5); ctx.lineTo(avgX, h - 5); ctx.stroke(); ctx.setLineDash([]); 
            }
        }

        // --- ã‚¿ã‚¤ãƒãƒ¼ ---
        function startTracking(id) {
            if(trackingId) stopTracking();
            trackingId = id; trackingStartTime = new Date();
            const t = tasks.find(x => x.id === id);
            timerInterval = setInterval(() => {
                const d = new Date(new Date() - trackingStartTime);
                document.getElementById('tracker-status').innerText = `è¨ˆæ¸¬ä¸­: ${t.title} (${d.getUTCHours()}:${d.getUTCMinutes()}:${d.getUTCSeconds()})`;
            }, 1000);
            render();
        }
        function stopTracking() {
            if(!trackingId) return;
            saveState();
            const h = (new Date() - trackingStartTime) / 3600000;
            const t = tasks.find(x => x.id === trackingId);
            const today = getLocalDateStr();
            t.hours[today] = parseFloat(((t.hours[today]||0) + h).toFixed(1));
            clearInterval(timerInterval); trackingId = null;
            document.getElementById('tracker-status').innerText = "";
            render();
        }

        // --- åˆ†æãƒ»ãƒãƒ£ãƒ¼ãƒˆ (ã‚³ã‚¹ãƒˆæ©Ÿèƒ½å‰Šé™¤ç‰ˆ) ---
        function openAnalyze() {
            const now = new Date();
            document.getElementById('ana-start').value = new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString('sv-SE');
            document.getElementById('ana-end').value = new Date(now.getFullYear(), now.getMonth()+1, 0).toLocaleDateString('sv-SE');
            const sel = document.getElementById('ana-target'); sel.innerHTML = '<option value="">(å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»è¦ªã‚¿ã‚¹ã‚¯æ¯”è¼ƒ)</option>';
            tasks.filter(t=>t.isGroup).forEach(t => sel.appendChild(new Option(t.title, t.id)));
            document.getElementById('analyze-modal').style.display = 'flex';
            setTimeout(renderCharts, 200);
        }

        function renderCharts() {
            const start = document.getElementById('ana-start').value;
            const end = document.getElementById('ana-end').value;
            const targetId = document.getElementById('ana-target').value;
            
            const compareItems = [];
            const pieData = {};
            const dailyData = {}; 
            
            let cur = new Date(start); const endObj = new Date(end);
            while(cur <= endObj) {
                dailyData[cur.toLocaleDateString('sv-SE')] = {};
                cur.setDate(cur.getDate()+1);
            }

            tasks.forEach(t => {
                if (t.isGroup) {
                    if (targetId && t.id != targetId) return;
                } else {
                    let tAct = 0;
                    Object.keys(t.hours).forEach(d => {
                        if (d >= start && d <= end) {
                            const h = t.hours[d];
                            const val = h;
                            tAct += val;
                            const owner = t.owner || "(æœªå‰²å½“)";
                            pieData[owner] = (pieData[owner] || 0) + val;
                            if (dailyData[d]) dailyData[d][owner] = (dailyData[d][owner] || 0) + val;
                        }
                    });
                    
                    if (tAct > 0 || (t.est > 0 && !targetId)) { 
                        const estVal = t.est;
                        compareItems.push({ label: t.title, est: estVal, act: tAct });
                    }
                }
            });

            drawBarChart(compareItems);
            drawPieChart(pieData);
            drawDailyChart(dailyData);
        }

        function drawBarChart(items) {
            const canvas = document.getElementById('chart-bar-compare');
            const ctx = canvas.getContext('2d');
            const h = Math.max(items.length * 40 + 50, 200);
            canvas.height = h; canvas.width = canvas.parentElement.offsetWidth;
            const w = canvas.width;
            ctx.clearRect(0,0,w,h);
            
            const maxVal = Math.max(...items.map(i=>Math.max(i.est, i.act))) || 1;
            const scale = (w - 150) / maxVal;
            
            items.forEach((it, i) => {
                const y = 30 + i * 40;
                ctx.fillStyle = "#333"; ctx.font="12px sans-serif"; ctx.textAlign="right";
                ctx.fillText(it.label.slice(0,10), 140, y + 15);
                
                ctx.fillStyle = "#ccc";
                ctx.fillRect(150, y, it.est * scale, 10);
                
                ctx.fillStyle = it.act > it.est ? "#cc0000" : "#5b9bd5";
                ctx.fillRect(150, y+12, it.act * scale, 10);
                
                ctx.textAlign="left"; ctx.fillStyle="#555"; ctx.font="10px sans-serif";
                const valStr = it.act.toFixed(1);
                ctx.fillText(valStr + "h", 150 + it.act * scale + 5, y+20);
            });
        }

        function drawPieChart(data) {
            const canvas = document.getElementById('chart-pie-owner');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.offsetWidth;
            const h = canvas.height = 250;
            ctx.clearRect(0,0,w,h);
            
            let total = 0; Object.values(data).forEach(v => total += v);
            if(total===0) { ctx.fillText("ãƒ‡ãƒ¼ã‚¿ãªã—", w/2, h/2); return; }

            let start = -Math.PI/2;
            const colors = ['#5b9bd5', '#ed7d31', '#a5a5a5', '#ffc000', '#4472c4'];
            let i = 0;
            Object.keys(data).forEach(k => {
                const val = data[k];
                const angle = (val/total) * Math.PI * 2;
                ctx.beginPath(); ctx.moveTo(w/3, h/2); ctx.arc(w/3, h/2, 100, start, start+angle);
                ctx.fillStyle = colors[i%colors.length]; ctx.fill();
                
                ctx.fillRect(w*0.6, 50 + i*20, 10, 10);
                ctx.fillStyle = "#333"; ctx.textAlign="left";
                const valStr = val.toFixed(1);
                ctx.fillText(`${k}: ${valStr}h`, w*0.6 + 15, 60 + i*20);
                
                start += angle; i++;
            });
        }

        function drawDailyChart(data) {
            const canvas = document.getElementById('chart-bar-daily');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.offsetWidth;
            const h = canvas.height = 300;
            ctx.clearRect(0,0,w,h);
            
            const dates = Object.keys(data).sort();
            const owners = new Set();
            dates.forEach(d => Object.keys(data[d]).forEach(o => owners.add(o)));
            const ownerArr = Array.from(owners);
            const colors = ['#5b9bd5', '#ed7d31', '#a5a5a5', '#ffc000'];

            let max = 0;
            dates.forEach(d => {
                const sum = Object.values(data[d]).reduce((a,b)=>a+b,0);
                if(sum > max) max = sum;
            });
            if(max===0) max=1;

            const barW = Math.min(30, (w-50)/dates.length - 2);
            const scale = (h-50) / max;

            dates.forEach((d, i) => {
                let y = h - 30;
                const x = 40 + i * ((w-50)/dates.length);
                ownerArr.forEach((o, oi) => {
                    const val = data[d][o] || 0;
                    if(val > 0) {
                        const barH = val * scale;
                        ctx.fillStyle = colors[oi%colors.length];
                        ctx.fillRect(x, y - barH, barW, barH);
                        y -= barH;
                    }
                });
                if (dates.length < 15 || i%5===0) {
                    ctx.fillStyle = "#333"; ctx.textAlign="center"; ctx.font="10px sans-serif";
                    ctx.fillText(d.slice(5), x+barW/2, h-15);
                }
            });
        }

        // --- ãã®ä»– å¤–éƒ¨é€£æº (æ—¥å ±å¾©åˆ»ç‰ˆ) ---
        function openReport() { document.getElementById('report-month').value = new Date().toISOString().slice(0, 7); renderReportContent(); document.getElementById('report-modal').style.display = 'flex'; }
        function renderReportContent() {
            const ym = document.getElementById('report-month').value; if (!ym) return;
            const tbody = document.getElementById('report-body'); tbody.innerHTML = "";
            const dailyData = {};
            
            // è¦ªã‚¿ã‚¹ã‚¯åã®ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆ
            const parentMap = {};
            let currentParentTitle = "";
            tasks.forEach(t => {
                if (t.isGroup) {
                    currentParentTitle = t.title;
                } else {
                    parentMap[t.id] = currentParentTitle;
                }
            });
            
            tasks.forEach(t => {
                if (t.isGroup) return;
                const owner = t.owner || "(æœªå‰²å½“)";
                Object.keys(t.hours).forEach(date => {
                    if (!date.startsWith(ym)) return;
                    if (!dailyData[date]) dailyData[date] = {};
                    if (!dailyData[date][owner]) dailyData[date][owner] = { total: 0, taskDetails: [] };
                    const h = t.hours[date];
                    dailyData[date][owner].total += h;
                    const parentName = parentMap[t.id] || "";
                    const displayTitle = parentName ? `${parentName}/${t.title}` : t.title;
                    dailyData[date][owner].taskDetails.push(`${displayTitle}(${h.toFixed(1)}h)`);
                });
            });
            const sortedDates = Object.keys(dailyData).sort();
            if (sortedDates.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'; return; }
            sortedDates.forEach(date => {
                const dayData = dailyData[date]; const owners = Object.keys(dayData).sort();
                owners.forEach(owner => {
                    const data = dayData[owner]; const isOver = data.total > 8; const tr = document.createElement('tr'); if (isOver) tr.className = 'report-over-limit';
                    tr.innerHTML = `<td>${date}</td><td>${owner}</td><td>${data.taskDetails.join(', ')}</td><td class="num-cell">${data.total.toFixed(1)}h</td>`;
                    tbody.appendChild(tr);
                });
            });
        }
        function copyReportToClipboard() {
            let txt = "æ—¥ä»˜\tæ‹…å½“\tå†…è¨³\tåˆè¨ˆ\n";
            document.querySelectorAll("#report-body tr").forEach(tr => {
                txt += Array.from(tr.cells).map(c => c.innerText).join("\t") + "\n";
            });
            navigator.clipboard.writeText(txt).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
        }
        function downloadJSON() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({tasks, milestones},null,2)],{type:'application/json'})); a.download='wbs_data.json'; a.click(); }
        function downloadCSV() {
            let csv = "No,Task,Owner,Start,End,Est,Act,Progress,Memo\n";
            tasks.forEach(t => {
                csv += `"${t.no}","${t.title}","${t.owner}","${t.start}","${t.end}",${t.est},${t.computedSum},${t.progress},"${t.memo}"\n`;
            });
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([bom, csv],{type:'text/csv'})); a.download='wbs.csv'; a.click();
        }
        function uploadJSON(e) {
            const r = new FileReader(); 
            r.onload = ev => { 
                saveState(); 
                const data = JSON.parse(ev.target.result);
                if (data.tasks) tasks = data.tasks;
                else tasks = data;
                if (data.milestones) {
                    milestones = data.milestones;
                    localStorage.setItem(getStorageKey() + '-milestones', JSON.stringify(milestones));
                }
                render(); 
            }; 
            r.readAsText(e.target.files[0]);
        }
        
        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ­ã‚¸ãƒƒã‚¯ (åˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»•æ§˜) ---
        function toggleFilterMenu(e) { 
            e.stopPropagation(); 
            document.getElementById('date-filter-menu').style.display='none'; 
            document.getElementById('prog-filter-menu').style.display='none'; 
            const menu = document.getElementById('filter-menu'); 
            if(menu.style.display==='flex'){ menu.style.display='none'; return; }
            
            menu.innerHTML = '';
            // å…¨è§£é™¤ãƒ»å…¨é¸æŠ
            const allBtnDiv = document.createElement('div'); allBtnDiv.style.padding="4px"; allBtnDiv.style.borderBottom="1px solid #eee"; allBtnDiv.style.marginBottom="4px"; allBtnDiv.style.display="flex"; allBtnDiv.style.gap="10px"; allBtnDiv.style.justifyContent="center";
            const btnAll = document.createElement('button'); btnAll.innerText="ã™ã¹ã¦"; btnAll.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=true)};
            const btnClear = document.createElement('button'); btnClear.innerText="è§£é™¤"; btnClear.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=false)};
            allBtnDiv.appendChild(btnAll); allBtnDiv.appendChild(btnClear); menu.appendChild(allBtnDiv);
            
            const owners = new Set(); tasks.forEach(t=>owners.add(t.owner||""));
            Array.from(owners).sort().forEach(o=>{
                const val = o===""?"(æœªå‰²å½“)":o;
                const label = document.createElement('label'); 
                const chk = document.createElement('input'); chk.type="checkbox"; chk.value=o;
                if(visibleOwners===null || visibleOwners.has(o)) chk.checked=true;
                label.appendChild(chk); label.appendChild(document.createTextNode(val));
                menu.appendChild(label);
            });
            
            const actionDiv = document.createElement('div'); actionDiv.className='filter-actions';
            const applyBtn = document.createElement('button'); applyBtn.className='primary'; applyBtn.innerText="é©ç”¨";
            applyBtn.onclick=()=>{
                const checked = menu.querySelectorAll('input:checked');
                if(checked.length === owners.size) visibleOwners = null;
                else { visibleOwners=new Set(); checked.forEach(c=>visibleOwners.add(c.value)); }
                menu.style.display='none'; render();
            };
            actionDiv.appendChild(applyBtn); menu.appendChild(actionDiv);
            menu.style.display='flex';
        }
        
        function toggleDateFilterMenu(e) { 
            e.stopPropagation(); document.getElementById('filter-menu').style.display='none'; document.getElementById('prog-filter-menu').style.display='none';
            const menu = document.getElementById('date-filter-menu');
            if(menu.style.display==='flex'){ menu.style.display='none'; return; }
            
            menu.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'date-filter-container';
            
            const label = document.createElement('div');
            label.style.marginBottom = "4px";
            label.style.fontWeight = "bold";
            label.style.fontSize = "11px";
            label.innerText = "é–‹å§‹æ—¥ä»¥é™ã‚’è¡¨ç¤º:";
            container.appendChild(label);
            
            const inp = document.createElement('input');
            inp.type = "date";
            inp.id = "df-input";
            inp.className = "date-filter-input";
            if(visibleStartDate) inp.value = visibleStartDate;
            container.appendChild(inp);
            menu.appendChild(container);

            const actionDiv = document.createElement('div'); actionDiv.className='filter-actions';
            const applyBtn = document.createElement('button'); applyBtn.className='primary'; applyBtn.innerText="é©ç”¨";
            applyBtn.onclick=()=>{ visibleStartDate=inp.value||null; menu.style.display='none'; render(); };
            const clearBtn = document.createElement('button'); clearBtn.innerText="è§£é™¤";
            clearBtn.onclick=()=>{ visibleStartDate=null; menu.style.display='none'; render(); };
            
            actionDiv.appendChild(applyBtn); actionDiv.appendChild(clearBtn); menu.appendChild(actionDiv);
            menu.style.display='flex';
        }
        
        function toggleProgressFilterMenu(e) { 
            e.stopPropagation(); document.getElementById('filter-menu').style.display='none'; document.getElementById('date-filter-menu').style.display='none';
            const menu = document.getElementById('prog-filter-menu');
            if(menu.style.display==='flex'){ menu.style.display='none'; return; }
            menu.innerHTML = '';
            // åˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯
            const opts = [{v:'incomplete',t:'æœªå®Œäº†'},{v:'complete',t:'å®Œäº† (100%)'}];
            
            const allBtnDiv = document.createElement('div'); allBtnDiv.style.padding="4px"; allBtnDiv.style.borderBottom="1px solid #eee"; allBtnDiv.style.marginBottom="4px"; allBtnDiv.style.display="flex"; allBtnDiv.style.gap="10px"; allBtnDiv.style.justifyContent="center";
            const btnAll = document.createElement('button'); btnAll.innerText="ã™ã¹ã¦"; btnAll.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=true)};
            const btnClear = document.createElement('button'); btnClear.innerText="è§£é™¤"; btnClear.onclick=()=>{menu.querySelectorAll('input').forEach(c=>c.checked=false)};
            allBtnDiv.appendChild(btnAll); allBtnDiv.appendChild(btnClear); menu.appendChild(allBtnDiv);

            opts.forEach(o=>{
                const label=document.createElement('label'); const chk=document.createElement('input'); chk.type="checkbox"; chk.value=o.v;
                if(visibleProgress===null||visibleProgress.has(o.v)) chk.checked=true;
                label.appendChild(chk); label.appendChild(document.createTextNode(o.t)); menu.appendChild(label);
            });
            
            const actionDiv = document.createElement('div'); actionDiv.className='filter-actions';
            const applyBtn = document.createElement('button'); applyBtn.className='primary'; applyBtn.innerText="é©ç”¨";
            applyBtn.onclick=()=>{
                const checked=menu.querySelectorAll('input:checked');
                if(checked.length===opts.length) visibleProgress=null;
                else { visibleProgress=new Set(); checked.forEach(c=>visibleProgress.add(c.value)); }
                menu.style.display='none'; render();
            };
            actionDiv.appendChild(applyBtn); menu.appendChild(actionDiv);
            menu.style.display='flex';
        }
        document.addEventListener('click', () => {
             document.querySelectorAll('.filter-menu').forEach(e => e.style.display = 'none');
        });

        const ganttContainer = document.getElementById('gantt-container');
        const wbsBodyContainer = document.getElementById('wbs-body-container');
        ganttContainer.addEventListener('scroll', () => { wbsBodyContainer.scrollTop = ganttContainer.scrollTop; });
        
        render();
        setTimeout(() => {
            const t = document.getElementById('today-target');
            if(t) ganttContainer.scrollLeft = t.offsetLeft - 100;
        }, 200);

    </script>
</body>
</html>
