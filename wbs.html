<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å·¥æ•°ç®¡ç†</title>
    <style>
        :root {
            --border: #bcbcbc;
            --header-bg: #f2f2f2;
            --excel-blue: #2f5597;
            --excel-group-bg: #d9d9d9;
            --range-blue: #eaf4ff; 
            --work-blue: #5b9bd5;  
            --today-bg: #fff9c4;    
            --today-col-bg: rgba(255, 249, 196, 0.3);
            --today-line: #ff0000;  
            --row-h: 34px;
            --day-w: 55px; 
            --wbs-w: 1120px; 
            
            /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”¨è‰²å®šç¾© */
            --overload-bg: #ffdddd; /* 8hè¶…ãˆã®èƒŒæ™¯è‰² */
            --overload-col: #cc0000; /* 8hè¶…ãˆã®æ–‡å­—è‰² */
        }

        * { box-sizing: border-box; }
        body { font-family: "Meiryo", "MS PGothic", sans-serif; margin: 15px; font-size: 12px; background: #f9f9f9; color: #333; overflow: hidden; }
        
        .controls { margin-bottom: 10px; display: flex; gap: 8px; align-items: center; white-space: nowrap; flex-wrap: nowrap; }
        button { padding: 5px 15px; cursor: pointer; border: 1px solid #999; background: #fff; border-radius: 2px; font-size: 12px; }
        button.primary { background: var(--excel-blue); color: white; border: none; }

        .usage-guide {
            margin-left: auto;
            display: flex;
            gap: 15px;
            padding: 5px 12px;
            background: #eee;
            border-radius: 4px;
            color: #555;
            font-size: 11px;
            border: 1px solid #ddd;
        }
        .guide-item { display: flex; align-items: center; gap: 4px; }
        .guide-icon { font-size: 14px; }

        .main-container {
            display: flex;
            border: 2px solid #888;
            background: #fff;
            overflow: hidden;
            height: calc(100vh - 80px);
        }

        .wbs-area {
            width: var(--wbs-w);
            flex-shrink: 0;
            border-right: 2px solid #444; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff;
            z-index: 10;
        }

        #wbs-body-container { overflow: hidden; flex-grow: 1; }
        
        #wbs-body { padding-bottom: 20px; }

        .gantt-area {
            flex-grow: 1;
            overflow: auto;
            position: relative;
            background: #fff;
            margin-left: -2px; 
        }

        .row { display: flex; width: 100%; }
        
        .cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            height: var(--row-h);
            display: flex;
            align-items: center;
            padding: 0 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: #fff;
        }

        .header { 
            position: sticky; 
            top: 0; 
            z-index: 40; 
            background: var(--header-bg); 
            box-shadow: 0 1px 0 #888; 
        }
        .header .cell { 
            background: var(--header-bg); 
            justify-content: center; 
            border-bottom: 1px solid #888;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒéš ã‚Œãªã„ã‚ˆã†ã«overflowè¨­å®šã‚’å¤‰æ›´ */
        .header .col-owner, 
        .header .col-date,
        .header .col-progress { overflow: visible !important; position: relative; } 

        .col-no { width: 45px; justify-content: center !important; background: #f0f0f0 !important; font-weight: bold; }
        .col-title { width: 220px; }
        .col-owner { width: 90px; } 
        .col-date { width: 135px; } 

        .col-h { width: 75px; justify-content: center; padding-right: 2px; }
        
        .col-ratio { width: 55px; justify-content: center; font-size: 11px; }
        .col-progress { width: 75px; justify-content: center; }
        .col-op { width: 140px; justify-content: center; border-right: none !important; gap: 6px; padding: 0 2px; }

        /* é€²æ—ã®è¦‹ãŸç›®èª¿æ•´ */
        .progress-input-wrapper { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .progress-input-wrapper input { width: 100%; text-align: center; }

        .day-cell { width: var(--day-w); justify-content: center; padding: 0 !important; } 
        .is-today-h { background: var(--today-bg) !important; color: #d97706 !important; font-weight: bold; border-bottom: 1px solid #888 !important; }
        .is-today-col { background-color: var(--today-col-bg) !important; }

        .group-row .cell { background: var(--excel-group-bg) !important; font-weight: bold; }
        .in-range { background: var(--range-blue) !important; }
        .sat { color: #007bff; }
        .sun { color: #dc3545; }

        .today-line {
            position: absolute; top: 0; bottom: 0; 
            width: 2px;
            background: var(--today-line); 
            z-index: 5; 
            pointer-events: none;
            opacity: 0.6;
        }

        input { width: 100%; border: none; outline: none; background: transparent; font-size: 12px; font-family: inherit; }
        input[type="number"] { text-align: center; }

        .date-display-text { font-size: 12px; padding-left: 2px; color: #333; cursor: default; white-space: nowrap; }
        .date-input { cursor: pointer; text-align: left; width: 100%; }
        
        .hour-input { height: 100%; font-size: 11px; padding-right: 2px !important; width: 100%; color: inherit; cursor: pointer; }

        .icon-btn {
            width: 26px; height: 26px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 4px; border: 1px solid #ccc; transition: all 0.2s; background: #fff; padding: 0; flex-shrink: 0;
        }
        .icon-btn svg { width: 16px; height: 16px; fill: #666; }
        .icon-btn:hover { background: #f0f0f0; border-color: #888; }
        .icon-group:hover { background: #e2e8f0; }
        .icon-delete:hover { background: #fee2e2; }
        .icon-delete:hover svg { fill: #dc2626; }
        .icon-timer.start { border-color: #16a34a; }
        .icon-timer.start svg { fill: #16a34a; }
        .icon-timer.stop { border-color: #dc2626; background: #fef2f2; }
        .icon-timer.stop svg { fill: #dc2626; }
        .icon-memo.has-content { border-color: #2f5597; background: #eaf4ff; }
        .icon-memo.has-content svg { fill: #2f5597; }

        .tracking-active { background: #fff1f2 !important; }

        .icon-ref {
            font-size: 10px; color: #555; cursor: pointer; 
            width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #ccc; border-radius: 3px; background: #eee; margin-left: 2px;
        }
        .icon-ref:hover { background: #e0f2fe; border-color: var(--work-blue); color: var(--excel-blue); }

        .filter-icon { 
            cursor: pointer; margin-left: 2px; color: #666; font-size: 10px; 
            border: 1px solid #999; border-radius: 3px; padding: 1px 2px; background: #eee; flex-shrink: 0;
            display: inline-block; line-height: 1;
        }
        .filter-icon:hover { background: #ddd; }
        .filter-active { background: var(--excel-blue); color: #fff; border-color: var(--excel-blue); }
        
        .filter-menu {
            position: absolute; top: 100%; left: 0; 
            width: max-content; 
            min-width: 150px;   
            background: #fff; border: 1px solid #999; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); 
            z-index: 1000; display: none; flex-direction: column; padding: 5px;
            text-align: left; font-weight: normal; max-height: 300px; overflow-y: auto;
            margin-top: 1px;
            white-space: nowrap; 
        }
        .col-progress .filter-menu { left: auto; right: 0; } 

        .filter-menu label { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start;
            gap: 8px; 
            padding: 4px 8px; 
            cursor: pointer;
            width: 100%;
        }
        .filter-menu label:hover { background: #f0f0f0; }
        .filter-menu input[type="checkbox"] { margin: 0; width: auto; cursor: pointer; }
        
        .date-filter-container { padding: 8px; }
        .date-filter-input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 2px; box-sizing: border-box; }

        .filter-actions { border-top: 1px solid #ddd; padding-top: 5px; margin-top: 5px; display: flex; justify-content: space-between; }
        .filter-actions button { padding: 3px 8px; font-size: 11px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        #memo-modal {
            z-index: 2000 !important;
        }

        .modal-content { background: #fff; width: 750px; padding: 25px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-content h3 { margin: 0 0 15px 0; font-size: 16px; color: var(--excel-blue); border-bottom: 2px solid var(--excel-blue); padding-bottom: 8px; }
        .modal-content textarea { width: 100%; height: 350px; margin-bottom: 20px; padding: 12px; font-family: inherit; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; line-height: 1.6; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; }

        /* å®Ÿç¸¾å‚ç…§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .ref-result-area { height: 180px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; }
        .ref-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .ref-table th { background: #f2f2f2; position: sticky; top: 0; padding: 6px; text-align: left; border-bottom: 1px solid #ccc; }
        .ref-table td { padding: 6px; border-bottom: 1px solid #eee; }
        .ref-table tr:hover { background: #f9f9f9; }
        
        .ref-summary { display: flex; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; align-items: center; border: 1px solid #ddd; }
        .select-btn { padding: 3px 8px; font-size: 11px; border: 1px solid #999; color: #333; background: #fff; border-radius: 3px; cursor: pointer; }
        .select-btn:hover { background: #eee; }

        .search-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .search-row input { border: 1px solid #ccc; padding: 6px; border-radius: 3px; flex-grow: 1; }
        .search-row select { border: 1px solid #ccc; padding: 6px; border-radius: 3px; min-width: 120px; }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼èª¿æ•´ã‚¨ãƒªã‚¢ */
        .ref-adjust-area { 
            background: #fff; padding: 15px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 15px; 
            display: flex; flex-direction: column; gap: 8px; position: relative;
        }
        .adjust-controls { display: flex; align-items: center; gap: 15px; position: relative; height: 40px; }
        .slider-wrapper { position: relative; flex-grow: 1; height: 100%; display: flex; align-items: center; }
        
        /* ã‚°ãƒ©ãƒ•æç”»ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #dist-canvas {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 1;
            opacity: 0.9;
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æœ¬ä½“ */
        input[type="range"] { 
            width: 100%; margin: 0; position: relative; z-index: 2; cursor: pointer;
            -webkit-appearance: none; background: transparent; 
        }
        input[type="range"]::-webkit-slider-runnable-track {
            background: rgba(0,0,0,0.05); height: 6px; border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; background: var(--excel-blue); width: 16px; height: 16px; border-radius: 50%;
            margin-top: -5px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .adjust-val-box { display: flex; align-items: center; gap: 5px; font-weight: bold; background: #f0f8ff; padding: 5px 10px; border-radius: 4px; border: 1px solid #2f5597; color: #2f5597; z-index: 2; }
        .adjust-val-box input { width: 60px; text-align: right; border: none; font-size: 16px; font-weight: bold; color: #2f5597; outline: none; background: transparent; }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ä¸‹ã®è©³ç´°æƒ…å ± */
        #dist-info {
            font-size: 12px; color: #444; background: #f9f9f9; padding: 5px 10px; border-radius: 4px; min-height: 24px;
            display: flex; align-items: center; border: 1px solid #eee;
        }
        .dist-highlight { color: #2f5597; font-weight: bold; margin-right: 5px; }

        @keyframes blink-red {
            0% { color: #dc2626; opacity: 1; }
            50% { color: #dc2626; opacity: 0.4; }
            100% { color: #dc2626; opacity: 1; }
        }
        .overdue-blink {
            animation: blink-red 1s infinite;
            color: #dc2626 !important;
            font-weight: bold;
        }
        /* å®Ÿç¸¾å‚ç…§ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .ref-checkbox { width: 20px; text-align: center; }
        .ref-checkbox input[type="checkbox"] { width: auto; }
        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¹…èª¿æ•´ã®ãŸã‚ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€åˆã®åˆ—ã‚‚èª¿æ•´ */
        .ref-table thead tr th:first-child { width: 25px; } 

        /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º (8hè¶…ãˆ) - æ—¥ä»˜ã‚»ãƒ«ã®ã¿é©ç”¨ */
        .over-limit { background-color: var(--overload-bg) !important; color: var(--overload-col) !important; font-weight: bold; }
        .over-limit input { color: var(--overload-col) !important; font-weight: bold; }
        
        /* æ—¥å ±ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .report-table th, .report-table td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
        .report-table th { background: #f2f2f2; font-weight: bold; text-align: center; }
        .report-table .num-cell { text-align: right; }
        .report-over-limit { background-color: var(--overload-bg); color: var(--overload-col); font-weight: bold; }
        .report-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="controls">
        <h2 style="margin: 0 10px 0 0; font-size: 14px;">å·¥æ•°ç®¡ç†</h2>
        <button class="primary" onclick="addTask()">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
        <button onclick="downloadJSON()">ğŸ“¥ ä¿å­˜</button>
        <button onclick="document.getElementById('fileIn').click()">ğŸ“¤ èª­è¾¼</button>
        <button onclick="openReport()">ğŸ“Š æ—¥å ±</button> 
        <input type="file" id="fileIn" style="display:none" accept=".json" onchange="uploadJSON(event)">
        
        <span id="tracker-status" style="margin-left:20px; font-weight:bold; color:#dc2626;"></span>

        <div class="usage-guide">
            <div class="guide-item"><b>ä½¿ã„æ–¹:</b> å³å´ã®æ—¥ä»˜åˆ—ã«æ—¥ã€…ã®å·¥æ•°(h)ã‚’å…¥åŠ›</div>
            <div class="guide-item"><span class="guide-icon">ğŸ“</span>ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</div>
            <div class="guide-item"><span class="guide-icon">ğŸ“„</span>ãƒ¡ãƒ¢</div>
            <div class="guide-item"><span class="guide-icon">â–¶</span>ã‚¿ã‚¤ãƒãƒ¼</div>
            <div class="guide-item"><span class="guide-icon">ğŸ”</span>å®Ÿç¸¾å‚ç…§</div>
            <div class="guide-item" style="color:var(--overload-col); font-weight:bold;">â– éè² è·(>8h)</div>
        </div>
    </div>

    <div class="main-container">
        <div class="wbs-area">
            <div class="header row">
                <div class="cell col-no">No</div>
                <div class="cell col-title">ã‚¿ã‚¹ã‚¯</div>
                <div class="cell col-owner">
                    æ‹…å½“ <span id="filter-btn" class="filter-icon" onclick="toggleFilterMenu(event)">â–¼</span>
                    <div id="filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-date">
                    é–‹å§‹æ—¥ <span id="date-filter-btn" class="filter-icon" onclick="toggleDateFilterMenu(event)">â–¼</span>
                    <div id="date-filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-date">æœŸé™</div>
                <div class="cell col-h">è¦‹ç©(h)</div>
                <div class="cell col-h">åˆè¨ˆ(h)</div>
                <div class="cell col-h">æ®‹ã‚Š(h)</div>
                <div class="cell col-ratio">è¦‹ç©æ¯”</div>
                <div class="cell col-progress">
                    é€²æ— <span id="prog-filter-btn" class="filter-icon" onclick="toggleProgressFilterMenu(event)">â–¼</span>
                    <div id="prog-filter-menu" class="filter-menu" onclick="event.stopPropagation()"></div>
                </div>
                <div class="cell col-op">æ“ä½œ</div>
            </div>
            <div id="wbs-body-container">
                <div id="wbs-body"></div>
            </div>
        </div>
        <div class="gantt-area" id="gantt-container">
            <div id="gantt-grid" class="gantt-grid">
                <div id="gantt-header" class="header row"></div>
                <div id="gantt-body" style="position:relative;"></div>
            </div>
        </div>
    </div>

    <div id="memo-modal" class="modal-overlay">
        <div class="modal-content" style="width: 650px;">
            <h3 id="memo-title">ãƒ¡ãƒ¢</h3>
            <textarea id="memo-text" placeholder="è©³ç´°ãªãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            <div class="modal-btns">
                <button onclick="closeMemo()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="btn-save-memo" class="primary" onclick="saveMemo()">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- å®Ÿç¸¾å‚ç…§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ref-modal" class="modal-overlay">
        <div class="modal-content" style="width: 750px;">
            <h3>éå»å®Ÿç¸¾ã®å‚ç…§</h3>
            <div class="search-row">
                <input type="text" id="ref-search-key" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ANDæ¤œç´¢)..." oninput="searchRef()">
                <select id="ref-search-owner" onchange="searchRef()">
                    <option value="">(å…¨æ‹…å½“è€…)</option>
                </select>
                <select id="ref-search-status" onchange="searchRef()">
                    <option value="">(å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)</option>
                    <option value="complete">å®Œäº†ã®ã¿ (100%)</option>
                    <option value="incomplete">æœªå®Œäº†ã®ã¿</option>
                </select>
            </div>
            
            <div class="ref-summary" id="ref-summary-area" style="display:none;">
                <span><b>çµæœ:</b> <span id="ref-count">0</span>ä»¶</span> | 
                <span>å¹³å‡: <b id="ref-avg">0.0</b>h</span> <button class="select-btn" onclick="selectRefVal('avg')">å¹³å‡ã‚’é¸æŠ</button> |
                <span>æœ€å¤§: <b id="ref-max">0.0</b>h</span> <button class="select-btn" onclick="selectRefVal('max')">æœ€å¤§ã‚’é¸æŠ</button>
            </div>

            <div class="ref-result-area">
                <table class="ref-table">
                    <thead>
                        <tr>
                            <th style="width:25px;"><input type="checkbox" id="select-all-ref" onchange="toggleSelectAll(this.checked)"></th>
                            <th style="width:130px;">è¦ªã‚¿ã‚¹ã‚¯</th>
                            <th>ã‚¿ã‚¹ã‚¯å</th>
                            <th style="width:50px; text-align:center;">ãƒ¡ãƒ¢</th>
                            <th style="width:70px;">æ‹…å½“</th>
                            <th style="width:50px;">å®Ÿç¸¾</th>
                            <th style="width:40px;">é€²æ—</th>
                            <th style="width:60px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="ref-table-body"></tbody>
                </table>
            </div>

            <div class="ref-adjust-area">
                <div style="font-weight:bold; font-size:12px; color:#2f5597; margin-bottom:0px;">
                    â–¼ è¦‹ç©å·¥æ•°ã®èª¿æ•´ãƒ»æ±ºå®š (èƒŒæ™¯åˆ†å¸ƒ: <span style="color:rgba(47, 85, 151, 0.6)">â– å®Ÿç¸¾æ•°</span> <span style="color:red; font-weight:bold;">: å¹³å‡</span>)
                </div>
                <div class="adjust-controls">
                    <div class="adjust-val-box">
                        <input type="number" id="adjust-num" value="0" min="0" step="0.1" oninput="syncSlider(this.value)"> h
                    </div>
                    <div class="slider-wrapper" id="slider-wrapper">
                        <canvas id="dist-canvas"></canvas>
                        <input type="range" id="adjust-slider" min="0" max="20" step="0.1" value="0" oninput="syncNum(this.value)">
                    </div>
                    <button class="primary" onclick="applyRefAdjusted()">æ±ºå®š</button>
                </div>
                <!-- é¸æŠä½ç½®ã®è©³ç´°æƒ…å ± -->
                <div id="dist-info">â†‘ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã™ã¨ã€ãã®å€¤ã«è¿‘ã„éå»å®Ÿç¸¾ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>

            <div class="modal-btns">
                <button onclick="closeRef()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- è¿½åŠ : æ—¥å ±é›†è¨ˆç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="report-modal" class="modal-overlay">
        <div class="modal-content" style="width: 800px; height: 80%; display:flex; flex-direction:column;">
            <h3>æ‹…å½“è€…åˆ¥ãƒ»æ—¥æ¬¡å®Ÿç¸¾é›†è¨ˆ</h3>
            <div class="report-controls">
                <label>å¯¾è±¡æœˆ: <input type="month" id="report-month" onchange="renderReportContent()"></label>
                <button onclick="copyReportToClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div style="flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="width:100px;">æ—¥ä»˜</th>
                            <th style="width:100px;">æ‹…å½“è€…</th>
                            <th>ã‚¿ã‚¹ã‚¯å†…è¨³</th>
                            <th style="width:60px;">åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="report-body"></tbody>
                </table>
            </div>
            <div class="modal-btns" style="margin-top:15px;">
                <button onclick="document.getElementById('report-modal').style.display='none'">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰storageã‚­ãƒ¼ã‚’ç”Ÿæˆ
        function getStorageKey() {
            const path = window.location.pathname;
            const fileName = path.split('/').pop().replace('.html', '') || 'default';
            return `workload-mgmt-v30-final-with-heatmap`; 
        }
        
        let tasks = JSON.parse(localStorage.getItem(getStorageKey())) || [
            { id: 1, title: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†', owner: '', start: getLocalDateStr(), end: getLocalDateStr(), est: 0, progress: 0, isGroup: true, hours: {}, memo: "" }
        ];

        let trackingId = null;
        let trackingStartTime = null;
        let timerInterval = null;
        let dragIdx = null;
        let currentMemoId = null;
        let currentRefTaskId = null;

        // æ¤œç´¢çµæœã®å®Ÿç¸¾å€¤ã‚’ä¸€æ™‚ä¿å­˜
        let currentRefResults = [];

        let visibleOwners = null; 
        let visibleProgress = null;
        let visibleStartDate = null; 
        
        let dailyLoadMap = {};
        const OVERLOAD_LIMIT = 8; 

        const ganttContainer = document.getElementById('gantt-container');
        const wbsBodyContainer = document.getElementById('wbs-body-container');
        ganttContainer.addEventListener('scroll', () => { wbsBodyContainer.scrollTop = ganttContainer.scrollTop; });

        document.addEventListener('click', function(e) {
            const menu = document.getElementById('filter-menu');
            const btn = document.getElementById('filter-btn');
            if (menu.style.display === 'flex' && e.target !== btn && !menu.contains(e.target)) { menu.style.display = 'none'; }
            const pMenu = document.getElementById('prog-filter-menu');
            const pBtn = document.getElementById('prog-filter-btn');
            if (pMenu.style.display === 'flex' && e.target !== pBtn && !pMenu.contains(e.target)) { pMenu.style.display = 'none'; }
            const dMenu = document.getElementById('date-filter-menu');
            const dBtn = document.getElementById('date-filter-btn');
            if (dMenu.style.display === 'flex' && e.target !== dBtn && !dMenu.contains(e.target)) { dMenu.style.display = 'none'; }
        });

        const ICON_GROUP = `<svg viewBox="0 0 24 24"><path d="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z"/></svg>`;
        const ICON_DELETE = `<svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>`;
        const ICON_START = `<svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>`;
        const ICON_STOP = `<svg viewBox="0 0 24 24"><path d="M18,18H6V6H18V18Z"/></svg>`;
        const ICON_MEMO = `<svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13,9V3.5L18.5,9H13Z"/></svg>`;

        function getLocalDateStr() { return new Date().toLocaleDateString('sv-SE'); }
        function formatDateForDisplay(d) { return d ? d.replace(/-/g, '/') : ""; }

        function updateLogic() {
            let major = 0, minor = 0;
            // Noæ¡ç•ª
            tasks.forEach(t => {
                if (t.isGroup) { major++; minor = 0; t.no = major.toString(); }
                else { minor++; t.no = major === 0 ? minor.toString() : `${major}.${minor}`; }
            });
            // é›†è¨ˆ
            for (let i = 0; i < tasks.length; i++) {
                let tEst = 0, tSum = 0, weightedProg = 0, minS = null, maxE = null, hasChild = false;
                if (tasks[i].isGroup) {
                    for (let j = i + 1; j < tasks.length; j++) {
                        if (tasks[j].isGroup) break;
                        hasChild = true;
                        let child = tasks[j];
                        let childSum = Object.values(child.hours).reduce((a, b) => a + Number(b), 0);
                        tEst += Number(child.est || 0);
                        tSum += childSum;
                        weightedProg += (Number(child.progress || 0) * Number(child.est || 0));
                        if (!minS || (child.start && child.start < minS)) minS = child.start;
                        if (!maxE || (child.end && child.end > maxE)) maxE = child.end;
                    }
                    if (hasChild) {
                        tasks[i].est = tEst;
                        if(minS) tasks[i].start = minS;
                        if(maxE) tasks[i].end = maxE;
                        tasks[i].progress = tEst > 0 ? Math.round(weightedProg / tEst) : 0;
                        tasks[i].computedSum = tSum;
                    } else { tasks[i].computedSum = Object.values(tasks[i].hours).reduce((a, b) => a + Number(b), 0); }
                } else { tasks[i].computedSum = Object.values(tasks[i].hours).reduce((a, b) => a + Number(b), 0); }
            }
            
            // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”¨é›†è¨ˆ
            dailyLoadMap = {};
            tasks.forEach(t => {
                if (!t.isGroup && t.owner) {
                    const owner = t.owner;
                    if (!dailyLoadMap[owner]) dailyLoadMap[owner] = {};
                    
                    Object.keys(t.hours).forEach(date => {
                        const val = parseFloat(t.hours[date]);
                        if (!isNaN(val)) {
                            dailyLoadMap[owner][date] = (dailyLoadMap[owner][date] || 0) + val;
                        }
                    });
                }
            });
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿é–¢æ•°ç¾¤ï¼ˆçœç•¥ï¼‰ */
        function toggleFilterMenu(e) { /* çœç•¥ */ e.stopPropagation(); document.getElementById('prog-filter-menu').style.display = 'none'; document.getElementById('date-filter-menu').style.display = 'none'; const menu = document.getElementById('filter-menu'); if (menu.style.display === 'flex') { menu.style.display = 'none'; return; } const owners = new Set(); tasks.forEach(t => owners.add(t.owner || "")); const sortedOwners = Array.from(owners).sort(); menu.innerHTML = ''; const allBtnDiv = document.createElement('div'); allBtnDiv.style.padding = "4px"; allBtnDiv.style.borderBottom = "1px solid #eee"; allBtnDiv.style.marginBottom = "4px"; allBtnDiv.style.display = "flex"; allBtnDiv.style.gap = "10px"; allBtnDiv.style.justifyContent = "center"; const btnAll = document.createElement('button'); btnAll.innerText = "ã™ã¹ã¦"; btnAll.onclick = () => menu.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = true); const btnClear = document.createElement('button'); btnClear.innerText = "è§£é™¤"; btnClear.onclick = () => menu.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false); allBtnDiv.appendChild(btnAll); allBtnDiv.appendChild(btnClear); menu.appendChild(allBtnDiv); sortedOwners.forEach(owner => { const val = owner === "" ? "(æœªå‰²å½“)" : owner; const label = document.createElement('label'); const chk = document.createElement('input'); chk.type = "checkbox"; chk.value = owner; if (visibleOwners === null || visibleOwners.has(owner)) chk.checked = true; const span = document.createElement('span'); span.innerText = val; label.appendChild(chk); label.appendChild(span); menu.appendChild(label); }); const actionDiv = document.createElement('div'); actionDiv.className = 'filter-actions'; const applyBtn = document.createElement('button'); applyBtn.className = 'primary'; applyBtn.innerText = "é©ç”¨"; applyBtn.onclick = () => { const checked = menu.querySelectorAll('input[type="checkbox"]:checked'); if (checked.length === sortedOwners.length) { visibleOwners = null; document.getElementById('filter-btn').classList.remove('filter-active'); } else { visibleOwners = new Set(); checked.forEach(c => visibleOwners.add(c.value)); document.getElementById('filter-btn').classList.add('filter-active'); } menu.style.display = 'none'; render(); }; actionDiv.appendChild(applyBtn); menu.appendChild(actionDiv); menu.style.display = 'flex'; }
        function toggleProgressFilterMenu(e) { /* çœç•¥ */ e.stopPropagation(); document.getElementById('filter-menu').style.display = 'none'; document.getElementById('date-filter-menu').style.display = 'none'; const menu = document.getElementById('prog-filter-menu'); if (menu.style.display === 'flex') { menu.style.display = 'none'; return; } menu.innerHTML = ''; const options = [ { val: 'incomplete', text: 'æœªå®Œäº†' }, { val: 'complete', text: 'å®Œäº† (100%)' } ]; const allBtnDiv = document.createElement('div'); allBtnDiv.style.padding = "4px"; allBtnDiv.style.borderBottom = "1px solid #eee"; allBtnDiv.style.marginBottom = "4px"; allBtnDiv.style.display = "flex"; allBtnDiv.style.gap = "10px"; allBtnDiv.style.justifyContent = "center"; const btnAll = document.createElement('button'); btnAll.innerText = "ã™ã¹ã¦"; btnAll.onclick = () => menu.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = true); const btnClear = document.createElement('button'); btnClear.innerText = "è§£é™¤"; btnClear.onclick = () => menu.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false); allBtnDiv.appendChild(btnAll); allBtnDiv.appendChild(btnClear); menu.appendChild(allBtnDiv); options.forEach(opt => { const label = document.createElement('label'); const chk = document.createElement('input'); chk.type = "checkbox"; chk.value = opt.val; if (visibleProgress === null || visibleProgress.has(opt.val)) chk.checked = true; const span = document.createElement('span'); span.innerText = opt.text; label.appendChild(chk); label.appendChild(span); menu.appendChild(label); }); const actionDiv = document.createElement('div'); actionDiv.className = 'filter-actions'; const applyBtn = document.createElement('button'); applyBtn.className = 'primary'; applyBtn.innerText = "é©ç”¨"; applyBtn.onclick = () => { const checked = menu.querySelectorAll('input[type="checkbox"]:checked'); if (checked.length === options.length) { visibleProgress = null; document.getElementById('prog-filter-btn').classList.remove('filter-active'); } else { visibleProgress = new Set(); checked.forEach(c => visibleProgress.add(c.value)); document.getElementById('prog-filter-btn').classList.add('filter-active'); } menu.style.display = 'none'; render(); }; actionDiv.appendChild(applyBtn); menu.appendChild(actionDiv); menu.style.display = 'flex'; }
        function toggleDateFilterMenu(e) { /* çœç•¥ */ e.stopPropagation(); document.getElementById('filter-menu').style.display = 'none'; document.getElementById('prog-filter-menu').style.display = 'none'; const menu = document.getElementById('date-filter-menu'); if (menu.style.display === 'flex') { menu.style.display = 'none'; return; } menu.innerHTML = ''; const divContainer = document.createElement('div'); divContainer.className = 'date-filter-container'; divContainer.innerHTML = '<div style="margin-bottom:4px; font-weight:bold; font-size:11px;">æŒ‡å®šæ—¥ä»¥é™ã‚’è¡¨ç¤º:</div>'; const dateInput = document.createElement('input'); dateInput.type = 'date'; dateInput.className = 'date-filter-input'; if (visibleStartDate) dateInput.value = visibleStartDate; divContainer.appendChild(dateInput); menu.appendChild(divContainer); const actionDiv = document.createElement('div'); actionDiv.className = 'filter-actions'; const applyBtn = document.createElement('button'); applyBtn.className = 'primary'; applyBtn.innerText = "é©ç”¨"; applyBtn.onclick = () => { const val = dateInput.value; if (val) { visibleStartDate = val; document.getElementById('date-filter-btn').classList.add('filter-active'); } else { visibleStartDate = null; document.getElementById('date-filter-btn').classList.remove('filter-active'); } menu.style.display = 'none'; render(); }; const clearBtn = document.createElement('button'); clearBtn.innerText = "è§£é™¤"; clearBtn.onclick = () => { visibleStartDate = null; document.getElementById('date-filter-btn').classList.remove('filter-active'); menu.style.display = 'none'; render(); }; actionDiv.appendChild(applyBtn); actionDiv.appendChild(clearBtn); menu.appendChild(actionDiv); menu.style.display = 'flex'; }

        function render() {
            updateLogic();
            localStorage.setItem(getStorageKey(), JSON.stringify(tasks));
            const wbsBody = document.getElementById('wbs-body');
            const ganttHead = document.getElementById('gantt-header');
            const ganttBody = document.getElementById('gantt-body');
            wbsBody.innerHTML = ganttHead.innerHTML = ganttBody.innerHTML = "";

            const todayStr = getLocalDateStr();
            const todayObj = new Date(todayStr);
            const allDates = tasks.flatMap(t => [new Date(t.start), new Date(t.end)]);
            let minD = new Date(Math.min(...allDates, todayObj));
            minD.setDate(minD.getDate() - 5);
            let maxD = new Date(Math.max(...allDates, todayObj));
            maxD.setDate(maxD.getDate() + 25);

            const dateList = [];
            for (let d = new Date(minD); d <= maxD; d.setDate(d.getDate() + 1)) {
                const curStr = d.toLocaleDateString('sv-SE');
                dateList.push({ str: curStr, label: `${d.getMonth()+1}/${d.getDate()}`, w: d.getDay(), isToday: curStr === todayStr });
            }

            dateList.forEach(d => {
                const h = document.createElement('div');
                h.className = `cell day-cell ${d.w===6?'sat':d.w===0?'sun':''} ${d.isToday?'is-today-h':''}`;
                if(d.isToday) h.id = "today-target";
                h.innerText = d.label;
                ganttHead.appendChild(h);
            });

            const todayIdx = dateList.findIndex(d => d.isToday);
            if (todayIdx !== -1) {
                const line = document.createElement('div');
                line.className = 'today-line';
                line.style.left = (todayIdx * 55) + 'px'; 
                ganttBody.appendChild(line);
            }

            const selfMatches = new Array(tasks.length).fill(false);
            for(let i=0; i<tasks.length; i++) {
                const t = tasks[i];
                let ownerOk = visibleOwners ? visibleOwners.has(t.owner || "") : true;
                let progOk = visibleProgress ? visibleProgress.has((Number(t.progress)>=100)?'complete':'incomplete') : true;
                let dateOk = visibleStartDate ? (!t.start || t.start >= visibleStartDate) : true;
                selfMatches[i] = ownerOk && progOk && dateOk;
            }

            const visibleIndices = new Set();
            for(let i=0; i<tasks.length; i++) {
                if (!tasks[i].isGroup) {
                    if (selfMatches[i]) visibleIndices.add(i);
                } else {
                    let groupVisible = selfMatches[i];
                    if (!groupVisible) {
                        for(let j=i+1; j<tasks.length; j++) {
                            if (tasks[j].isGroup) break;
                            if (selfMatches[j]) { groupVisible = true; break; }
                        }
                    }
                    if (groupVisible) visibleIndices.add(i);
                }
            }

            tasks.forEach((t, idx) => {
                if (!visibleIndices.has(idx)) return;

                const isTracking = trackingId === t.id;
                const remain = (Number(t.est || 0) - t.computedSum).toFixed(1);
                const ratio = t.est > 0 ? Math.round((t.computedSum / t.est) * 100) : 0;
                const hasMemo = t.memo && t.memo.trim().length > 0;

                const wRow = document.createElement('div');
                wRow.className = 'row' + (t.isGroup ? ' group-row' : '') + (isTracking ? ' tracking-active' : '');
                wRow.draggable = true;
                wRow.ondragstart = () => dragIdx = idx;
                wRow.ondragover = (e) => e.preventDefault();
                wRow.ondrop = () => { const move = tasks.splice(dragIdx, 1)[0]; tasks.splice(idx, 0, move); render(); };

                const dateCell = (f) => {
                    const val = t[f];
                    const isOverdue = f === 'end' && val && val < todayStr && (Number(t.progress)||0) < 100;
                    const overdueClass = isOverdue ? ' overdue-blink' : '';

                    if (t.isGroup) {
                        return `<span class="date-display-text${overdueClass}">${formatDateForDisplay(val)}</span>`;
                    } else {
                        return `<input type="text" class="date-input${overdueClass}" value="${formatDateForDisplay(val)}" onfocus="(this.type='date')" onblur="(this.type='text'); this.value='${formatDateForDisplay(val)}'" onchange="upd(${t.id},'${f}',this.value)">`;
                    }
                };

                const progValue = Number(t.progress || 0);
                const progressCellContent = t.isGroup 
                    ? `<span>${progValue}%</span>` 
                    : `<input type="number" min="0" max="100" value="${progValue}" onfocus="this.value=this.value.replace('%','')" onblur="this.value=this.value+'%'" onchange="upd(${t.id},'progress',this.value)">`;

                wRow.innerHTML = `
                    <div class="cell col-no">${t.no}</div>
                    <div class="cell col-title" style="padding-left:${t.isGroup?'4px':'20px'}"><input value="${t.title}" onchange="upd(${t.id},'title',this.value)"></div>
                    <div class="cell col-owner"><input value="${t.owner}" onchange="upd(${t.id},'owner',this.value)" ${t.isGroup?'readonly':''}></div>
                    <div class="cell col-date">${dateCell('start')}</div>
                    <div class="cell col-date">${dateCell('end')}</div>
                    
                    <div class="cell col-h">
                        <input type="number" min="0" step="0.1" value="${Number(t.est || 0).toFixed(1)}" onchange="upd(${t.id},'est',this.value)" ${t.isGroup?'readonly':''}>
                        ${!t.isGroup ? `<div class="icon-ref" onclick="openRef(${t.id})" title="å®Ÿç¸¾å‚ç…§">ğŸ”</div>` : ''}
                    </div>
                    
                    <div class="cell col-h center" style="font-weight:bold">${t.computedSum.toFixed(1)}</div>
                    <div class="cell col-h center" style="color:${remain<0?'red':'inherit'}">${remain}</div>
                    <div class="cell col-ratio center" style="color:${ratio>100?'red':'inherit'}">${ratio}%</div>
                    <div class="cell col-progress">${t.isGroup ? `<div style="text-align:center;">${progValue}%</div>` : `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;"><input type="number" min="0" max="100" value="${progValue}" onchange="upd(${t.id},'progress',this.value)" style="width:100%;text-align:center;"><span style="margin-left:2px;flex-shrink:0;">%</span></div>`}</div>
                    <div class="cell col-op">
                        <div class="icon-btn icon-group" onclick="toggleGrp(${t.id})" title="ã‚°ãƒ«ãƒ¼ãƒ—åŒ–åˆ‡æ›¿">${ICON_GROUP}</div>
                        <div class="icon-btn icon-memo ${hasMemo?'has-content':''}" onclick="openMemo(${t.id})" title="ãƒ¡ãƒ¢ã‚’é–‹ã">${ICON_MEMO}</div>
                        ${!t.isGroup ? (isTracking ? `<div class="icon-btn icon-timer stop" onclick="stopTracking()" title="è¨ˆæ¸¬ã‚’åœæ­¢ã—ã¦å·¥æ•°ã‚’å…¥åŠ›">${ICON_STOP}</div>` : `<div class="icon-btn icon-timer start" onclick="startTracking(${t.id})" title="è¨ˆæ¸¬ã‚’é–‹å§‹">${ICON_START}</div>`) : ''}
                        <div class="icon-btn icon-delete" onclick="delT(${t.id})" title="å‰Šé™¤">${ICON_DELETE}</div>
                    </div>
                `;
                wbsBody.appendChild(wRow);

                const gRow = document.createElement('div');
                gRow.className = 'row' + (t.isGroup ? ' group-row' : '');
                dateList.forEach(d => {
                    const valRaw = t.hours[d.str];
                    const val = (valRaw !== undefined) ? valRaw.toFixed(1) : "";
                    const inR = d.str >= t.start && d.str <= t.end;

                    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åˆ¤å®š (8hè¶…ãˆ)
                    let isOver = false;
                    let totalLoad = 0;
                    if (!t.isGroup && t.owner && dailyLoadMap[t.owner] && dailyLoadMap[t.owner][d.str]) {
                        totalLoad = dailyLoadMap[t.owner][d.str];
                        if (totalLoad > OVERLOAD_LIMIT) {
                            isOver = true;
                        }
                    }

                    const c = document.createElement('div');
                    c.className = `cell day-cell ${d.w===6?'sat':d.w===0?'sun':''} ${inR?'in-range':''} ${d.isToday?'is-today-col':''} ${isOver ? 'over-limit' : ''}`;
                    if (isOver) c.title = `æ‹…å½“:${t.owner} åˆè¨ˆ:${totalLoad.toFixed(1)}h (éè² è·)`;
                    
                    if (!t.isGroup) {
                        const inv = document.createElement('input');
                        inv.type = "number"; inv.min = "0"; inv.step = "0.1"; inv.className = "hour-input";
                        inv.value = val;
                        inv.onchange = (e) => updHr(t.id, d.str, e.target.value);
                        c.appendChild(inv);
                    }
                    gRow.appendChild(c);
                });
                ganttBody.appendChild(gRow);
            });
        }

        /* ä»¥ä¸‹ã€ãƒ¡ãƒ¢æ©Ÿèƒ½ãƒ»é€²æ—æ›´æ–°ãƒ»å®Ÿç¸¾å‚ç…§ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã€ã‚°ãƒ©ãƒ•ï¼‰ãƒ»æ—¥å ± */
        function openMemo(id) {
            const t = tasks.find(x => x.id === id); if(!t) return;
            currentMemoId = id;
            document.getElementById('memo-title').innerText = `ãƒ¡ãƒ¢: ${t.title}`;
            document.getElementById('memo-text').value = t.memo || "";
            document.getElementById('memo-text').readOnly = false;
            document.getElementById('btn-save-memo').style.display = 'inline-block';
            document.getElementById('memo-modal').style.display = 'flex';
        }
        function viewRefMemo(index) {
            if (!currentRefResults[index]) return;
            const t = currentRefResults[index].task;
            document.getElementById('memo-title').innerText = `ãƒ¡ãƒ¢å‚ç…§: ${t.title}`;
            document.getElementById('memo-text').value = t.memo || "";
            document.getElementById('memo-text').readOnly = true;
            document.getElementById('btn-save-memo').style.display = 'none';
            document.getElementById('memo-modal').style.display = 'flex';
        }
        function closeMemo() { document.getElementById('memo-modal').style.display = 'none'; currentMemoId = null; }
        function saveMemo() {
            if (currentMemoId === null) return;
            const t = tasks.find(x => x.id === currentMemoId);
            if (t) { t.memo = document.getElementById('memo-text').value; render(); }
            closeMemo();
        }

        function upd(id, f, v) { 
            const t = tasks.find(x => x.id === id); 
            if(t) { 
                if((f==='est' || f==='progress') && v < 0) v = 0; 
                if (f === 'progress') {
                    const oldProgress = Number(t.progress || 0);
                    const newProgress = Number(v);
                    
                    // 99%ä»¥ä¸Šã‹ã‚‰100%ã¸ã®å¤‰æ›´ã‚’æ¤œå‡º
                    if (newProgress >= 100 && oldProgress < 100) {
                        t[f] = 100; 
                        render(); 
                        const confirmMsg = `ã‚¿ã‚¹ã‚¯ã€Œ${t.title}ã€ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\næŒ¯ã‚Šè¿”ã‚Šã¨ã—ã¦ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        if (confirm(confirmMsg)) { openMemo(id); }
                        return;
                    } else if (Number(v) >= 100) {
                        t[f] = 100;
                    } else {
                        t[f] = Number(v);
                    }
                } else { t[f] = v; }
                render(); 
            } 
        }

        function openRef(id) {
            const t = tasks.find(x => x.id === id); if(!t) return;
            currentRefTaskId = id;
            document.getElementById('ref-search-key').value = t.title; 
            const owners = new Set();
            tasks.forEach(task => { if(task.owner) owners.add(task.owner); });
            const sel = document.getElementById('ref-search-owner');
            sel.innerHTML = '<option value="">(å…¨æ‹…å½“è€…)</option>';
            Array.from(owners).sort().forEach(o => {
                const opt = document.createElement('option');
                opt.value = o; opt.innerText = o;
                sel.appendChild(opt);
            });
            document.getElementById('ref-search-status').value = "";
            setAdjustVal(0); drawDistribution([], 20); updateDistInfo(0);
            document.getElementById('ref-modal').style.display = 'flex';
            searchRef(); 
        }
        function closeRef() { document.getElementById('ref-modal').style.display = 'none'; currentRefTaskId = null; }
        function toggleSelectAll(checked) { currentRefResults.forEach(r => r.isSelected = checked); renderRefList(); recalculateSummary(); }
        function toggleRefSelection(index, checked) {
            if (currentRefResults[index]) {
                currentRefResults[index].isSelected = checked;
                recalculateSummary();
                const selectAll = document.getElementById('select-all-ref');
                const selectedCount = currentRefResults.filter(r => r.isSelected).length;
                const totalCount = currentRefResults.length;
                if (totalCount === 0) { selectAll.checked = false; selectAll.indeterminate = false; } 
                else if (selectedCount === totalCount) { selectAll.checked = true; selectAll.indeterminate = false; } 
                else if (selectedCount > 0) { selectAll.checked = false; selectAll.indeterminate = true; } 
                else { selectAll.checked = false; selectAll.indeterminate = false; }
            }
        }
        function searchRef() {
            const rawKey = document.getElementById('ref-search-key').value;
            const keywords = rawKey.trim() ? rawKey.toLowerCase().trim().split(/[\sã€€]+/) : [];
            const ownerFilter = document.getElementById('ref-search-owner').value;
            const statusFilter = document.getElementById('ref-search-status').value;
            currentRefResults = []; 
            let currentParentTitle = "-";
            tasks.forEach(t => {
                if (t.isGroup) { currentParentTitle = t.title; } else {
                    if (t.id !== currentRefTaskId && t.computedSum > 0) {
                        const searchTarget = (currentParentTitle + " " + t.title).toLowerCase();
                        const isMatch = keywords.length === 0 || keywords.every(k => searchTarget.includes(k));
                        if (!isMatch) return;
                        if (ownerFilter && t.owner !== ownerFilter) return;
                        const isComplete = (Number(t.progress) >= 100);
                        if (statusFilter === 'complete' && !isComplete) return;
                        if (statusFilter === 'incomplete' && isComplete) return;
                        currentRefResults.push({ task: t, parent: currentParentTitle, isComplete: isComplete, isSelected: true });
                    }
                }
            });
            document.getElementById('select-all-ref').checked = currentRefResults.length > 0;
            document.getElementById('select-all-ref').indeterminate = false;
            renderRefList(); recalculateSummary();
        }
        function renderRefList() {
            const tbody = document.getElementById('ref-table-body');
            tbody.innerHTML = "";
            currentRefResults.forEach((item, index) => {
                const t = item.task;
                const memoCell = t.memo ? `<button class="icon-btn" style="width:24px;height:24px; margin:0 auto;" onclick="viewRefMemo(${index})" title="ãƒ¡ãƒ¢ã‚’è¡¨ç¤º">ğŸ“„</button>` : "-";
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="ref-checkbox"><input type="checkbox" onchange="toggleRefSelection(${index}, this.checked)" ${item.isSelected ? 'checked' : ''}></td><td style="color:#555; font-size:11px;">${item.parent}</td><td>${t.title}</td><td style="text-align:center;">${memoCell}</td><td>${t.owner || '-'}</td><td>${t.computedSum.toFixed(1)}h</td><td style="color:${item.isComplete?'#2f5597':'#d97706'}">${t.progress}%</td><td><button class="select-btn" onclick="setAdjustVal(${t.computedSum})">é¸æŠ</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function recalculateSummary() {
            const selectedResults = currentRefResults.filter(r => r.isSelected);
            let count = selectedResults.length;
            let sum = 0, max = 0;
            if (count > 0) {
                sum = selectedResults.reduce((a, b) => a + b.task.computedSum, 0);
                max = Math.max(...selectedResults.map(r => r.task.computedSum));
                const avg = sum / count;
                document.getElementById('ref-count').innerText = count; document.getElementById('ref-avg').innerText = avg.toFixed(1); document.getElementById('ref-max').innerText = max.toFixed(1); document.getElementById('ref-summary-area').style.display = 'flex';
                const distData = selectedResults.map(r => ({ val: r.task.computedSum, isComplete: r.isComplete }));
                const slider = document.getElementById('adjust-slider');
                drawDistribution(distData, Math.max(20, Math.ceil(max * 2)), avg);
                const currentVal = parseFloat(slider.value);
                if (Math.abs(currentVal - avg) > 1.0) { setAdjustVal(avg); } else { updateDistInfo(currentVal); }
            } else {
                document.getElementById('ref-count').innerText = 0; document.getElementById('ref-avg').innerText = "0.0"; document.getElementById('ref-max').innerText = "0.0"; document.getElementById('ref-summary-area').style.display = 'none';
                drawDistribution([], 20); updateDistInfo(0); setAdjustVal(0);
            }
        }
        function selectRefVal(type) {
            const valStr = document.getElementById(type === 'avg' ? 'ref-avg' : 'ref-max').innerText;
            const val = parseFloat(valStr); if(!isNaN(val)) setAdjustVal(val);
        }
        function setAdjustVal(val) {
            val = parseFloat(val); if(isNaN(val) || val < 0) val = 0;
            const selectedVals = currentRefResults.filter(r => r.isSelected).map(r => r.task.computedSum);
            const maxRef = selectedVals.length > 0 ? Math.max(...selectedVals) : 0;
            const maxVal = Math.max(20, Math.ceil(Math.max(val*2, maxRef, 0) || 20));
            const slider = document.getElementById('adjust-slider');
            slider.max = maxVal; slider.value = val; document.getElementById('adjust-num').value = val.toFixed(1);
            let avg = 0; if (selectedVals.length > 0) { avg = selectedVals.reduce((a,b) => a + b, 0) / selectedVals.length; }
            const distData = currentRefResults.filter(r => r.isSelected).map(r => ({ val: r.task.computedSum, isComplete: r.isComplete }));
            drawDistribution(distData, maxVal, avg);
            updateDistInfo(val);
        }
        function syncSlider(val) { document.getElementById('adjust-slider').value = val; updateDistInfo(val); }
        function syncNum(val) { document.getElementById('adjust-num').value = parseFloat(val).toFixed(1); updateDistInfo(val); }
        function updateDistInfo(val) {
            val = parseFloat(val); if (isNaN(val)) return;
            const infoEl = document.getElementById('dist-info');
            const selectedResults = currentRefResults.filter(r => r.isSelected);
            if (selectedResults.length === 0) { infoEl.innerHTML = "è©²å½“ã™ã‚‹å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"; return; }
            const range = 0.25;
            const hits = selectedResults.filter(r => r.task.computedSum >= (val - range) && r.task.computedSum < (val + range));
            if (hits.length > 0) {
                const count = hits.length;
                let names = hits.slice(0, 3).map(r => {
                    const parentStr = (r.parent && r.parent !== "-") ? r.parent + " > " : "";
                    return `${parentStr}${r.task.title}(${r.task.computedSum.toFixed(1)}h, ${r.task.progress}%)`;
                }).join(", ");
                if (hits.length > 3) names += `, ä»–${hits.length - 3}ä»¶`;
                infoEl.innerHTML = `<span class="dist-highlight">${val.toFixed(1)}h ä»˜è¿‘ã®å®Ÿç¸¾:</span> <b>${count}ä»¶</b> ï¼ˆ${names}ï¼‰`;
            } else { infoEl.innerHTML = `<span class="dist-highlight">${val.toFixed(1)}h ä»˜è¿‘ã®å®Ÿç¸¾:</span> ãªã—`; }
        }
        function applyRefAdjusted() {
            if(!currentRefTaskId) return;
            const val = parseFloat(document.getElementById('adjust-num').value); if(isNaN(val)) return;
            const t = tasks.find(x => x.id === currentRefTaskId); if(t) { t.est = val; render(); }
            closeRef();
        }
        function drawDistribution(data, maxRange, average) {
            const canvas = document.getElementById('dist-canvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.parentElement.offsetWidth; const h = canvas.parentElement.offsetHeight;
            canvas.width = w; canvas.height = h; ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "#eee"; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
            ctx.fillStyle = "#999"; ctx.font = "10px sans-serif"; ctx.fillText("0h", 2, h - 2); ctx.fillText(maxRange + "h", w - 25, h - 2);
            if (!data || data.length === 0) return;
            const binSize = 0.5; const bins = {}; let maxCount = 0;
            data.forEach(item => {
                const binKey = Math.floor(item.val / binSize) * binSize;
                bins[binKey] = (bins[binKey] || 0) + 1;
                if (bins[binKey] > maxCount) maxCount = bins[binKey];
            });
            ctx.fillStyle = "rgba(47, 85, 151, 0.6)"; 
            for (let b in bins) {
                const val = parseFloat(b); const count = bins[b];
                const x = (val / maxRange) * w; const barW = (binSize / maxRange) * w;
                const totalH = (count / maxCount) * (h - 8); const yBase = (h/2) + (totalH/2);
                ctx.fillRect(x, yBase - totalH, Math.max(barW - 1, 1), totalH);
            }
            if (average > 0) {
                const avgX = (average / maxRange) * w;
                ctx.beginPath(); ctx.strokeStyle = "rgba(255, 0, 0, 0.7)"; ctx.lineWidth = 2; ctx.setLineDash([3, 3]); 
                ctx.moveTo(avgX, 5); ctx.lineTo(avgX, h - 5); ctx.stroke(); ctx.setLineDash([]); 
            }
        }

        // --- è¿½åŠ : æ—¥å ±æ©Ÿèƒ½ ---
        function openReport() {
            document.getElementById('report-month').value = new Date().toISOString().slice(0, 7); // ä»Šæœˆ
            renderReportContent();
            document.getElementById('report-modal').style.display = 'flex';
        }
        
        function renderReportContent() {
            const ym = document.getElementById('report-month').value;
            if (!ym) return;
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = "";
            const dailyData = {};
            tasks.forEach(t => {
                if (t.isGroup) return;
                const owner = t.owner || "(æœªå‰²å½“)";
                Object.keys(t.hours).forEach(date => {
                    if (!date.startsWith(ym)) return; 
                    if (!dailyData[date]) dailyData[date] = {};
                    if (!dailyData[date][owner]) dailyData[date][owner] = { total: 0, taskDetails: [] };
                    const h = t.hours[date];
                    dailyData[date][owner].total += h;
                    dailyData[date][owner].taskDetails.push(`${t.title}(${h.toFixed(1)}h)`);
                });
            });
            const sortedDates = Object.keys(dailyData).sort();
            if (sortedDates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            sortedDates.forEach(date => {
                const dayData = dailyData[date];
                const owners = Object.keys(dayData).sort();
                owners.forEach(owner => {
                    const data = dayData[owner];
                    const isOver = data.total > 8; 
                    const tr = document.createElement('tr');
                    if (isOver) tr.className = 'report-over-limit';
                    tr.innerHTML = `<td>${date}</td><td>${owner}</td><td>${data.taskDetails.join(', ')}</td><td class="num-cell">${data.total.toFixed(1)}h</td>`;
                    tbody.appendChild(tr);
                });
            });
        }

        function copyReportToClipboard() {
            const tbody = document.getElementById('report-body');
            let text = "æ—¥ä»˜\tæ‹…å½“è€…\tã‚¿ã‚¹ã‚¯å†…è¨³\tåˆè¨ˆ(h)\n";
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                const cols = Array.from(tr.querySelectorAll('td')).map(td => td.innerText);
                if(cols.length > 1) text += cols.join('\t') + "\n";
            });
            navigator.clipboard.writeText(text).then(() => { alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); });
        }

        // --- ã‚¿ã‚¤ãƒãƒ¼ãƒ»ç·¨é›†æ©Ÿèƒ½ ---
        function startTracking(id) {
            if(trackingId) stopTracking();
            trackingId = id; trackingStartTime = new Date();
            const t = tasks.find(x => x.id === id);
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diffMs = new Date() - trackingStartTime;
                const h = Math.floor(diffMs / 3600000);
                const m = Math.floor((diffMs % 3600000) / 60000);
                const s = Math.floor((diffMs % 60000) / 1000);
                document.getElementById('tracker-status').innerText = `è¨ˆæ¸¬ä¸­ (${[h,m,s].map(v=>v.toString().padStart(2,'0')).join(':')}): ${t.title}`;
            }, 1000);
            render();
        }
        function stopTracking() {
            if(!trackingId) return;
            const diffH = (new Date() - trackingStartTime) / 3600000;
            const todayStr = getLocalDateStr();
            const t = tasks.find(x => x.id === trackingId);
            t.hours[todayStr] = parseFloat(((t.hours[todayStr] || 0) + diffH).toFixed(1));
            clearInterval(timerInterval); trackingId = null; trackingStartTime = null;
            document.getElementById('tracker-status').innerText = "";
            render();
        }

        function updHr(id, dt, v) { const t = tasks.find(x => x.id === id); if(t) { const nv = parseFloat(v); if (!v || isNaN(nv) || nv <= 0) delete t.hours[dt]; else t.hours[dt] = nv; render(); } }
        function toggleGrp(id) { const t = tasks.find(x => x.id === id); if(t) { t.isGroup = !t.isGroup; render(); } }
        function addTask() { 
            const today = getLocalDateStr(); 
            tasks.push({ id: Date.now(), title: 'æ–°ã‚¿ã‚¹ã‚¯', owner: '', start: today, end: today, est: 0.0, progress: 0, isGroup: false, hours: {}, memo: "" }); 
            render(); 
        }
        function delT(id) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { if(trackingId === id) stopTracking(); tasks = tasks.filter(x => x.id !== id); render(); } }
        function downloadJSON() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' })); a.download = `wbs_data.json`; a.click(); }
        function uploadJSON(e) { const reader = new FileReader(); reader.onload = (ev) => { tasks = JSON.parse(ev.target.result); render(); scrollToToday(); }; reader.readAsText(e.target.files[0]); }
        function scrollToToday() { const target = document.getElementById('today-target'); if (ganttContainer && target) ganttContainer.scrollLeft = target.offsetLeft - 100; }

        render();
        window.onload = () => setTimeout(scrollToToday, 200);
    </script>
</body>
</html>